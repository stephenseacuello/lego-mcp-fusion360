{% extends "base.html" %}

{% block title %}HOQ to Digital Twin Bridge{% endblock %}

{% block head %}
<style>
    .bridge-container {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        padding: 1rem;
    }

    /* Flow Visualization */
    .dt-bridge-flow {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
        border-radius: 12px;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .flow-node {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem;
        background: var(--bg-primary);
        border-radius: 8px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        min-width: 100px;
    }

    .flow-node:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .flow-node.active {
        border-color: var(--accent-color);
    }

    .flow-node.completed {
        border-color: #10b981;
    }

    .flow-node-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .flow-node-icon.hoq { background: #dbeafe; }
    .flow-node-icon.specs { background: #d1fae5; }
    .flow-node-icon.design { background: #fef3c7; }
    .flow-node-icon.validate { background: #fee2e2; }

    .flow-arrow {
        color: var(--text-secondary);
        font-size: 1.5rem;
    }

    /* Cards */
    .card {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 1.5rem;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .card-title {
        font-size: 1.125rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Input Section */
    .requirements-input {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .requirement-row {
        display: grid;
        grid-template-columns: 1fr auto auto auto;
        gap: 1rem;
        align-items: center;
        padding: 0.75rem;
        background: var(--bg-primary);
        border-radius: 8px;
    }

    .requirement-row input,
    .requirement-row select {
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .importance-slider {
        width: 100px;
    }

    /* Design Package Display */
    .design-package-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
    }

    .spec-card {
        background: var(--bg-primary);
        border-radius: 8px;
        padding: 1rem;
        border-left: 4px solid var(--accent-color);
    }

    .spec-card.critical { border-left-color: #ef4444; }
    .spec-card.major { border-left-color: #f59e0b; }
    .spec-card.minor { border-left-color: #3b82f6; }

    .spec-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .spec-name {
        font-weight: 600;
    }

    .severity-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        text-transform: uppercase;
    }

    .severity-badge.critical { background: #fee2e2; color: #991b1b; }
    .severity-badge.major { background: #fef3c7; color: #92400e; }
    .severity-badge.minor { background: #dbeafe; color: #1e40af; }

    .spec-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--accent-color);
    }

    .spec-tolerance {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    /* Validation Section */
    .validation-results {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .validation-summary {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .summary-stat {
        text-align: center;
        padding: 1rem;
        background: var(--bg-primary);
        border-radius: 8px;
    }

    .summary-stat-value {
        font-size: 2rem;
        font-weight: 700;
    }

    .summary-stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .summary-stat.pass .summary-stat-value { color: #10b981; }
    .summary-stat.fail .summary-stat-value { color: #ef4444; }

    .criterion-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr auto;
        gap: 1rem;
        padding: 0.75rem;
        background: var(--bg-primary);
        border-radius: 8px;
        align-items: center;
    }

    .criterion-row.pass { border-left: 3px solid #10b981; }
    .criterion-row.fail { border-left: 3px solid #ef4444; }
    .criterion-row.skip { border-left: 3px solid #9ca3af; }

    .status-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.75rem;
    }

    .status-icon.pass { background: #10b981; }
    .status-icon.fail { background: #ef4444; }
    .status-icon.skip { background: #9ca3af; }

    /* Traceability Matrix */
    .traceability-table {
        width: 100%;
        border-collapse: collapse;
    }

    .traceability-table th,
    .traceability-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .traceability-table th {
        background: var(--bg-primary);
        font-weight: 600;
    }

    .trace-link {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        background: var(--bg-secondary);
        border-radius: 4px;
        font-size: 0.75rem;
        margin: 0.125rem;
    }

    /* Test Cases */
    .test-case-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .test-case-item {
        display: grid;
        grid-template-columns: auto 1fr auto auto;
        gap: 1rem;
        padding: 0.75rem;
        background: var(--bg-primary);
        border-radius: 8px;
        align-items: center;
    }

    .test-type-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }

    .test-type-badge.boundary { background: #fef3c7; color: #92400e; }
    .test-type-badge.nominal { background: #d1fae5; color: #065f46; }
    .test-type-badge.stress { background: #fee2e2; color: #991b1b; }
    .test-type-badge.interaction { background: #e0e7ff; color: #3730a3; }

    /* Recommendations */
    .recommendations-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .recommendation-card {
        background: var(--bg-primary);
        border-radius: 8px;
        padding: 1rem;
        border-left: 4px solid var(--accent-color);
    }

    .recommendation-card.high { border-left-color: #ef4444; }
    .recommendation-card.medium { border-left-color: #f59e0b; }
    .recommendation-card.low { border-left-color: #10b981; }

    .recommendation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .recommendation-type {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
    }

    .recommendation-type-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .recommendation-type-icon.priority_specs { background: #fee2e2; }
    .recommendation-type-icon.conflicts { background: #fef3c7; }
    .recommendation-type-icon.test_coverage { background: #dbeafe; }

    .priority-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        text-transform: uppercase;
        font-weight: 600;
    }

    .priority-badge.high { background: #fee2e2; color: #991b1b; }
    .priority-badge.medium { background: #fef3c7; color: #92400e; }
    .priority-badge.low { background: #d1fae5; color: #065f46; }

    .recommendation-description {
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
    }

    .recommendation-action {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--bg-secondary);
        border-radius: 6px;
        font-size: 0.875rem;
    }

    .recommendation-action-icon {
        color: var(--accent-color);
    }

    .recommendations-summary {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .rec-stat {
        text-align: center;
        padding: 1rem;
        background: var(--bg-primary);
        border-radius: 8px;
    }

    .rec-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .rec-stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .rec-stat.high .rec-stat-value { color: #ef4444; }
    .rec-stat.medium .rec-stat-value { color: #f59e0b; }
    .rec-stat.low .rec-stat-value { color: #10b981; }

    /* Comparison Section */
    .comparison-container {
        display: none;
        margin-top: 1rem;
    }

    .comparison-container.active {
        display: block;
    }

    .comparison-grid {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 1rem;
        align-items: start;
    }

    .comparison-panel {
        background: var(--bg-primary);
        border-radius: 8px;
        padding: 1rem;
    }

    .comparison-diff {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem;
    }

    .diff-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
    }

    .diff-indicator.added { background: #d1fae5; color: #065f46; }
    .diff-indicator.removed { background: #fee2e2; color: #991b1b; }
    .diff-indicator.changed { background: #fef3c7; color: #92400e; }

    /* Export Dropdown */
    .export-dropdown {
        position: relative;
        display: inline-block;
    }

    .export-menu {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.5rem;
        min-width: 180px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 100;
    }

    .export-dropdown:hover .export-menu {
        display: block;
    }

    .export-menu-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 4px;
        cursor: pointer;
        color: var(--text-primary);
        text-decoration: none;
    }

    .export-menu-item:hover {
        background: var(--bg-secondary);
    }

    /* Buttons */
    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background: var(--accent-color);
        color: white;
    }

    .btn-primary:hover {
        opacity: 0.9;
    }

    .btn-secondary {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-group {
        display: flex;
        gap: 0.5rem;
    }

    /* Tabs */
    .tabs {
        display: flex;
        gap: 0.5rem;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 1rem;
    }

    .tab {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        color: var(--text-secondary);
        transition: all 0.2s ease;
    }

    .tab:hover {
        color: var(--text-primary);
    }

    .tab.active {
        color: var(--accent-color);
        border-bottom-color: var(--accent-color);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Loading State */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: var(--text-secondary);
    }

    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid var(--border-color);
        border-top-color: var(--accent-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <header class="page-header">
        <h1>HOQ to Digital Twin Bridge</h1>
        <p>Transform Quality Requirements into Digital Twin Design Specifications</p>
    </header>

    <!-- Flow Visualization -->
    <div class="dt-bridge-flow">
        <div class="flow-node" id="flow-hoq">
            <div class="flow-node-icon hoq">üìã</div>
            <span>House of Quality</span>
        </div>
        <span class="flow-arrow">‚Üí</span>
        <div class="flow-node" id="flow-specs">
            <div class="flow-node-icon specs">üìê</div>
            <span>Specifications</span>
        </div>
        <span class="flow-arrow">‚Üí</span>
        <div class="flow-node" id="flow-design">
            <div class="flow-node-icon design">üîß</div>
            <span>DT Design</span>
        </div>
        <span class="flow-arrow">‚Üí</span>
        <div class="flow-node" id="flow-validate">
            <div class="flow-node-icon validate">‚úì</div>
            <span>Validation</span>
        </div>
    </div>

    <div class="bridge-container">
        <!-- Customer Requirements Input -->
        <div class="card" id="requirements-section">
            <div class="card-header">
                <h2 class="card-title">
                    <span>üìù</span> Customer Requirements
                </h2>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="loadLegoTemplate()">Load LEGO Template</button>
                    <button class="btn btn-primary" onclick="addRequirement()">+ Add Requirement</button>
                </div>
            </div>
            <div class="requirements-input" id="requirements-list">
                <div class="requirement-row">
                    <input type="text" placeholder="Requirement description..." value="Bricks connect firmly with official LEGO">
                    <input type="number" min="1" max="10" value="9" class="importance-slider" title="Importance">
                    <select>
                        <option value="must_be">Must-Be</option>
                        <option value="one_dimensional" selected>One-Dimensional</option>
                        <option value="attractive">Attractive</option>
                    </select>
                    <button class="btn btn-secondary" onclick="removeRequirement(this)">√ó</button>
                </div>
                <div class="requirement-row">
                    <input type="text" placeholder="Requirement description..." value="Easy to separate by hand">
                    <input type="number" min="1" max="10" value="8" class="importance-slider">
                    <select>
                        <option value="must_be">Must-Be</option>
                        <option value="one_dimensional" selected>One-Dimensional</option>
                        <option value="attractive">Attractive</option>
                    </select>
                    <button class="btn btn-secondary" onclick="removeRequirement(this)">√ó</button>
                </div>
                <div class="requirement-row">
                    <input type="text" placeholder="Requirement description..." value="Accurate color matching">
                    <input type="number" min="1" max="10" value="7" class="importance-slider">
                    <select>
                        <option value="must_be">Must-Be</option>
                        <option value="one_dimensional" selected>One-Dimensional</option>
                        <option value="attractive">Attractive</option>
                    </select>
                    <button class="btn btn-secondary" onclick="removeRequirement(this)">√ó</button>
                </div>
                <div class="requirement-row">
                    <input type="text" placeholder="Requirement description..." value="Smooth surface finish">
                    <input type="number" min="1" max="10" value="6" class="importance-slider">
                    <select>
                        <option value="must_be">Must-Be</option>
                        <option value="one_dimensional">One-Dimensional</option>
                        <option value="attractive" selected>Attractive</option>
                    </select>
                    <button class="btn btn-secondary" onclick="removeRequirement(this)">√ó</button>
                </div>
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button class="btn btn-success" onclick="generateDesignPackage()">
                    Generate Design Package ‚Üí
                </button>
                <label>
                    <input type="checkbox" id="include-cascade" checked> Include 4-Phase QFD Cascade
                </label>
            </div>
        </div>

        <!-- Design Package Results -->
        <div class="card" id="package-section" style="display: none;">
            <div class="card-header">
                <h2 class="card-title">
                    <span>üì¶</span> Digital Twin Design Package
                </h2>
                <div class="btn-group">
                    <div class="export-dropdown">
                        <button class="btn btn-secondary">Export ‚ñæ</button>
                        <div class="export-menu">
                            <a class="export-menu-item" onclick="exportPackage('json')">
                                <span>üìÑ</span> JSON (Full)
                            </a>
                            <a class="export-menu-item" onclick="exportPackage('csv')">
                                <span>üìä</span> CSV (Specs)
                            </a>
                            <a class="export-menu-item" onclick="exportPackage('summary')">
                                <span>üìã</span> Summary Report
                            </a>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="showSummary()">View Summary</button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('specs')">Design Specs</div>
                <div class="tab" onclick="switchTab('validation')">Validation Criteria</div>
                <div class="tab" onclick="switchTab('tests')">Test Cases</div>
                <div class="tab" onclick="switchTab('traceability')">Traceability</div>
                <div class="tab" onclick="switchTab('recommendations')">Recommendations</div>
            </div>

            <!-- Design Specs Tab -->
            <div class="tab-content active" id="tab-specs">
                <div class="design-package-grid" id="specs-grid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Validation Criteria Tab -->
            <div class="tab-content" id="tab-validation">
                <div id="validation-criteria-list">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Test Cases Tab -->
            <div class="tab-content" id="tab-tests">
                <div class="test-case-list" id="test-cases-list">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Traceability Tab -->
            <div class="tab-content" id="tab-traceability">
                <table class="traceability-table" id="traceability-table">
                    <thead>
                        <tr>
                            <th>Customer Requirement</th>
                            <th>Design Specs</th>
                            <th>Validation Criteria</th>
                            <th>Test Cases</th>
                        </tr>
                    </thead>
                    <tbody id="traceability-body">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Recommendations Tab -->
            <div class="tab-content" id="tab-recommendations">
                <div class="recommendations-summary" id="rec-summary">
                    <div class="rec-stat high">
                        <div class="rec-stat-value" id="rec-high">0</div>
                        <div class="rec-stat-label">High Priority</div>
                    </div>
                    <div class="rec-stat medium">
                        <div class="rec-stat-value" id="rec-medium">0</div>
                        <div class="rec-stat-label">Medium Priority</div>
                    </div>
                    <div class="rec-stat low">
                        <div class="rec-stat-value" id="rec-low">0</div>
                        <div class="rec-stat-label">Low Priority</div>
                    </div>
                </div>
                <div class="recommendations-container" id="recommendations-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading recommendations...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Package Summary Modal -->
        <div class="card" id="summary-section" style="display: none;">
            <div class="card-header">
                <h2 class="card-title">
                    <span>üìä</span> Package Summary
                </h2>
                <button class="btn btn-secondary" onclick="closeSummary()">Close</button>
            </div>
            <div id="summary-content">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Validation Runner -->
        <div class="card" id="validation-section" style="display: none;">
            <div class="card-header">
                <h2 class="card-title">
                    <span>‚úì</span> Digital Twin Validation
                </h2>
                <button class="btn btn-success" onclick="runValidation()">Run Validation</button>
            </div>

            <div class="validation-summary" id="validation-summary">
                <div class="summary-stat">
                    <div class="summary-stat-value" id="stat-total">0</div>
                    <div class="summary-stat-label">Total Criteria</div>
                </div>
                <div class="summary-stat pass">
                    <div class="summary-stat-value" id="stat-passed">0</div>
                    <div class="summary-stat-label">Passed</div>
                </div>
                <div class="summary-stat fail">
                    <div class="summary-stat-value" id="stat-failed">0</div>
                    <div class="summary-stat-label">Failed</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="stat-rate">0%</div>
                    <div class="summary-stat-label">Pass Rate</div>
                </div>
            </div>

            <h4>Enter Actual Values</h4>
            <div id="actual-values-form">
                <!-- Populated by JavaScript -->
            </div>

            <div class="validation-results" id="validation-results" style="margin-top: 1rem;">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
let currentPackage = null;
let currentHoqId = 'demo-' + Date.now();

function addRequirement() {
    const list = document.getElementById('requirements-list');
    const row = document.createElement('div');
    row.className = 'requirement-row';
    row.innerHTML = `
        <input type="text" placeholder="Requirement description...">
        <input type="number" min="1" max="10" value="5" class="importance-slider">
        <select>
            <option value="must_be">Must-Be</option>
            <option value="one_dimensional" selected>One-Dimensional</option>
            <option value="attractive">Attractive</option>
        </select>
        <button class="btn btn-secondary" onclick="removeRequirement(this)">√ó</button>
    `;
    list.appendChild(row);
}

function removeRequirement(btn) {
    btn.closest('.requirement-row').remove();
}

function loadLegoTemplate() {
    const list = document.getElementById('requirements-list');
    list.innerHTML = '';

    const legoReqs = [
        { text: 'Compatible with official LEGO bricks', importance: 10, kano: 'must_be' },
        { text: 'Bricks connect firmly', importance: 9, kano: 'must_be' },
        { text: 'Easy to separate by hand', importance: 8, kano: 'one_dimensional' },
        { text: 'Accurate color matching', importance: 7, kano: 'one_dimensional' },
        { text: 'Smooth surface finish', importance: 6, kano: 'attractive' },
        { text: 'Consistent clutch force', importance: 9, kano: 'must_be' },
        { text: 'Dimensional accuracy', importance: 10, kano: 'must_be' },
    ];

    legoReqs.forEach(req => {
        const row = document.createElement('div');
        row.className = 'requirement-row';
        row.innerHTML = `
            <input type="text" value="${req.text}">
            <input type="number" min="1" max="10" value="${req.importance}" class="importance-slider">
            <select>
                <option value="must_be" ${req.kano === 'must_be' ? 'selected' : ''}>Must-Be</option>
                <option value="one_dimensional" ${req.kano === 'one_dimensional' ? 'selected' : ''}>One-Dimensional</option>
                <option value="attractive" ${req.kano === 'attractive' ? 'selected' : ''}>Attractive</option>
            </select>
            <button class="btn btn-secondary" onclick="removeRequirement(this)">√ó</button>
        `;
        list.appendChild(row);
    });
}

function collectRequirements() {
    const rows = document.querySelectorAll('.requirement-row');
    const requirements = [];

    rows.forEach((row, i) => {
        const text = row.querySelector('input[type="text"]').value;
        const importance = row.querySelector('input[type="number"]').value;
        const kano = row.querySelector('select').value;

        if (text) {
            requirements.push({
                id: `CR_${i + 1}`,
                description: text,
                importance: parseInt(importance),
                kano_type: kano
            });
        }
    });

    return requirements;
}

async function generateDesignPackage() {
    const requirements = collectRequirements();
    if (requirements.length === 0) {
        alert('Please add at least one requirement');
        return;
    }

    const includeCascade = document.getElementById('include-cascade').checked;

    // Update flow visualization
    document.getElementById('flow-hoq').classList.add('active');

    try {
        const response = await fetch(`/qfd/${currentHoqId}/design-package`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                customer_requirements: requirements,
                include_tests: true,
                include_cascade: includeCascade
            })
        });

        const data = await response.json();

        if (data.success) {
            currentPackage = data.package;
            displayDesignPackage(data.package);

            // Update flow
            document.getElementById('flow-hoq').classList.add('completed');
            document.getElementById('flow-specs').classList.add('completed');
            document.getElementById('flow-design').classList.add('active');

            // Show sections
            document.getElementById('package-section').style.display = 'block';
            document.getElementById('validation-section').style.display = 'block';
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to generate design package: ' + error.message);
    }
}

function displayDesignPackage(pkg) {
    // Display specs
    const specsGrid = document.getElementById('specs-grid');
    specsGrid.innerHTML = pkg.design_specs.map(spec => `
        <div class="spec-card ${spec.validation_severity}">
            <div class="spec-header">
                <span class="spec-name">${spec.name}</span>
                <span class="severity-badge ${spec.validation_severity}">${spec.validation_severity}</span>
            </div>
            <div class="spec-value">${spec.target_value} ${spec.unit}</div>
            <div class="spec-tolerance">Tolerance: ${spec.tolerance_lower.toFixed(4)} to ${spec.tolerance_upper.toFixed(4)}</div>
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                Type: ${spec.parameter_type} | Priority: ${(spec.priority * 100).toFixed(0)}%
            </div>
        </div>
    `).join('');

    // Display validation criteria
    const criteriaList = document.getElementById('validation-criteria-list');
    criteriaList.innerHTML = pkg.validation_criteria.map(c => `
        <div class="criterion-row">
            <div>
                <strong>${c.name}</strong>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">${c.description}</div>
            </div>
            <div>${c.check_type}</div>
            <div>${c.target_value} ${c.unit}</div>
            <span class="severity-badge ${c.severity}">${c.severity}</span>
        </div>
    `).join('');

    // Display test cases
    const testsList = document.getElementById('test-cases-list');
    testsList.innerHTML = pkg.test_cases.map(t => `
        <div class="test-case-item">
            <span class="test-type-badge ${t.test_type}">${t.test_type}</span>
            <div>
                <strong>${t.name}</strong>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">${t.description}</div>
            </div>
            <div style="font-size: 0.875rem;">
                ${t.input_parameters.length} inputs
            </div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                ${t.validation_criteria_ids.length} criteria
            </div>
        </div>
    `).join('');

    // Populate actual values form
    const form = document.getElementById('actual-values-form');
    form.innerHTML = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">` +
        pkg.design_specs.map(spec => `
            <div>
                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem;">${spec.name} (${spec.unit})</label>
                <input type="number" step="0.001" id="val-${spec.spec_id}"
                       value="${spec.target_value}"
                       style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
            </div>
        `).join('') + '</div>';

    // Load traceability and recommendations
    loadTraceability();
    loadRecommendations();
}

async function loadTraceability() {
    try {
        const response = await fetch(`/qfd/${currentHoqId}/traceability?format=list`);
        const data = await response.json();

        const tbody = document.getElementById('traceability-body');
        const rows = {};

        data.traceability.forEach(trace => {
            if (!rows[trace.customer_requirement]) {
                rows[trace.customer_requirement] = {
                    specs: [],
                    criteria: [],
                    tests: []
                };
            }
            rows[trace.customer_requirement].specs.push(trace.spec);
            rows[trace.customer_requirement].criteria.push(...trace.validation_criteria);
            rows[trace.customer_requirement].tests.push(...trace.test_cases);
        });

        tbody.innerHTML = Object.entries(rows).map(([crId, data]) => `
            <tr>
                <td><strong>${crId}</strong></td>
                <td>${data.specs.map(s => `<span class="trace-link">${s.name}</span>`).join('')}</td>
                <td>${data.criteria.map(c => `<span class="trace-link">${c.name}</span>`).join('')}</td>
                <td>${data.tests.map(t => `<span class="trace-link">${t.name}</span>`).join('')}</td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading traceability:', error);
    }
}

async function runValidation() {
    if (!currentPackage) {
        alert('Generate a design package first');
        return;
    }

    // Collect actual values
    const actualValues = {};
    currentPackage.design_specs.forEach(spec => {
        const input = document.getElementById(`val-${spec.spec_id}`);
        if (input) {
            actualValues[spec.spec_id] = parseFloat(input.value);
        }
    });

    try {
        const response = await fetch(`/qfd/${currentHoqId}/validate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ actual_values: actualValues })
        });

        const data = await response.json();

        // Update summary
        document.getElementById('stat-total').textContent = data.summary.total_criteria;
        document.getElementById('stat-passed').textContent = data.summary.passed;
        document.getElementById('stat-failed').textContent = data.summary.failed;
        document.getElementById('stat-rate').textContent = data.summary.pass_rate.toFixed(0) + '%';

        // Display results
        const results = document.getElementById('validation-results');
        results.innerHTML = '<h4>Validation Results</h4>' +
            data.validation_results.details.map(d => `
                <div class="criterion-row ${d.status}">
                    <div><strong>${d.criterion_id}</strong></div>
                    <div>Expected: ${d.expected}</div>
                    <div>Actual: ${d.actual !== undefined ? d.actual : 'N/A'}</div>
                    <div>${d.message}</div>
                    <div class="status-icon ${d.status}">${d.status === 'pass' ? '‚úì' : d.status === 'fail' ? '‚úó' : '‚Äî'}</div>
                </div>
            `).join('');

        // Update flow
        document.getElementById('flow-design').classList.add('completed');
        document.getElementById('flow-validate').classList.add(data.overall_pass ? 'completed' : 'active');

    } catch (error) {
        console.error('Error:', error);
        alert('Validation failed: ' + error.message);
    }
}

function switchTab(tabId) {
    // Update tab buttons
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');

    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
}

async function exportPackage(format) {
    if (!currentPackage) {
        alert('Generate a design package first');
        return;
    }

    try {
        const response = await fetch(`/qfd/${currentHoqId}/export?format=${format}`);

        if (format === 'json') {
            const data = await response.json();
            const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `design_package_${currentHoqId}.json`;
            a.click();
            URL.revokeObjectURL(url);
        } else if (format === 'csv') {
            const data = await response.json();
            const blob = new Blob([data.data], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `design_specs_${currentHoqId}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        } else if (format === 'summary') {
            const data = await response.json();
            displaySummaryReport(data.data);
        }
    } catch (error) {
        console.error('Export error:', error);
        // Fallback to client-side export
        if (format === 'json') {
            const blob = new Blob([JSON.stringify(currentPackage, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `design_package_${currentHoqId}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    }
}

async function loadRecommendations() {
    const container = document.getElementById('recommendations-list');

    try {
        const response = await fetch(`/qfd/${currentHoqId}/recommendations`);
        const data = await response.json();

        if (data.success && data.recommendations) {
            displayRecommendations(data.recommendations);
        } else {
            container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No recommendations available.</p>';
        }
    } catch (error) {
        console.error('Error loading recommendations:', error);
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Failed to load recommendations.</p>';
    }
}

function displayRecommendations(recommendations) {
    const container = document.getElementById('recommendations-list');

    // Count by priority
    const counts = { high: 0, medium: 0, low: 0 };
    recommendations.forEach(rec => {
        counts[rec.priority] = (counts[rec.priority] || 0) + 1;
    });

    document.getElementById('rec-high').textContent = counts.high;
    document.getElementById('rec-medium').textContent = counts.medium;
    document.getElementById('rec-low').textContent = counts.low;

    if (recommendations.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                <p>No recommendations - your design package looks good!</p>
            </div>
        `;
        return;
    }

    const typeIcons = {
        priority_specs: '‚ö†Ô∏è',
        conflicts: '‚ö°',
        test_coverage: 'üß™',
        optimization: 'üîß',
        compliance: 'üìã'
    };

    const typeLabels = {
        priority_specs: 'High Priority Specification',
        conflicts: 'Potential Conflict',
        test_coverage: 'Test Coverage Gap',
        optimization: 'Optimization Opportunity',
        compliance: 'Compliance Check'
    };

    container.innerHTML = recommendations.map(rec => `
        <div class="recommendation-card ${rec.priority}">
            <div class="recommendation-header">
                <div class="recommendation-type">
                    <div class="recommendation-type-icon ${rec.type}">
                        ${typeIcons[rec.type] || 'üí°'}
                    </div>
                    <span>${typeLabels[rec.type] || rec.type}</span>
                </div>
                <span class="priority-badge ${rec.priority}">${rec.priority}</span>
            </div>
            <div class="recommendation-description">${rec.description}</div>
            <div class="recommendation-action">
                <span class="recommendation-action-icon">‚Üí</span>
                <span>${rec.action}</span>
            </div>
        </div>
    `).join('');
}

async function showSummary() {
    try {
        const response = await fetch(`/qfd/${currentHoqId}/summary`);
        const data = await response.json();

        if (data.success) {
            displaySummaryReport(data.summary);
            document.getElementById('summary-section').style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading summary:', error);
    }
}

function displaySummaryReport(summary) {
    const content = document.getElementById('summary-content');

    content.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div class="summary-stat">
                <div class="summary-stat-value">${summary.total_specs || 0}</div>
                <div class="summary-stat-label">Design Specs</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value">${summary.total_criteria || 0}</div>
                <div class="summary-stat-label">Validation Criteria</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value">${summary.total_tests || 0}</div>
                <div class="summary-stat-label">Test Cases</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value">${summary.requirements_count || 0}</div>
                <div class="summary-stat-label">Requirements</div>
            </div>
        </div>

        ${summary.severity_breakdown ? `
        <h4>Severity Breakdown</h4>
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
            <div style="flex: 1; background: #fee2e2; padding: 0.75rem; border-radius: 8px; text-align: center;">
                <strong style="color: #991b1b;">${summary.severity_breakdown.critical || 0}</strong>
                <div style="font-size: 0.75rem; color: #991b1b;">Critical</div>
            </div>
            <div style="flex: 1; background: #fef3c7; padding: 0.75rem; border-radius: 8px; text-align: center;">
                <strong style="color: #92400e;">${summary.severity_breakdown.major || 0}</strong>
                <div style="font-size: 0.75rem; color: #92400e;">Major</div>
            </div>
            <div style="flex: 1; background: #dbeafe; padding: 0.75rem; border-radius: 8px; text-align: center;">
                <strong style="color: #1e40af;">${summary.severity_breakdown.minor || 0}</strong>
                <div style="font-size: 0.75rem; color: #1e40af;">Minor</div>
            </div>
        </div>
        ` : ''}

        ${summary.parameter_types ? `
        <h4>Parameter Types</h4>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem;">
            ${Object.entries(summary.parameter_types).map(([type, count]) => `
                <span style="padding: 0.5rem 1rem; background: var(--bg-primary); border-radius: 20px; font-size: 0.875rem;">
                    ${type}: <strong>${count}</strong>
                </span>
            `).join('')}
        </div>
        ` : ''}

        ${summary.test_type_breakdown ? `
        <h4>Test Coverage</h4>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            ${Object.entries(summary.test_type_breakdown).map(([type, count]) => `
                <span class="test-type-badge ${type}">${type}: ${count}</span>
            `).join('')}
        </div>
        ` : ''}
    `;

    document.getElementById('summary-section').style.display = 'block';
}

function closeSummary() {
    document.getElementById('summary-section').style.display = 'none';
}
</script>
{% endblock %}
