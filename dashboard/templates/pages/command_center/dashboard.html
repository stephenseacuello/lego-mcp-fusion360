{% extends "base.html" %}

{% block title %}Command Center - LEGO MCP v8{% endblock %}

{% block content %}
<div class="command-center">
    <!-- Header with System Status -->
    <header class="cc-header">
        <div class="cc-title">
            <h1>Command Center</h1>
            <span class="version-badge">v8.0</span>
        </div>
        <div class="system-status" id="system-status">
            <span class="status-indicator loading"></span>
            <span class="status-text">Checking system status...</span>
        </div>
        <div class="header-actions">
            <button class="btn-refresh" onclick="refreshAll()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/>
                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                Refresh
            </button>
            <span class="last-update" id="last-update">Last update: --</span>
        </div>
    </header>

    <!-- Main Grid Layout -->
    <div class="cc-grid">
        <!-- KPI Overview Panel -->
        <section class="cc-panel kpi-panel">
            <div class="panel-header">
                <h2>Key Performance Indicators</h2>
                <div class="panel-controls">
                    <select id="kpi-period" onchange="updateKPIs()">
                        <option value="realtime">Real-time</option>
                        <option value="hourly">Hourly</option>
                        <option value="daily">Daily</option>
                    </select>
                </div>
            </div>
            <div class="kpi-grid" id="kpi-grid">
                <div class="kpi-card" data-kpi="oee">
                    <div class="kpi-value">--</div>
                    <div class="kpi-label">OEE</div>
                    <div class="kpi-target">Target: 85%</div>
                    <div class="kpi-trend"></div>
                </div>
                <div class="kpi-card" data-kpi="fpy">
                    <div class="kpi-value">--</div>
                    <div class="kpi-label">First Pass Yield</div>
                    <div class="kpi-target">Target: 99%</div>
                    <div class="kpi-trend"></div>
                </div>
                <div class="kpi-card" data-kpi="throughput">
                    <div class="kpi-value">--</div>
                    <div class="kpi-label">Throughput</div>
                    <div class="kpi-unit">units/hr</div>
                    <div class="kpi-trend"></div>
                </div>
                <div class="kpi-card" data-kpi="on_time_delivery">
                    <div class="kpi-value">--</div>
                    <div class="kpi-label">On-Time Delivery</div>
                    <div class="kpi-target">Target: 98%</div>
                    <div class="kpi-trend"></div>
                </div>
            </div>
            <div class="kpi-score">
                <div class="score-circle" id="overall-score">
                    <svg viewBox="0 0 100 100">
                        <circle class="score-bg" cx="50" cy="50" r="45"/>
                        <circle class="score-fg" cx="50" cy="50" r="45" id="score-circle"/>
                    </svg>
                    <span class="score-value" id="score-value">--</span>
                </div>
                <div class="score-label">Overall Score</div>
            </div>
        </section>

        <!-- System Health Panel -->
        <section class="cc-panel health-panel">
            <div class="panel-header">
                <h2>System Health</h2>
                <span class="health-summary" id="health-summary">-- services</span>
            </div>
            <div class="health-grid" id="health-grid">
                <!-- Categories will be populated dynamically -->
            </div>
        </section>

        <!-- Alert Center Panel -->
        <section class="cc-panel alerts-panel">
            <div class="panel-header">
                <h2>Alert Center</h2>
                <a href="/command-center/alerts" class="view-all">View All</a>
            </div>
            <div class="alert-summary" id="alert-summary">
                <div class="alert-count critical">
                    <span class="count">0</span>
                    <span class="label">Critical</span>
                </div>
                <div class="alert-count high">
                    <span class="count">0</span>
                    <span class="label">High</span>
                </div>
                <div class="alert-count medium">
                    <span class="count">0</span>
                    <span class="label">Medium</span>
                </div>
                <div class="alert-count low">
                    <span class="count">0</span>
                    <span class="label">Low</span>
                </div>
            </div>
            <div class="alert-list" id="alert-list">
                <!-- Alerts will be populated dynamically -->
            </div>
        </section>

        <!-- Action Console Panel -->
        <section class="cc-panel actions-panel">
            <div class="panel-header">
                <h2>Action Console</h2>
                <a href="/command-center/actions" class="view-all">View All</a>
            </div>
            <div class="action-stats" id="action-stats">
                <div class="stat">
                    <span class="value" id="pending-count">0</span>
                    <span class="label">Pending</span>
                </div>
                <div class="stat">
                    <span class="value" id="executing-count">0</span>
                    <span class="label">Executing</span>
                </div>
                <div class="stat">
                    <span class="value" id="completed-today">0</span>
                    <span class="label">Completed Today</span>
                </div>
            </div>
            <div class="action-list" id="action-list">
                <!-- Actions will be populated dynamically -->
            </div>
        </section>

        <!-- Co-Simulation Panel -->
        <section class="cc-panel cosim-panel">
            <div class="panel-header">
                <h2>Co-Simulation</h2>
                <a href="/command-center/cosim" class="view-all">Open Simulator</a>
            </div>
            <div class="cosim-controls">
                <button class="btn-primary" onclick="runQuickSim()">
                    Run What-If Analysis
                </button>
                <button class="btn-secondary" onclick="viewScenarios()">
                    View Scenarios
                </button>
            </div>
            <div class="cosim-status" id="cosim-status">
                <div class="running-sims">
                    <span class="count" id="running-sim-count">0</span>
                    <span class="label">Running Simulations</span>
                </div>
            </div>
            <div class="cosim-quick-results" id="cosim-results">
                <!-- Quick simulation results -->
            </div>
        </section>

        <!-- Quick Navigation Panel -->
        <section class="cc-panel nav-panel">
            <div class="panel-header">
                <h2>Quick Navigation</h2>
            </div>
            <div class="nav-grid">
                <a href="/manufacturing/shop-floor" class="nav-item">
                    <span class="nav-icon">üè≠</span>
                    <span class="nav-label">Shop Floor</span>
                </a>
                <a href="/quality/spc" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-label">SPC Charts</span>
                </a>
                <a href="/digital-twin" class="nav-item">
                    <span class="nav-icon">üîÑ</span>
                    <span class="nav-label">Digital Twin</span>
                </a>
                <a href="/scheduling" class="nav-item">
                    <span class="nav-icon">üìÖ</span>
                    <span class="nav-label">Scheduling</span>
                </a>
                <a href="/ai/copilot" class="nav-item">
                    <span class="nav-icon">ü§ñ</span>
                    <span class="nav-label">AI Copilot</span>
                </a>
                <a href="/erp/orders" class="nav-item">
                    <span class="nav-icon">üì¶</span>
                    <span class="nav-label">Orders</span>
                </a>
            </div>
        </section>
    </div>
</div>

<style>
.command-center {
    padding: 1rem;
    background: var(--bg-primary, #0f172a);
    min-height: 100vh;
    color: var(--text-primary, #e2e8f0);
}

.cc-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: var(--bg-secondary, #1e293b);
    border-radius: 0.5rem;
}

.cc-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.cc-title h1 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
}

.version-badge {
    background: var(--accent, #3b82f6);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
}

.system-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #6b7280;
}

.status-indicator.healthy { background: #22c55e; }
.status-indicator.degraded { background: #f59e0b; }
.status-indicator.unhealthy { background: #ef4444; }
.status-indicator.loading {
    background: #6b7280;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.btn-refresh {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--bg-tertiary, #334155);
    border: none;
    border-radius: 0.375rem;
    color: var(--text-primary, #e2e8f0);
    cursor: pointer;
    transition: background 0.2s;
}

.btn-refresh:hover {
    background: var(--bg-hover, #475569);
}

.last-update {
    font-size: 0.75rem;
    color: var(--text-secondary, #94a3b8);
}

.cc-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: auto auto;
    gap: 1rem;
}

.cc-panel {
    background: var(--bg-secondary, #1e293b);
    border-radius: 0.5rem;
    padding: 1rem;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border, #334155);
}

.panel-header h2 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
}

.view-all {
    font-size: 0.75rem;
    color: var(--accent, #3b82f6);
    text-decoration: none;
}

.view-all:hover {
    text-decoration: underline;
}

/* KPI Panel Styles */
.kpi-panel {
    grid-column: span 2;
}

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
}

.kpi-card {
    background: var(--bg-tertiary, #334155);
    border-radius: 0.375rem;
    padding: 1rem;
    text-align: center;
}

.kpi-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--accent, #3b82f6);
}

.kpi-label {
    font-size: 0.75rem;
    color: var(--text-secondary, #94a3b8);
    margin-top: 0.25rem;
}

.kpi-target {
    font-size: 0.625rem;
    color: var(--text-tertiary, #64748b);
    margin-top: 0.25rem;
}

.kpi-trend {
    margin-top: 0.5rem;
    font-size: 0.75rem;
}

.kpi-trend.up { color: #22c55e; }
.kpi-trend.down { color: #ef4444; }
.kpi-trend.stable { color: #6b7280; }

.kpi-score {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 1rem;
}

.score-circle {
    position: relative;
    width: 100px;
    height: 100px;
}

.score-circle svg {
    transform: rotate(-90deg);
}

.score-bg {
    fill: none;
    stroke: var(--bg-tertiary, #334155);
    stroke-width: 8;
}

.score-fg {
    fill: none;
    stroke: var(--accent, #3b82f6);
    stroke-width: 8;
    stroke-linecap: round;
    stroke-dasharray: 283;
    stroke-dashoffset: 283;
    transition: stroke-dashoffset 0.5s ease;
}

.score-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.25rem;
    font-weight: 700;
}

.score-label {
    margin-top: 0.5rem;
    font-size: 0.75rem;
    color: var(--text-secondary, #94a3b8);
}

/* Health Panel Styles */
.health-summary {
    font-size: 0.75rem;
    color: var(--text-secondary, #94a3b8);
}

.health-grid {
    display: grid;
    gap: 0.5rem;
}

.health-category {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: var(--bg-tertiary, #334155);
    border-radius: 0.25rem;
}

.health-category-name {
    font-size: 0.875rem;
}

.health-category-status {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.health-category-status.healthy { background: #22c55e; }
.health-category-status.degraded { background: #f59e0b; }
.health-category-status.unhealthy { background: #ef4444; }
.health-category-status.unknown { background: #6b7280; }

/* Alert Panel Styles */
.alert-summary {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.alert-count {
    text-align: center;
    padding: 0.5rem;
    border-radius: 0.25rem;
}

.alert-count.critical { background: rgba(239, 68, 68, 0.2); }
.alert-count.high { background: rgba(249, 115, 22, 0.2); }
.alert-count.medium { background: rgba(245, 158, 11, 0.2); }
.alert-count.low { background: rgba(34, 197, 94, 0.2); }

.alert-count .count {
    display: block;
    font-size: 1.25rem;
    font-weight: 700;
}

.alert-count .label {
    font-size: 0.625rem;
    color: var(--text-secondary, #94a3b8);
}

.alert-list {
    max-height: 200px;
    overflow-y: auto;
}

.alert-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: var(--bg-tertiary, #334155);
    border-radius: 0.25rem;
    margin-bottom: 0.5rem;
    font-size: 0.75rem;
}

.alert-severity {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.alert-severity.critical { background: #ef4444; }
.alert-severity.high { background: #f97316; }
.alert-severity.medium { background: #f59e0b; }
.alert-severity.low { background: #22c55e; }

/* Action Panel Styles */
.action-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.action-stats .stat {
    text-align: center;
    padding: 0.5rem;
    background: var(--bg-tertiary, #334155);
    border-radius: 0.25rem;
}

.action-stats .value {
    display: block;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--accent, #3b82f6);
}

.action-stats .label {
    font-size: 0.625rem;
    color: var(--text-secondary, #94a3b8);
}

.action-list {
    max-height: 200px;
    overflow-y: auto;
}

.action-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: var(--bg-tertiary, #334155);
    border-radius: 0.25rem;
    margin-bottom: 0.5rem;
    font-size: 0.75rem;
}

.action-item .action-title {
    flex: 1;
}

.action-item .action-buttons {
    display: flex;
    gap: 0.25rem;
}

.btn-approve, .btn-reject {
    padding: 0.25rem 0.5rem;
    border: none;
    border-radius: 0.25rem;
    cursor: pointer;
    font-size: 0.625rem;
}

.btn-approve {
    background: #22c55e;
    color: white;
}

.btn-reject {
    background: #ef4444;
    color: white;
}

/* Co-Simulation Panel Styles */
.cosim-controls {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.btn-primary, .btn-secondary {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    font-size: 0.75rem;
}

.btn-primary {
    background: var(--accent, #3b82f6);
    color: white;
}

.btn-secondary {
    background: var(--bg-tertiary, #334155);
    color: var(--text-primary, #e2e8f0);
}

.cosim-status {
    text-align: center;
    padding: 1rem;
}

.running-sims .count {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent, #3b82f6);
}

/* Navigation Panel Styles */
.nav-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.75rem;
    background: var(--bg-tertiary, #334155);
    border-radius: 0.375rem;
    text-decoration: none;
    color: var(--text-primary, #e2e8f0);
    transition: background 0.2s;
}

.nav-item:hover {
    background: var(--bg-hover, #475569);
}

.nav-icon {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
}

.nav-label {
    font-size: 0.625rem;
    text-align: center;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .cc-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .kpi-panel {
        grid-column: span 2;
    }

    .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .cc-grid {
        grid-template-columns: 1fr;
    }

    .kpi-panel {
        grid-column: span 1;
    }
}
</style>

<script>
// Command Center JavaScript
let refreshInterval;

document.addEventListener('DOMContentLoaded', function() {
    refreshAll();
    startAutoRefresh();
});

function startAutoRefresh() {
    refreshInterval = setInterval(refreshAll, 5000);
}

function refreshAll() {
    fetchSystemStatus();
    fetchKPIs();
    fetchAlerts();
    fetchActions();
    updateLastUpdate();
}

async function fetchSystemStatus() {
    try {
        const response = await fetch('/command-center/api/status');
        const data = await response.json();

        if (data.success) {
            updateSystemStatus(data.data);
        }
    } catch (error) {
        console.error('Failed to fetch system status:', error);
    }
}

function updateSystemStatus(status) {
    const indicator = document.querySelector('.status-indicator');
    const statusText = document.querySelector('.status-text');

    indicator.className = 'status-indicator ' + status.overall_status;
    statusText.textContent = `${status.healthy_count}/${status.total_services} services healthy`;

    // Update health grid
    const healthGrid = document.getElementById('health-grid');
    healthGrid.innerHTML = '';

    for (const [category, categoryStatus] of Object.entries(status.categories || {})) {
        const div = document.createElement('div');
        div.className = 'health-category';
        div.innerHTML = `
            <span class="health-category-name">${formatCategoryName(category)}</span>
            <span class="health-category-status ${categoryStatus}"></span>
        `;
        healthGrid.appendChild(div);
    }

    document.getElementById('health-summary').textContent =
        `${status.total_services} services`;
}

async function fetchKPIs() {
    try {
        const response = await fetch('/command-center/api/kpis');
        const data = await response.json();

        if (data.success) {
            updateKPIs(data.data);
        }
    } catch (error) {
        console.error('Failed to fetch KPIs:', error);
    }
}

function updateKPIs(dashboard) {
    // Update individual KPI cards
    for (const metric of dashboard.metrics || []) {
        const card = document.querySelector(`.kpi-card[data-kpi="${metric.name}"]`);
        if (card) {
            const valueEl = card.querySelector('.kpi-value');
            const trendEl = card.querySelector('.kpi-trend');

            valueEl.textContent = formatKPIValue(metric.value, metric.unit);

            if (metric.trend !== 'stable') {
                trendEl.className = 'kpi-trend ' + metric.trend;
                trendEl.textContent = `${metric.trend === 'up' ? '‚Üë' : '‚Üì'} ${Math.abs(metric.trend_percent).toFixed(1)}%`;
            }
        }
    }

    // Update overall score
    const score = dashboard.overall_score || 0;
    document.getElementById('score-value').textContent = score.toFixed(0);

    const scoreCircle = document.getElementById('score-circle');
    const circumference = 283;
    const offset = circumference - (score / 100 * circumference);
    scoreCircle.style.strokeDashoffset = offset;
}

async function fetchAlerts() {
    try {
        const response = await fetch('/command-center/api/alerts');
        const data = await response.json();

        if (data.success) {
            updateAlerts(data.data);
        }
    } catch (error) {
        console.error('Failed to fetch alerts:', error);
    }
}

function updateAlerts(alertData) {
    const summary = alertData.summary || {};
    const bySeverity = summary.by_severity || {};

    document.querySelector('.alert-count.critical .count').textContent = bySeverity.critical || 0;
    document.querySelector('.alert-count.high .count').textContent = bySeverity.high || 0;
    document.querySelector('.alert-count.medium .count').textContent = bySeverity.medium || 0;
    document.querySelector('.alert-count.low .count').textContent = bySeverity.low || 0;

    // Update alert list
    const alertList = document.getElementById('alert-list');
    alertList.innerHTML = '';

    for (const alert of (alertData.alerts || []).slice(0, 5)) {
        const div = document.createElement('div');
        div.className = 'alert-item';
        div.innerHTML = `
            <span class="alert-severity ${alert.severity}"></span>
            <span class="alert-message">${alert.title}</span>
        `;
        alertList.appendChild(div);
    }
}

async function fetchActions() {
    try {
        const response = await fetch('/command-center/api/actions');
        const data = await response.json();

        if (data.success) {
            updateActions(data.data);
        }
    } catch (error) {
        console.error('Failed to fetch actions:', error);
    }
}

function updateActions(actionData) {
    const stats = actionData.stats || {};

    document.getElementById('pending-count').textContent = stats.pending_count || 0;
    document.getElementById('executing-count').textContent = stats.executing_count || 0;
    document.getElementById('completed-today').textContent = stats.completed_today || 0;

    // Update action list
    const actionList = document.getElementById('action-list');
    actionList.innerHTML = '';

    for (const action of (actionData.pending || []).slice(0, 5)) {
        const div = document.createElement('div');
        div.className = 'action-item';
        div.innerHTML = `
            <span class="action-title">${action.title}</span>
            <div class="action-buttons">
                <button class="btn-approve" onclick="approveAction('${action.id}')">Approve</button>
                <button class="btn-reject" onclick="rejectAction('${action.id}')">Reject</button>
            </div>
        `;
        actionList.appendChild(div);
    }
}

async function approveAction(actionId) {
    try {
        const response = await fetch(`/command-center/api/actions/${actionId}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user: 'operator' })
        });

        if (response.ok) {
            fetchActions();
        }
    } catch (error) {
        console.error('Failed to approve action:', error);
    }
}

async function rejectAction(actionId) {
    try {
        const response = await fetch(`/command-center/api/actions/${actionId}/reject`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user: 'operator', reason: 'Manual rejection' })
        });

        if (response.ok) {
            fetchActions();
        }
    } catch (error) {
        console.error('Failed to reject action:', error);
    }
}

function runQuickSim() {
    window.location.href = '/command-center/cosim';
}

function viewScenarios() {
    window.location.href = '/command-center/cosim?view=scenarios';
}

function updateLastUpdate() {
    const now = new Date();
    document.getElementById('last-update').textContent =
        `Last update: ${now.toLocaleTimeString()}`;
}

function formatCategoryName(name) {
    return name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatKPIValue(value, unit) {
    if (unit === '%') {
        return value.toFixed(1) + '%';
    } else if (unit === 'units/hr') {
        return value.toFixed(0);
    } else {
        return value.toFixed(2) + (unit ? ' ' + unit : '');
    }
}
</script>
{% endblock %}
