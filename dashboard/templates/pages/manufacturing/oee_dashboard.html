{% extends "base.html" %}

{% block title %}OEE Analytics - LegoMCP Manufacturing{% endblock %}

{% block extra_css %}
<style>
    .oee-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .header-title h1 {
        font-size: 1.75rem;
        margin: 0 0 0.25rem 0;
        color: var(--text-primary);
    }

    .header-subtitle {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .header-controls {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .date-range-picker {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.5rem 1rem;
    }

    .date-range-picker input {
        border: none;
        background: transparent;
        color: var(--text-primary);
        font-size: 0.875rem;
        width: 110px;
    }

    .date-range-picker span {
        color: var(--text-secondary);
    }

    /* Main OEE Gauge Section */
    .oee-main-section {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .oee-gauge-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
    }

    .oee-gauge-title {
        font-size: 1rem;
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .oee-gauge-container {
        position: relative;
        width: 220px;
        height: 220px;
        margin: 0 auto 1.5rem;
    }

    .oee-gauge-svg {
        transform: rotate(-90deg);
    }

    .oee-gauge-bg {
        fill: none;
        stroke: rgba(0, 0, 0, 0.1);
        stroke-width: 20;
    }

    .oee-gauge-fill {
        fill: none;
        stroke-width: 20;
        stroke-linecap: round;
        transition: stroke-dashoffset 1s ease-in-out;
    }

    .oee-gauge-fill.excellent { stroke: url(#gaugeGradientGreen); }
    .oee-gauge-fill.good { stroke: url(#gaugeGradientBlue); }
    .oee-gauge-fill.warning { stroke: url(#gaugeGradientYellow); }
    .oee-gauge-fill.critical { stroke: url(#gaugeGradientRed); }

    .oee-gauge-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .oee-gauge-number {
        font-size: 3rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .oee-gauge-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .oee-components {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 1rem;
    }

    .oee-component {
        text-align: center;
    }

    .oee-component-value {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .oee-component-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
    }

    /* Trend Chart */
    .trend-chart-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 1.5rem;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .chart-legend {
        display: flex;
        gap: 1rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .legend-dot.oee { background: #3b82f6; }
    .legend-dot.availability { background: #10b981; }
    .legend-dot.performance { background: #f59e0b; }
    .legend-dot.quality { background: #8b5cf6; }

    .chart-container {
        height: 250px;
        position: relative;
    }

    .chart-canvas {
        width: 100%;
        height: 100%;
    }

    /* Loss Analysis Section */
    .loss-section {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .loss-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
    }

    .loss-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .loss-title {
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .loss-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }

    .loss-icon.availability { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .loss-icon.performance { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
    .loss-icon.quality { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }

    .loss-total {
        text-align: right;
    }

    .loss-total-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .loss-total-label {
        font-size: 0.7rem;
        color: var(--text-secondary);
    }

    .loss-items {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .loss-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .loss-bar-container {
        flex: 1;
    }

    .loss-bar-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
    }

    .loss-bar-name {
        color: var(--text-primary);
    }

    .loss-bar-value {
        color: var(--text-secondary);
    }

    .loss-bar {
        height: 6px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 3px;
        overflow: hidden;
    }

    .loss-bar-fill {
        height: 100%;
        border-radius: 3px;
    }

    .loss-bar-fill.availability { background: #ef4444; }
    .loss-bar-fill.performance { background: #f59e0b; }
    .loss-bar-fill.quality { background: #8b5cf6; }

    /* Work Center Comparison */
    .comparison-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .comparison-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
    }

    .comparison-table {
        width: 100%;
        border-collapse: collapse;
    }

    .comparison-table th,
    .comparison-table td {
        padding: 0.75rem 0.5rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .comparison-table th {
        font-size: 0.7rem;
        text-transform: uppercase;
        color: var(--text-secondary);
        font-weight: 600;
    }

    .comparison-table td {
        font-size: 0.875rem;
        color: var(--text-primary);
    }

    .comparison-table tr:last-child td {
        border-bottom: none;
    }

    .wc-name-cell {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .wc-status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .wc-status-dot.excellent { background: #10b981; }
    .wc-status-dot.good { background: #3b82f6; }
    .wc-status-dot.warning { background: #f59e0b; }
    .wc-status-dot.critical { background: #ef4444; }

    .oee-mini-bar {
        width: 80px;
        height: 20px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }

    .oee-mini-fill {
        height: 100%;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 0.5rem;
        font-size: 0.65rem;
        color: white;
        font-weight: 600;
    }

    .oee-mini-fill.excellent { background: linear-gradient(90deg, #10b981, #34d399); }
    .oee-mini-fill.good { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
    .oee-mini-fill.warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .oee-mini-fill.critical { background: linear-gradient(90deg, #ef4444, #f87171); }

    /* Target Card */
    .target-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
    }

    .target-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .target-title {
        font-weight: 600;
        color: var(--text-primary);
    }

    .target-edit-btn {
        padding: 0.25rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: transparent;
        color: var(--text-secondary);
        font-size: 0.75rem;
        cursor: pointer;
    }

    .target-gauge {
        position: relative;
        height: 180px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .target-progress {
        width: 150px;
        height: 150px;
        position: relative;
    }

    .target-ring {
        transform: rotate(-90deg);
    }

    .target-ring-bg {
        fill: none;
        stroke: rgba(0, 0, 0, 0.1);
        stroke-width: 12;
    }

    .target-ring-fill {
        fill: none;
        stroke: #10b981;
        stroke-width: 12;
        stroke-linecap: round;
        transition: stroke-dashoffset 1s ease;
    }

    .target-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .target-percent {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .target-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .target-details {
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .target-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
    }

    .target-row-label {
        color: var(--text-secondary);
    }

    .target-row-value {
        color: var(--text-primary);
        font-weight: 500;
    }

    /* Shift Analysis */
    .shift-section {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
    }

    .shift-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .shift-title {
        font-weight: 600;
        color: var(--text-primary);
    }

    .shift-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    .shift-card {
        background: rgba(0, 0, 0, 0.03);
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
    }

    .shift-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .shift-time {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
    }

    .shift-oee {
        font-size: 2rem;
        font-weight: 700;
    }

    .shift-oee.excellent { color: #10b981; }
    .shift-oee.good { color: #3b82f6; }
    .shift-oee.warning { color: #f59e0b; }

    .shift-metrics {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 0.75rem;
        font-size: 0.7rem;
    }

    .shift-metric {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .shift-metric-value {
        font-weight: 600;
        color: var(--text-primary);
    }

    .shift-metric-label {
        color: var(--text-secondary);
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .oee-main-section {
            grid-template-columns: 1fr;
        }

        .loss-section {
            grid-template-columns: 1fr;
        }

        .comparison-section {
            grid-template-columns: 1fr;
        }

        .shift-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Modal Overlay */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .modal {
        background: var(--card-bg);
        border-radius: 16px;
        width: 90%;
        max-width: 700px;
        max-height: 85vh;
        overflow: hidden;
        transform: scale(0.9) translateY(20px);
        transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal {
        transform: scale(1) translateY(0);
    }

    .modal-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.25rem;
        color: var(--text-primary);
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        max-height: 60vh;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    /* Buttons */
    .btn {
        padding: 0.6rem 1.25rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
    }

    .btn-secondary {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    .btn-success {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .form-input, .form-select {
        width: 100%;
        padding: 0.6rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1100;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .toast {
        padding: 12px 20px;
        border-radius: 10px;
        color: white;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideInRight 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .toast.success { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .toast.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .toast.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }

    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* Export Modal Styles */
    .export-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .export-option {
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .export-option:hover {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.05);
    }

    .export-option.selected {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
    }

    .export-option-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .export-option-title {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .export-option-desc {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    /* Drill-down Detail Card */
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .detail-card {
        background: rgba(0, 0, 0, 0.03);
        border-radius: 12px;
        padding: 1rem;
    }

    .detail-card h4 {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin: 0 0 0.75rem 0;
        text-transform: uppercase;
    }

    .detail-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .detail-chart {
        height: 150px;
        margin-top: 1rem;
    }

    /* Quick Filters */
    .quick-filters {
        display: flex;
        gap: 0.5rem;
        margin-left: auto;
    }

    .quick-filter-btn {
        padding: 0.4rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        background: var(--card-bg);
        color: var(--text-secondary);
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .quick-filter-btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    /* Live Indicator */
    .live-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: rgba(34, 197, 94, 0.15);
        border-radius: 20px;
        font-size: 0.75rem;
        color: #22c55e;
        margin-left: 1rem;
    }

    .live-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #22c55e;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Comparison table clickable rows */
    .comparison-table tbody tr {
        cursor: pointer;
        transition: background 0.2s;
    }

    .comparison-table tbody tr:hover {
        background: rgba(59, 130, 246, 0.05);
    }

    /* Waterfall chart for loss analysis */
    .waterfall-container {
        height: 300px;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- SVG Gradient Definitions -->
<svg width="0" height="0" style="position: absolute;">
    <defs>
        <linearGradient id="gaugeGradientGreen" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#10b981"/>
            <stop offset="100%" style="stop-color:#34d399"/>
        </linearGradient>
        <linearGradient id="gaugeGradientBlue" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#3b82f6"/>
            <stop offset="100%" style="stop-color:#60a5fa"/>
        </linearGradient>
        <linearGradient id="gaugeGradientYellow" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#f59e0b"/>
            <stop offset="100%" style="stop-color:#fbbf24"/>
        </linearGradient>
        <linearGradient id="gaugeGradientRed" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#ef4444"/>
            <stop offset="100%" style="stop-color:#f87171"/>
        </linearGradient>
    </defs>
</svg>

<div class="oee-header">
    <div class="header-title">
        <h1>üìä OEE Analytics Dashboard</h1>
        <div class="header-subtitle">
            Overall Equipment Effectiveness ‚Ä¢ Real-time Analysis
            <span class="live-badge"><span class="live-dot"></span>Live Data</span>
        </div>
    </div>
    <div class="header-controls">
        <div class="quick-filters">
            <button class="quick-filter-btn active" onclick="setTimeRange('today')">Today</button>
            <button class="quick-filter-btn" onclick="setTimeRange('week')">This Week</button>
            <button class="quick-filter-btn" onclick="setTimeRange('month')">This Month</button>
        </div>
        <div class="date-range-picker">
            <input type="date" value="2024-01-15" id="startDate" onchange="applyDateFilter()">
            <span>to</span>
            <input type="date" value="2024-01-21" id="endDate" onchange="applyDateFilter()">
        </div>
        <select class="filter-dropdown" id="wcFilter" onchange="applyWorkCenterFilter(this.value)">
            <option value="all">All Work Centers</option>
            <option value="printers">3D Printers</option>
            <option value="molding">Injection Molding</option>
            <option value="assembly">Assembly</option>
            <option value="quality">Quality Stations</option>
        </select>
        <button class="btn btn-primary" onclick="openExportModal()">üì• Export Report</button>
    </div>
</div>

<!-- Main OEE Section -->
<div class="oee-main-section">
    <div class="oee-gauge-card">
        <div class="oee-gauge-title">Plant OEE Score</div>
        <div class="oee-gauge-container">
            <svg class="oee-gauge-svg" width="220" height="220" viewBox="0 0 220 220">
                <circle class="oee-gauge-bg" cx="110" cy="110" r="90"/>
                <circle class="oee-gauge-fill excellent" cx="110" cy="110" r="90"
                    stroke-dasharray="565.48"
                    stroke-dashoffset="70"
                    id="oee-gauge-circle"/>
            </svg>
            <div class="oee-gauge-value">
                <div class="oee-gauge-number" id="main-oee-value">87.6%</div>
                <div class="oee-gauge-label">World Class: 85%</div>
            </div>
        </div>
        <div class="oee-components">
            <div class="oee-component">
                <div class="oee-component-value" id="availability-value">92.4%</div>
                <div class="oee-component-label">Availability</div>
            </div>
            <div class="oee-component">
                <div class="oee-component-value" id="performance-value">95.1%</div>
                <div class="oee-component-label">Performance</div>
            </div>
            <div class="oee-component">
                <div class="oee-component-value" id="quality-value">99.6%</div>
                <div class="oee-component-label">Quality</div>
            </div>
        </div>
    </div>

    <div class="trend-chart-card">
        <div class="chart-header">
            <div class="chart-title">7-Day OEE Trend</div>
            <div class="chart-legend">
                <div class="legend-item"><span class="legend-dot oee"></span>OEE</div>
                <div class="legend-item"><span class="legend-dot availability"></span>Availability</div>
                <div class="legend-item"><span class="legend-dot performance"></span>Performance</div>
                <div class="legend-item"><span class="legend-dot quality"></span>Quality</div>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="trendChart" class="chart-canvas"></canvas>
        </div>
    </div>
</div>

<!-- Loss Analysis Section -->
<div class="loss-section">
    <div class="loss-card">
        <div class="loss-header">
            <div class="loss-title">
                <div class="loss-icon availability">‚è±</div>
                Availability Losses
            </div>
            <div class="loss-total">
                <div class="loss-total-value">7.6%</div>
                <div class="loss-total-label">Total Loss</div>
            </div>
        </div>
        <div class="loss-items">
            <div class="loss-item">
                <div class="loss-bar-container">
                    <div class="loss-bar-label">
                        <span class="loss-bar-name">Planned Downtime</span>
                        <span class="loss-bar-value">3.2%</span>
                    </div>
                    <div class="loss-bar">
                        <div class="loss-bar-fill availability" style="width: 42%"></div>
                    </div>
                </div>
            </div>
            <div class="loss-item">
                <div class="loss-bar-container">
                    <div class="loss-bar-label">
                        <span class="loss-bar-name">Equipment Failure</span>
                        <span class="loss-bar-value">2.1%</span>
                    </div>
                    <div class="loss-bar">
                        <div class="loss-bar-fill availability" style="width: 28%"></div>
                    </div>
                </div>
            </div>
            <div class="loss-item">
                <div class="loss-bar-container">
                    <div class="loss-bar-label">
                        <span class="loss-bar-name">Changeover</span>
                        <span class="loss-bar-value">1.5%</span>
                    </div>
                    <div class="loss-bar">
                        <div class="loss-bar-fill availability" style="width: 20%"></div>
                    </div>
                </div>
            </div>
            <div class="loss-item">
                <div class="loss-bar-container">
                    <div class="loss-bar-label">
                        <span class="loss-bar-name">Material Shortage</span>
                        <span class="loss-bar-value">0.8%</span>
                    </div>
                    <div class="loss-bar">
                        <div class="loss-bar-fill availability" style="width: 10%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loss-card">
        <div class="loss-header">
            <div class="loss-title">
                <div class="loss-icon performance">‚ö°</div>
                Performance Losses
            </div>
            <div class="loss-total">
                <div class="loss-total-value">4.9%</div>
                <div class="loss-total-label">Total Loss</div>
            </div>
        </div>
        <div class="loss-items">
            <div class="loss-item">
                <div class="loss-bar-container">
                    <div class="loss-bar-label">
                        <span class="loss-bar-name">Reduced Speed</span>
                        <span class="loss-bar-value">2.3%</span>
                    </div>
                    <div class="loss-bar">
                        <div class="loss-bar-fill performance" style="width: 47%"></div>
                    </div>
                </div>
            </div>
            <div class="loss-item">
                <div class="loss-bar-container">
                    <div class="loss-bar-label">
                        <span class="loss-bar-name">Minor Stops</span>
                        <span class="loss-bar-value">1.8%</span>
                    </div>
                    <div class="loss-bar">
                        <div class="loss-bar-fill performance" style="width: 37%"></div>
                    </div>
                </div>
            </div>
            <div class="loss-item">
                <div class="loss-bar-container">
                    <div class="loss-bar-label">
                        <span class="loss-bar-name">Idling</span>
                        <span class="loss-bar-value">0.8%</span>
                    </div>
                    <div class="loss-bar">
                        <div class="loss-bar-fill performance" style="width: 16%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loss-card">
        <div class="loss-header">
            <div class="loss-title">
                <div class="loss-icon quality">‚úì</div>
                Quality Losses
            </div>
            <div class="loss-total">
                <div class="loss-total-value">0.4%</div>
                <div class="loss-total-label">Total Loss</div>
            </div>
        </div>
        <div class="loss-items">
            <div class="loss-item">
                <div class="loss-bar-container">
                    <div class="loss-bar-label">
                        <span class="loss-bar-name">Defects</span>
                        <span class="loss-bar-value">0.25%</span>
                    </div>
                    <div class="loss-bar">
                        <div class="loss-bar-fill quality" style="width: 63%"></div>
                    </div>
                </div>
            </div>
            <div class="loss-item">
                <div class="loss-bar-container">
                    <div class="loss-bar-label">
                        <span class="loss-bar-name">Startup Rejects</span>
                        <span class="loss-bar-value">0.15%</span>
                    </div>
                    <div class="loss-bar">
                        <div class="loss-bar-fill quality" style="width: 37%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Work Center Comparison & Target -->
<div class="comparison-section">
    <div class="comparison-card">
        <div class="chart-header">
            <div class="chart-title">Work Center OEE Comparison</div>
        </div>
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Work Center</th>
                    <th>OEE</th>
                    <th>Availability</th>
                    <th>Performance</th>
                    <th>Quality</th>
                    <th>Trend</th>
                </tr>
            </thead>
            <tbody id="comparison-table-body">
                <!-- Rendered by JavaScript -->
            </tbody>
        </table>
    </div>

    <div class="target-card">
        <div class="target-header">
            <div class="target-title">üéØ Monthly Target</div>
            <button class="target-edit-btn">Edit</button>
        </div>
        <div class="target-gauge">
            <div class="target-progress">
                <svg class="target-ring" width="150" height="150" viewBox="0 0 150 150">
                    <circle class="target-ring-bg" cx="75" cy="75" r="60"/>
                    <circle class="target-ring-fill" cx="75" cy="75" r="60"
                        stroke-dasharray="377"
                        stroke-dashoffset="75"/>
                </svg>
                <div class="target-center">
                    <div class="target-percent">80%</div>
                    <div class="target-label">of target</div>
                </div>
            </div>
        </div>
        <div class="target-details">
            <div class="target-row">
                <span class="target-row-label">Current OEE</span>
                <span class="target-row-value">87.6%</span>
            </div>
            <div class="target-row">
                <span class="target-row-label">Target OEE</span>
                <span class="target-row-value">90.0%</span>
            </div>
            <div class="target-row">
                <span class="target-row-label">Gap to Target</span>
                <span class="target-row-value" style="color: #f59e0b;">-2.4%</span>
            </div>
            <div class="target-row">
                <span class="target-row-label">Days Remaining</span>
                <span class="target-row-value">10</span>
            </div>
        </div>
    </div>
</div>

<!-- Shift Analysis -->
<div class="shift-section">
    <div class="shift-header">
        <div class="shift-title">üìÖ Shift Performance Analysis</div>
    </div>
    <div class="shift-grid">
        <div class="shift-card">
            <div class="shift-name">Morning Shift</div>
            <div class="shift-time">06:00 - 14:00</div>
            <div class="shift-oee excellent">89.2%</div>
            <div class="shift-metrics">
                <div class="shift-metric">
                    <span class="shift-metric-value">94.1%</span>
                    <span class="shift-metric-label">Avail</span>
                </div>
                <div class="shift-metric">
                    <span class="shift-metric-value">95.8%</span>
                    <span class="shift-metric-label">Perf</span>
                </div>
                <div class="shift-metric">
                    <span class="shift-metric-value">99.2%</span>
                    <span class="shift-metric-label">Qual</span>
                </div>
            </div>
        </div>
        <div class="shift-card">
            <div class="shift-name">Afternoon Shift</div>
            <div class="shift-time">14:00 - 22:00</div>
            <div class="shift-oee good">86.8%</div>
            <div class="shift-metrics">
                <div class="shift-metric">
                    <span class="shift-metric-value">91.5%</span>
                    <span class="shift-metric-label">Avail</span>
                </div>
                <div class="shift-metric">
                    <span class="shift-metric-value">94.2%</span>
                    <span class="shift-metric-label">Perf</span>
                </div>
                <div class="shift-metric">
                    <span class="shift-metric-value">99.8%</span>
                    <span class="shift-metric-label">Qual</span>
                </div>
            </div>
        </div>
        <div class="shift-card">
            <div class="shift-name">Night Shift</div>
            <div class="shift-time">22:00 - 06:00</div>
            <div class="shift-oee warning">82.4%</div>
            <div class="shift-metrics">
                <div class="shift-metric">
                    <span class="shift-metric-value">88.2%</span>
                    <span class="shift-metric-label">Avail</span>
                </div>
                <div class="shift-metric">
                    <span class="shift-metric-value">93.1%</span>
                    <span class="shift-metric-label">Perf</span>
                </div>
                <div class="shift-metric">
                    <span class="shift-metric-value">99.5%</span>
                    <span class="shift-metric-label">Qual</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container"></div>

<!-- Export Modal -->
<div class="modal-overlay" id="exportModal">
    <div class="modal">
        <div class="modal-header">
            <h2>üì• Export OEE Report</h2>
            <button class="modal-close" onclick="closeModal('exportModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Report Period</label>
                <div style="display: flex; gap: 1rem;">
                    <input type="date" id="exportStartDate" class="form-input" style="flex: 1;">
                    <span style="align-self: center; color: var(--text-secondary);">to</span>
                    <input type="date" id="exportEndDate" class="form-input" style="flex: 1;">
                </div>
            </div>

            <label class="form-label">Export Format</label>
            <div class="export-options">
                <div class="export-option selected" onclick="selectExportFormat('pdf', this)">
                    <div class="export-option-icon">üìÑ</div>
                    <div class="export-option-title">PDF Report</div>
                    <div class="export-option-desc">Complete report with charts</div>
                </div>
                <div class="export-option" onclick="selectExportFormat('excel', this)">
                    <div class="export-option-icon">üìä</div>
                    <div class="export-option-title">Excel Spreadsheet</div>
                    <div class="export-option-desc">Raw data for analysis</div>
                </div>
                <div class="export-option" onclick="selectExportFormat('csv', this)">
                    <div class="export-option-icon">üìã</div>
                    <div class="export-option-title">CSV Data</div>
                    <div class="export-option-desc">Simple data export</div>
                </div>
                <div class="export-option" onclick="selectExportFormat('ppt', this)">
                    <div class="export-option-icon">üìΩÔ∏è</div>
                    <div class="export-option-title">PowerPoint</div>
                    <div class="export-option-desc">Presentation format</div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Include Sections</label>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" checked> OEE Summary & Gauges
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" checked> Loss Analysis (Pareto)
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" checked> Work Center Comparison
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" checked> Shift Performance
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox"> Raw Event Data
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('exportModal')">Cancel</button>
            <button class="btn btn-success" onclick="generateExport()">Generate Report</button>
        </div>
    </div>
</div>

<!-- Work Center Detail Modal -->
<div class="modal-overlay" id="wcDetailModal">
    <div class="modal" style="max-width: 900px;">
        <div class="modal-header">
            <h2 id="wcDetailTitle">üè≠ Work Center OEE Details</h2>
            <button class="modal-close" onclick="closeModal('wcDetailModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="detail-grid">
                <div class="detail-card">
                    <h4>Overall OEE</h4>
                    <div class="detail-value" id="detailOee">94.5%</div>
                </div>
                <div class="detail-card">
                    <h4>Availability</h4>
                    <div class="detail-value" id="detailAvailability">98.0%</div>
                </div>
                <div class="detail-card">
                    <h4>Performance</h4>
                    <div class="detail-value" id="detailPerformance">97.0%</div>
                </div>
                <div class="detail-card">
                    <h4>Quality</h4>
                    <div class="detail-value" id="detailQuality">99.5%</div>
                </div>
            </div>

            <div style="margin-top: 1.5rem;">
                <h4 style="margin-bottom: 1rem; color: var(--text-primary);">üìà 7-Day OEE Trend</h4>
                <div class="detail-chart">
                    <canvas id="wcTrendChart"></canvas>
                </div>
            </div>

            <div style="margin-top: 1.5rem;">
                <h4 style="margin-bottom: 1rem; color: var(--text-primary);">üîç Loss Breakdown</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div class="detail-card">
                        <h4>Availability Losses</h4>
                        <div class="loss-items" id="detailAvailLosses">
                            <div class="loss-item">
                                <div class="loss-bar-container">
                                    <div class="loss-bar-label">
                                        <span class="loss-bar-name">Breakdowns</span>
                                        <span class="loss-bar-value">1.2%</span>
                                    </div>
                                    <div class="loss-bar">
                                        <div class="loss-bar-fill availability" style="width: 60%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="loss-item">
                                <div class="loss-bar-container">
                                    <div class="loss-bar-label">
                                        <span class="loss-bar-name">Setup</span>
                                        <span class="loss-bar-value">0.8%</span>
                                    </div>
                                    <div class="loss-bar">
                                        <div class="loss-bar-fill availability" style="width: 40%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="detail-card">
                        <h4>Performance Losses</h4>
                        <div class="loss-items" id="detailPerfLosses">
                            <div class="loss-item">
                                <div class="loss-bar-container">
                                    <div class="loss-bar-label">
                                        <span class="loss-bar-name">Minor Stops</span>
                                        <span class="loss-bar-value">1.8%</span>
                                    </div>
                                    <div class="loss-bar">
                                        <div class="loss-bar-fill performance" style="width: 60%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="loss-item">
                                <div class="loss-bar-container">
                                    <div class="loss-bar-label">
                                        <span class="loss-bar-name">Slow Cycles</span>
                                        <span class="loss-bar-value">1.2%</span>
                                    </div>
                                    <div class="loss-bar">
                                        <div class="loss-bar-fill performance" style="width: 40%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="detail-card">
                        <h4>Quality Losses</h4>
                        <div class="loss-items" id="detailQualLosses">
                            <div class="loss-item">
                                <div class="loss-bar-container">
                                    <div class="loss-bar-label">
                                        <span class="loss-bar-name">Defects</span>
                                        <span class="loss-bar-value">0.3%</span>
                                    </div>
                                    <div class="loss-bar">
                                        <div class="loss-bar-fill quality" style="width: 60%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="loss-item">
                                <div class="loss-bar-container">
                                    <div class="loss-bar-label">
                                        <span class="loss-bar-name">Rework</span>
                                        <span class="loss-bar-value">0.2%</span>
                                    </div>
                                    <div class="loss-bar">
                                        <div class="loss-bar-fill quality" style="width: 40%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('wcDetailModal')">Close</button>
            <button class="btn btn-primary" onclick="drillDownToWorkCenter()">View Full Details</button>
        </div>
    </div>
</div>

<!-- Target Edit Modal -->
<div class="modal-overlay" id="targetModal">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h2>üéØ Edit OEE Targets</h2>
            <button class="modal-close" onclick="closeModal('targetModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Overall OEE Target (%)</label>
                <input type="number" id="targetOee" class="form-input" value="90" min="0" max="100">
            </div>
            <div class="form-group">
                <label class="form-label">Availability Target (%)</label>
                <input type="number" id="targetAvailability" class="form-input" value="95" min="0" max="100">
            </div>
            <div class="form-group">
                <label class="form-label">Performance Target (%)</label>
                <input type="number" id="targetPerformance" class="form-input" value="98" min="0" max="100">
            </div>
            <div class="form-group">
                <label class="form-label">Quality Target (%)</label>
                <input type="number" id="targetQuality" class="form-input" value="99.5" min="0" max="100">
            </div>
            <div class="form-group">
                <label class="form-label">Target Period</label>
                <select id="targetPeriod" class="form-select">
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="yearly">Yearly</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('targetModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveTargets()">Save Targets</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Work center comparison data
    const workCenterData = [
        { name: 'Injection Mold A', oee: 94.5, availability: 98.0, performance: 97.0, quality: 99.5, trend: 'up' },
        { name: '3D Printer Bay 2', oee: 91.2, availability: 95.0, performance: 96.0, quality: 99.9, trend: 'up' },
        { name: 'Quality Station 1', oee: 89.1, availability: 99.5, performance: 89.8, quality: 99.8, trend: 'stable' },
        { name: '3D Printer Bay 1', oee: 87.5, availability: 92.0, performance: 95.0, quality: 99.8, trend: 'down' },
        { name: 'Packaging Line 1', oee: 85.2, availability: 94.0, performance: 91.0, quality: 99.7, trend: 'up' },
        { name: 'Assembly Cell 1', oee: 78.5, availability: 85.0, performance: 92.0, quality: 99.9, trend: 'stable' },
    ];

    function getOeeClass(oee) {
        if (oee >= 85) return 'excellent';
        if (oee >= 75) return 'good';
        if (oee >= 60) return 'warning';
        return 'critical';
    }

    function renderComparisonTable() {
        const tbody = document.getElementById('comparison-table-body');
        tbody.innerHTML = workCenterData.map(wc => `
            <tr>
                <td>
                    <div class="wc-name-cell">
                        <span class="wc-status-dot ${getOeeClass(wc.oee)}"></span>
                        ${wc.name}
                    </div>
                </td>
                <td>
                    <div class="oee-mini-bar">
                        <div class="oee-mini-fill ${getOeeClass(wc.oee)}" style="width: ${wc.oee}%">
                            ${wc.oee.toFixed(1)}%
                        </div>
                    </div>
                </td>
                <td>${wc.availability.toFixed(1)}%</td>
                <td>${wc.performance.toFixed(1)}%</td>
                <td>${wc.quality.toFixed(1)}%</td>
                <td style="color: ${wc.trend === 'up' ? '#10b981' : wc.trend === 'down' ? '#ef4444' : 'var(--text-secondary)'}">
                    ${wc.trend === 'up' ? '‚Üë' : wc.trend === 'down' ? '‚Üì' : '‚Üí'}
                </td>
            </tr>
        `).join('');
    }

    function initTrendChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [
                    {
                        label: 'OEE',
                        data: [85.2, 86.8, 88.1, 87.5, 89.2, 86.4, 87.6],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                    },
                    {
                        label: 'Availability',
                        data: [90.1, 91.5, 92.8, 91.2, 93.5, 90.8, 92.4],
                        borderColor: '#10b981',
                        borderWidth: 2,
                        tension: 0.4,
                    },
                    {
                        label: 'Performance',
                        data: [94.2, 95.1, 95.8, 94.8, 96.2, 94.5, 95.1],
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        tension: 0.4,
                    },
                    {
                        label: 'Quality',
                        data: [99.4, 99.5, 99.7, 99.6, 99.8, 99.5, 99.6],
                        borderColor: '#8b5cf6',
                        borderWidth: 2,
                        tension: 0.4,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        min: 80,
                        max: 100,
                        ticks: {
                            callback: value => value + '%'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }

    // ============================================
    // Modal Functions
    // ============================================
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
        document.body.style.overflow = '';
    }

    // Close modal on backdrop click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
    });

    // ============================================
    // Toast Notifications
    // ============================================
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : type === 'warning' ? '‚ö†' : '‚Ñπ'}</span>
            <span>${message}</span>
        `;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }

    // ============================================
    // Export Functionality
    // ============================================
    let selectedExportFormat = 'pdf';

    function openExportModal() {
        // Set default dates
        document.getElementById('exportStartDate').value = document.getElementById('startDate').value;
        document.getElementById('exportEndDate').value = document.getElementById('endDate').value;
        openModal('exportModal');
    }

    function selectExportFormat(format, element) {
        selectedExportFormat = format;
        document.querySelectorAll('.export-option').forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');
    }

    function generateExport() {
        showToast(`Generating ${selectedExportFormat.toUpperCase()} report...`, 'info');
        closeModal('exportModal');

        setTimeout(() => {
            showToast(`OEE Report exported as ${selectedExportFormat.toUpperCase()}`, 'success');
        }, 2000);
    }

    // ============================================
    // Quick Filters
    // ============================================
    function setTimeRange(range) {
        document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        const today = new Date();
        let startDate, endDate = today;

        switch (range) {
            case 'today':
                startDate = today;
                break;
            case 'week':
                startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 7);
                break;
            case 'month':
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                break;
        }

        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        applyDateFilter();
    }

    function applyDateFilter() {
        showToast('Updating OEE data for selected period...', 'info');
        // Pattern-based OEE update
        setTimeout(() => {
            const hour = new Date().getHours();
            const shiftBonus = (hour >= 6 && hour < 14) ? 3 : (hour >= 14 && hour < 22) ? 1 : -1;
            const baseOEE = 88 + shiftBonus + Math.sin(Date.now() / 60000) * 2;
            updateOeeGauge(Math.max(80, Math.min(98, baseOEE)));
            showToast('Dashboard updated', 'success');
        }, 1000);
    }

    function applyWorkCenterFilter(value) {
        showToast(`Filtering by: ${value === 'all' ? 'All Work Centers' : value}`, 'info');
        // Pattern-based filter update
        setTimeout(() => {
            renderComparisonTable();
            const wcHash = value === 'all' ? 0 : value.charCodeAt(value.length - 1);
            const baseOEE = 85 + (wcHash % 10) + Math.sin(Date.now() / 120000) * 3;
            updateOeeGauge(Math.max(75, Math.min(97, baseOEE)));
        }, 500);
    }

    // ============================================
    // OEE Gauge Updates
    // ============================================
    function updateOeeGauge(oee) {
        const circle = document.getElementById('oee-gauge-circle');
        const circumference = 2 * Math.PI * 90;
        const offset = circumference - (oee / 100) * circumference;
        circle.style.strokeDashoffset = offset;

        document.getElementById('main-oee-value').textContent = oee.toFixed(1) + '%';

        // Update class based on OEE
        circle.className.baseVal = 'oee-gauge-fill ' + getOeeClass(oee);
    }

    // ============================================
    // Work Center Detail Drill-down
    // ============================================
    let currentWorkCenter = null;
    let wcTrendChart = null;

    function showWorkCenterDetails(wc) {
        currentWorkCenter = wc;
        document.getElementById('wcDetailTitle').textContent = `üè≠ ${wc.name} - OEE Details`;
        document.getElementById('detailOee').textContent = wc.oee.toFixed(1) + '%';
        document.getElementById('detailAvailability').textContent = wc.availability.toFixed(1) + '%';
        document.getElementById('detailPerformance').textContent = wc.performance.toFixed(1) + '%';
        document.getElementById('detailQuality').textContent = wc.quality.toFixed(1) + '%';

        // Create WC trend chart
        if (wcTrendChart) wcTrendChart.destroy();
        const ctx = document.getElementById('wcTrendChart').getContext('2d');
        wcTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'OEE',
                    data: [wc.oee - 3, wc.oee - 1, wc.oee + 1, wc.oee - 2, wc.oee + 2, wc.oee - 1, wc.oee],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { min: 70, max: 100, ticks: { callback: v => v + '%' } }
                }
            }
        });

        openModal('wcDetailModal');
    }

    function drillDownToWorkCenter() {
        if (currentWorkCenter) {
            closeModal('wcDetailModal');
            window.location.href = `/manufacturing/work-centers?id=${encodeURIComponent(currentWorkCenter.name)}`;
        }
    }

    // ============================================
    // Target Modal
    // ============================================
    function openTargetModal() {
        openModal('targetModal');
    }

    function saveTargets() {
        const targetOee = document.getElementById('targetOee').value;
        showToast(`OEE target updated to ${targetOee}%`, 'success');
        closeModal('targetModal');
    }

    // ============================================
    // Render Comparison Table with Click Handlers
    // ============================================
    function renderComparisonTable() {
        const tbody = document.getElementById('comparison-table-body');
        tbody.innerHTML = workCenterData.map((wc, idx) => `
            <tr onclick="showWorkCenterDetails(workCenterData[${idx}])">
                <td>
                    <div class="wc-name-cell">
                        <span class="wc-status-dot ${getOeeClass(wc.oee)}"></span>
                        ${wc.name}
                    </div>
                </td>
                <td>
                    <div class="oee-mini-bar">
                        <div class="oee-mini-fill ${getOeeClass(wc.oee)}" style="width: ${wc.oee}%">
                            ${wc.oee.toFixed(1)}%
                        </div>
                    </div>
                </td>
                <td>${wc.availability.toFixed(1)}%</td>
                <td>${wc.performance.toFixed(1)}%</td>
                <td>${wc.quality.toFixed(1)}%</td>
                <td style="color: ${wc.trend === 'up' ? '#10b981' : wc.trend === 'down' ? '#ef4444' : 'var(--text-secondary)'}">
                    ${wc.trend === 'up' ? '‚Üë' : wc.trend === 'down' ? '‚Üì' : '‚Üí'}
                </td>
            </tr>
        `).join('');
    }

    // ============================================
    // Live Data Updates (API with pattern fallback)
    // ============================================
    const OEE_API_BASE = '/api/ai/context';
    let dataMode = 'initializing';

    // Pattern-based simulation (realistic, not random)
    const OEEPatterns = {
        getOEE() {
            const hour = new Date().getHours();
            const minute = new Date().getMinutes();
            // Morning shift typically best (6am-2pm)
            const shiftBonus = (hour >= 6 && hour < 14) ? 3 :
                               (hour >= 14 && hour < 22) ? 0 : -2;
            const base = 82 + shiftBonus;
            // Sinusoidal variation
            const variation = Math.sin((hour + minute/60) * Math.PI / 12) * 2;
            return Math.max(75, Math.min(98, base + variation));
        },
        getAvailability() {
            const hour = new Date().getHours();
            return 92 + Math.sin(hour * 0.3) * 3;
        },
        getPerformance() {
            const hour = new Date().getHours();
            return 90 + Math.sin(hour * 0.4) * 4;
        },
        getQuality() {
            const hour = new Date().getHours();
            return 98 + Math.sin(hour * 0.2) * 1;
        }
    };

    async function fetchOEEData() {
        try {
            const response = await fetch(`${OEE_API_BASE}?include=oee`);
            if (response.ok) {
                const data = await response.json();
                if (data.oee) {
                    dataMode = data.data_mode || 'live';
                    updateDataModeIndicator(dataMode);
                    return {
                        oee: data.oee.current * 100,
                        availability: data.oee.availability * 100,
                        performance: data.oee.performance * 100,
                        quality: data.oee.quality * 100
                    };
                }
            }
        } catch (error) {
            console.log('OEE API unavailable, using patterns');
        }
        // Fallback to pattern-based simulation
        dataMode = 'simulation';
        updateDataModeIndicator('simulation');
        return {
            oee: OEEPatterns.getOEE(),
            availability: OEEPatterns.getAvailability(),
            performance: OEEPatterns.getPerformance(),
            quality: OEEPatterns.getQuality()
        };
    }

    function updateDataModeIndicator(mode) {
        const indicator = document.getElementById('dataModeIndicator');
        if (indicator) {
            indicator.className = 'badge ' + (mode === 'live' ? 'bg-success' : 'bg-warning');
            indicator.textContent = mode === 'live' ? 'LIVE' : 'SIMULATION';
        }
    }

    async function startLiveUpdates() {
        // Initial fetch
        const initialData = await fetchOEEData();
        updateOeeGauge(initialData.oee);
        document.getElementById('availability-value').textContent = initialData.availability.toFixed(1) + '%';
        document.getElementById('performance-value').textContent = initialData.performance.toFixed(1) + '%';
        document.getElementById('quality-value').textContent = initialData.quality.toFixed(1) + '%';

        // Periodic updates
        setInterval(async () => {
            const data = await fetchOEEData();
            updateOeeGauge(data.oee);
            document.getElementById('availability-value').textContent = data.availability.toFixed(1) + '%';
            document.getElementById('performance-value').textContent = data.performance.toFixed(1) + '%';
            document.getElementById('quality-value').textContent = data.quality.toFixed(1) + '%';
        }, 5000);
    }

    // ============================================
    // Initialize
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        renderComparisonTable();
        initTrendChart();
        startLiveUpdates();

        // Hook up target edit button
        document.querySelector('.target-edit-btn').addEventListener('click', openTargetModal);
    });
</script>
{% endblock %}
