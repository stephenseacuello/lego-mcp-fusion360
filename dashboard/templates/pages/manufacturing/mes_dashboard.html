{% extends "base.html" %}

{% block title %}MES Dashboard - LEGO MCP v5.0{% endblock %}

{% block styles %}
<style>
    /* ============================================
       LEGO MCP v5.0 - Manufacturing Execution System Dashboard
       PhD-Level World-Class Manufacturing Platform
       Enhanced with WebSocket Real-Time Updates
       ============================================ */

    :root {
        --mes-primary: #3b82f6;
        --mes-secondary: #6366f1;
        --mes-success: #22c55e;
        --mes-warning: #f59e0b;
        --mes-danger: #ef4444;
        --mes-info: #06b6d4;
        --card-bg: #1e293b;
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --border-color: #334155;
        --primary-color: #3b82f6;
    }

    .mes-dashboard {
        padding: 1.5rem;
        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        min-height: 100vh;
    }

    /* WebSocket Connection Status */
    .ws-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .ws-status.connected {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
    }

    .ws-status.disconnected {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }

    .ws-status.connecting {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal {
        background: var(--card-bg);
        border-radius: 16px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, var(--mes-primary), var(--mes-secondary));
    }

    .modal-header h3 {
        margin: 0;
        color: white;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-close {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        cursor: pointer;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .modal-body {
        padding: 24px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 0.95rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: var(--mes-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .form-textarea {
        resize: vertical;
        min-height: 100px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    /* Button Styles */
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--mes-primary), var(--mes-secondary));
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
        background: var(--border-color);
        color: var(--text-primary);
    }

    .btn-secondary:hover {
        background: var(--bg-secondary);
    }

    .btn-success {
        background: var(--mes-success);
        color: white;
    }

    .btn-danger {
        background: var(--mes-danger);
        color: white;
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1100;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .toast {
        padding: 16px 20px;
        border-radius: 12px;
        color: white;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: toastSlideIn 0.3s ease-out;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        min-width: 300px;
    }

    @keyframes toastSlideIn {
        from {
            opacity: 0;
            transform: translateX(100px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .toast.success { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .toast.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .toast.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }

    .toast-close {
        margin-left: auto;
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        opacity: 0.7;
    }

    .toast-close:hover {
        opacity: 1;
    }

    /* Real-time Data Highlights */
    .data-updated {
        animation: dataHighlight 1s ease-out;
    }

    @keyframes dataHighlight {
        0% { background: rgba(59, 130, 246, 0.3); }
        100% { background: transparent; }
    }

    /* Loading Skeleton */
    .skeleton {
        background: linear-gradient(90deg, var(--border-color) 25%, var(--bg-secondary) 50%, var(--border-color) 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
        border-radius: 6px;
    }

    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Work Center Detail View */
    .wc-detail-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 20px;
    }

    .wc-detail-card {
        background: var(--bg-primary);
        padding: 16px;
        border-radius: 12px;
        text-align: center;
    }

    .wc-detail-value {
        font-size: 2rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--mes-primary), var(--mes-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .wc-detail-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-top: 4px;
    }

    /* Live Sensor Chart */
    .sensor-chart {
        height: 200px;
        background: var(--bg-primary);
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
    }

    /* Timeline */
    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border-color);
    }

    .timeline-item {
        position: relative;
        padding-bottom: 20px;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -24px;
        top: 4px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--mes-primary);
        border: 2px solid var(--card-bg);
    }

    .timeline-item.success::before { background: var(--mes-success); }
    .timeline-item.warning::before { background: var(--mes-warning); }
    .timeline-item.error::before { background: var(--mes-danger); }

    .timeline-time {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .timeline-content {
        margin-top: 4px;
        font-size: 0.9rem;
    }

    /* Header with System Status */
    .mes-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 1rem 1.5rem;
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .mes-title h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .mes-title .subtitle {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    .system-status {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .status-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-badge.online {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
    }

    .status-badge.offline {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }

    .status-pulse {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .status-pulse.online {
        background: #22c55e;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
    }

    /* KPI Cards Grid */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 1400px) {
        .kpi-grid { grid-template-columns: repeat(3, 1fr); }
    }

    @media (max-width: 768px) {
        .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }

    .kpi-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.25rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .kpi-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
    }

    .kpi-card.oee::before { background: linear-gradient(180deg, #3b82f6, #60a5fa); }
    .kpi-card.availability::before { background: linear-gradient(180deg, #22c55e, #4ade80); }
    .kpi-card.performance::before { background: linear-gradient(180deg, #f59e0b, #fbbf24); }
    .kpi-card.quality::before { background: linear-gradient(180deg, #8b5cf6, #a78bfa); }
    .kpi-card.production::before { background: linear-gradient(180deg, #ec4899, #f472b6); }
    .kpi-card.scrap::before { background: linear-gradient(180deg, #ef4444, #f87171); }

    .kpi-icon {
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
    }

    .kpi-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .kpi-value {
        font-size: 2rem;
        font-weight: 800;
        line-height: 1;
    }

    .kpi-value.positive { color: #22c55e; }
    .kpi-value.warning { color: #f59e0b; }
    .kpi-value.negative { color: #ef4444; }

    .kpi-trend {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        margin-top: 0.5rem;
        font-size: 0.75rem;
    }

    .kpi-trend.up { color: #22c55e; }
    .kpi-trend.down { color: #ef4444; }

    /* Main Content Grid */
    .content-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
    }

    @media (max-width: 1200px) {
        .content-grid { grid-template-columns: 1fr; }
    }

    .panel {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
    }

    .panel-title {
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .panel-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-icon {
        background: transparent;
        border: none;
        padding: 0.5rem;
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-secondary);
        transition: all 0.2s;
    }

    .btn-icon:hover {
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .panel-body {
        padding: 1.25rem;
    }

    /* Work Center Status Grid */
    .work-centers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1rem;
    }

    .work-center-tile {
        background: var(--bg-secondary);
        border-radius: 10px;
        padding: 1rem;
        position: relative;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
    }

    .work-center-tile:hover {
        border-color: var(--primary-color);
        transform: scale(1.02);
    }

    .work-center-tile.running {
        border-left: 4px solid #22c55e;
    }

    .work-center-tile.idle {
        border-left: 4px solid #f59e0b;
    }

    .work-center-tile.down {
        border-left: 4px solid #ef4444;
    }

    .work-center-tile.maintenance {
        border-left: 4px solid #6366f1;
    }

    .wc-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
    }

    .wc-name {
        font-weight: 700;
        font-size: 0.95rem;
    }

    .wc-type {
        font-size: 0.7rem;
        color: var(--text-secondary);
    }

    .wc-status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .wc-status-indicator.running { background: #22c55e; }
    .wc-status-indicator.idle { background: #f59e0b; }
    .wc-status-indicator.down { background: #ef4444; }
    .wc-status-indicator.maintenance { background: #6366f1; }

    .wc-metrics {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }

    .wc-metric {
        text-align: center;
        padding: 0.5rem;
        background: var(--card-bg);
        border-radius: 6px;
    }

    .wc-metric-value {
        font-size: 1.1rem;
        font-weight: 700;
    }

    .wc-metric-label {
        font-size: 0.65rem;
        color: var(--text-secondary);
        text-transform: uppercase;
    }

    .wc-progress {
        margin-top: 0.75rem;
    }

    .wc-progress-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.7rem;
        margin-bottom: 0.25rem;
    }

    .wc-progress-bar {
        height: 6px;
        background: var(--bg-primary);
        border-radius: 3px;
        overflow: hidden;
    }

    .wc-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
        border-radius: 3px;
        transition: width 0.5s;
    }

    /* Work Orders Table */
    .orders-table {
        width: 100%;
        border-collapse: collapse;
    }

    .orders-table th {
        text-align: left;
        padding: 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--border-color);
    }

    .orders-table td {
        padding: 0.75rem;
        font-size: 0.85rem;
        border-bottom: 1px solid var(--border-color);
    }

    .orders-table tbody tr:hover {
        background: var(--bg-secondary);
    }

    .order-id {
        font-weight: 600;
        color: var(--primary-color);
    }

    .priority-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .priority-badge.high {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }

    .priority-badge.medium {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }

    .priority-badge.low {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
    }

    .status-chip {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-chip.in-progress {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
    }

    .status-chip.pending {
        background: rgba(156, 163, 175, 0.15);
        color: #6b7280;
    }

    .status-chip.completed {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
    }

    /* Right Sidebar Panels */
    .sidebar-panels {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    /* Alerts Panel */
    .alert-item {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        background: var(--bg-secondary);
    }

    .alert-item.critical {
        border-left: 3px solid #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }

    .alert-item.warning {
        border-left: 3px solid #f59e0b;
        background: rgba(245, 158, 11, 0.1);
    }

    .alert-item.info {
        border-left: 3px solid #3b82f6;
        background: rgba(59, 130, 246, 0.1);
    }

    .alert-icon {
        font-size: 1.25rem;
    }

    .alert-content {
        flex: 1;
    }

    .alert-title {
        font-weight: 600;
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
    }

    .alert-message {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .alert-time {
        font-size: 0.65rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    /* Shift Summary */
    .shift-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }

    .shift-stat {
        background: var(--bg-secondary);
        padding: 0.75rem;
        border-radius: 8px;
        text-align: center;
    }

    .shift-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .shift-stat-label {
        font-size: 0.7rem;
        color: var(--text-secondary);
        text-transform: uppercase;
    }

    /* Real-time Chart Area */
    .chart-container {
        height: 200px;
        position: relative;
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 1rem;
    }

    .chart-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    /* Andon Board */
    .andon-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 0.5rem;
    }

    .andon-cell {
        aspect-ratio: 1;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        transition: transform 0.2s;
    }

    .andon-cell:hover {
        transform: scale(1.05);
    }

    .andon-cell.green {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
    }

    .andon-cell.yellow {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }

    .andon-cell.red {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        animation: blink 1s infinite;
    }

    .andon-cell.blue {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
    }

    .andon-cell.gray {
        background: linear-gradient(135deg, #9ca3af, #6b7280);
        color: white;
    }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .andon-cell-name {
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
    }

    .andon-cell-oee {
        font-size: 1rem;
    }

    /* Quick Actions */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    .quick-action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .quick-action-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .quick-action-btn span:first-child {
        font-size: 1.5rem;
    }

    /* Bottom Stats Bar */
    .bottom-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-top: 1.5rem;
    }

    @media (max-width: 768px) {
        .bottom-stats { grid-template-columns: repeat(2, 1fr); }
    }

    .bottom-stat-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }

    .bottom-stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .bottom-stat-icon.blue { background: rgba(59, 130, 246, 0.15); }
    .bottom-stat-icon.green { background: rgba(34, 197, 94, 0.15); }
    .bottom-stat-icon.purple { background: rgba(139, 92, 246, 0.15); }
    .bottom-stat-icon.orange { background: rgba(245, 158, 11, 0.15); }

    .bottom-stat-info h3 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
    }

    .bottom-stat-info p {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin: 0;
    }

    /* Refresh Indicator */
    .refresh-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .refresh-spinner {
        width: 12px;
        height: 12px;
        border: 2px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="mes-dashboard">
    <!-- Header with System Status -->
    <div class="mes-header">
        <div class="mes-title">
            <h1>Manufacturing Execution System</h1>
            <div class="subtitle">Real-Time Production Visibility | ISA-95 Level 3</div>
        </div>
        <div class="system-status">
            <div class="ws-status connecting" id="wsStatus">
                <div class="status-pulse"></div>
                <span>Connecting...</span>
            </div>
            <span class="status-badge" id="dataModeIndicator" style="background: rgba(34, 197, 94, 0.15); color: #22c55e;">
                <span id="dataModeIcon">‚óè</span>
                <span id="dataModeText">LIVE</span>
            </span>
            <div class="status-badge online">
                <div class="status-pulse online"></div>
                <span>System Online</span>
            </div>
            <div class="refresh-indicator">
                <div class="refresh-spinner"></div>
                <span>Live Updates</span>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card oee">
            <div class="kpi-icon">üìä</div>
            <div class="kpi-label">Overall OEE</div>
            <div class="kpi-value positive" id="kpi-oee">87.5%</div>
            <div class="kpi-trend up">
                <span>‚Üë</span> 2.3% vs yesterday
            </div>
        </div>
        <div class="kpi-card availability">
            <div class="kpi-icon">‚ö°</div>
            <div class="kpi-label">Availability</div>
            <div class="kpi-value positive" id="kpi-availability">94.2%</div>
            <div class="kpi-trend up">
                <span>‚Üë</span> 1.1% vs target
            </div>
        </div>
        <div class="kpi-card performance">
            <div class="kpi-icon">üöÄ</div>
            <div class="kpi-label">Performance</div>
            <div class="kpi-value warning" id="kpi-performance">92.8%</div>
            <div class="kpi-trend down">
                <span>‚Üì</span> 0.5% vs target
            </div>
        </div>
        <div class="kpi-card quality">
            <div class="kpi-icon">‚ú®</div>
            <div class="kpi-label">Quality</div>
            <div class="kpi-value positive" id="kpi-quality">99.1%</div>
            <div class="kpi-trend up">
                <span>‚Üë</span> 0.3% vs target
            </div>
        </div>
        <div class="kpi-card production">
            <div class="kpi-icon">üè≠</div>
            <div class="kpi-label">Parts Today</div>
            <div class="kpi-value" id="kpi-production">1,247</div>
            <div class="kpi-trend up">
                <span>‚Üë</span> 85% of daily target
            </div>
        </div>
        <div class="kpi-card scrap">
            <div class="kpi-icon">üóëÔ∏è</div>
            <div class="kpi-label">Scrap Rate</div>
            <div class="kpi-value positive" id="kpi-scrap">0.9%</div>
            <div class="kpi-trend up">
                <span>‚Üì</span> Below 1% target
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
        <!-- Left Column: Work Centers & Orders -->
        <div class="main-content">
            <!-- Work Centers Panel -->
            <div class="panel" style="margin-bottom: 1.5rem;">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span>üñ®Ô∏è</span> Work Centers Status
                    </h2>
                    <div class="panel-actions">
                        <button class="btn-icon" title="Refresh">üîÑ</button>
                        <button class="btn-icon" title="Settings">‚öôÔ∏è</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="work-centers-grid" id="workCentersGrid">
                        <!-- Work Center tiles populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Active Work Orders Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span>üìã</span> Active Work Orders
                    </h2>
                    <div class="panel-actions">
                        <button class="btn-icon" title="Filter">üîç</button>
                        <button class="btn-icon" title="Export">üì•</button>
                    </div>
                </div>
                <div class="panel-body" style="padding: 0;">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Work Order</th>
                                <th>Part</th>
                                <th>Quantity</th>
                                <th>Progress</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Due</th>
                            </tr>
                        </thead>
                        <tbody id="workOrdersTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="sidebar-panels">
            <!-- Andon Board -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span>üö¶</span> Andon Board
                    </h2>
                </div>
                <div class="panel-body">
                    <div class="andon-grid" id="andonBoard">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Alerts Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span>üîî</span> Alerts
                    </h2>
                    <span class="badge" id="alertCount">3</span>
                </div>
                <div class="panel-body" id="alertsPanel">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Shift Summary -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span>üìà</span> Current Shift
                    </h2>
                </div>
                <div class="panel-body">
                    <div class="shift-stats">
                        <div class="shift-stat">
                            <div class="shift-stat-value" id="shiftGood">1,235</div>
                            <div class="shift-stat-label">Good Parts</div>
                        </div>
                        <div class="shift-stat">
                            <div class="shift-stat-value" id="shiftScrap">12</div>
                            <div class="shift-stat-label">Scrap</div>
                        </div>
                        <div class="shift-stat">
                            <div class="shift-stat-value" id="shiftDowntime">23m</div>
                            <div class="shift-stat-label">Downtime</div>
                        </div>
                        <div class="shift-stat">
                            <div class="shift-stat-value" id="shiftYield">99.0%</div>
                            <div class="shift-stat-label">Yield</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span>‚ö°</span> Quick Actions
                    </h2>
                </div>
                <div class="panel-body">
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="createWorkOrder()">
                            <span>‚ûï</span>
                            <span>New Work Order</span>
                        </button>
                        <button class="quick-action-btn" onclick="logDowntime()">
                            <span>‚è∏Ô∏è</span>
                            <span>Log Downtime</span>
                        </button>
                        <button class="quick-action-btn" onclick="qualityHold()">
                            <span>üõë</span>
                            <span>Quality Hold</span>
                        </button>
                        <button class="quick-action-btn" onclick="openReports()">
                            <span>üìä</span>
                            <span>Reports</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Stats -->
    <div class="bottom-stats">
        <div class="bottom-stat-card">
            <div class="bottom-stat-icon blue">‚è±Ô∏è</div>
            <div class="bottom-stat-info">
                <h3 id="avgCycleTime">42s</h3>
                <p>Avg. Cycle Time</p>
            </div>
        </div>
        <div class="bottom-stat-card">
            <div class="bottom-stat-icon green">üì¶</div>
            <div class="bottom-stat-info">
                <h3 id="ordersComplete">23</h3>
                <p>Orders Completed</p>
            </div>
        </div>
        <div class="bottom-stat-card">
            <div class="bottom-stat-icon purple">üë•</div>
            <div class="bottom-stat-info">
                <h3 id="operatorsActive">8</h3>
                <p>Operators Active</p>
            </div>
        </div>
        <div class="bottom-stat-card">
            <div class="bottom-stat-icon orange">üîã</div>
            <div class="bottom-stat-info">
                <h3 id="energyUsage">127 kWh</h3>
                <p>Energy Today</p>
            </div>
        </div>
    </div>
</div>

<!-- Work Order Modal -->
<div class="modal-overlay" id="workOrderModal">
    <div class="modal">
        <div class="modal-header">
            <h3><span>üìã</span> Create Work Order</h3>
            <button class="modal-close" onclick="closeModal('workOrderModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="workOrderForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Part Number</label>
                        <select class="form-select" id="woPartNumber" required>
                            <option value="">Select Part...</option>
                            <option value="3001">LEGO 3001 (2x4 Brick)</option>
                            <option value="3003">LEGO 3003 (2x2 Brick)</option>
                            <option value="3020">LEGO 3020 (2x4 Plate)</option>
                            <option value="3004">LEGO 3004 (1x2 Brick)</option>
                            <option value="3010">LEGO 3010 (1x4 Brick)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-input" id="woQuantity" min="1" value="100" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="woPriority" required>
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date/Time</label>
                        <input type="datetime-local" class="form-input" id="woDueDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Assigned Work Center</label>
                    <select class="form-select" id="woWorkCenter">
                        <option value="">Auto-assign (Recommended)</option>
                        <option value="PR-001">PR-001 - Prusa MK4 #1</option>
                        <option value="PR-002">PR-002 - Prusa MK4 #2</option>
                        <option value="BA-001">BA-001 - Bambu A1</option>
                        <option value="EN-001">EN-001 - Ender 3 S1</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="woNotes" placeholder="Optional notes for this work order..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('workOrderModal')">Cancel</button>
            <button class="btn btn-primary" onclick="submitWorkOrder()">
                <span>‚úì</span> Create Work Order
            </button>
        </div>
    </div>
</div>

<!-- Downtime Modal -->
<div class="modal-overlay" id="downtimeModal">
    <div class="modal">
        <div class="modal-header">
            <h3><span>‚è∏Ô∏è</span> Log Downtime</h3>
            <button class="modal-close" onclick="closeModal('downtimeModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="downtimeForm">
                <div class="form-group">
                    <label class="form-label">Work Center</label>
                    <select class="form-select" id="dtWorkCenter" required>
                        <option value="">Select Work Center...</option>
                        <option value="PR-001">PR-001 - Prusa MK4 #1</option>
                        <option value="PR-002">PR-002 - Prusa MK4 #2</option>
                        <option value="PR-003">PR-003 - Prusa MK4 #3</option>
                        <option value="BA-001">BA-001 - Bambu A1</option>
                        <option value="BA-002">BA-002 - Bambu X1C</option>
                        <option value="EN-001">EN-001 - Ender 3 S1</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Downtime Category</label>
                    <select class="form-select" id="dtCategory" required>
                        <option value="">Select Category...</option>
                        <option value="breakdown">Equipment Breakdown</option>
                        <option value="changeover">Changeover/Setup</option>
                        <option value="material">Material Shortage</option>
                        <option value="quality">Quality Issue</option>
                        <option value="maintenance">Planned Maintenance</option>
                        <option value="operator">Operator Unavailable</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Start Time</label>
                        <input type="datetime-local" class="form-input" id="dtStartTime" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Time (leave blank if ongoing)</label>
                        <input type="datetime-local" class="form-input" id="dtEndTime">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="dtDescription" placeholder="Describe the downtime event..." required></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('downtimeModal')">Cancel</button>
            <button class="btn btn-danger" onclick="submitDowntime()">
                <span>‚è∏Ô∏è</span> Log Downtime
            </button>
        </div>
    </div>
</div>

<!-- Quality Hold Modal -->
<div class="modal-overlay" id="qualityHoldModal">
    <div class="modal">
        <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
            <h3><span>üõë</span> Quality Hold</h3>
            <button class="modal-close" onclick="closeModal('qualityHoldModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 10px; padding: 16px; margin-bottom: 20px;">
                <strong style="color: #ef4444;">‚ö†Ô∏è Warning:</strong>
                <p style="margin: 8px 0 0 0; font-size: 0.9rem; color: var(--text-secondary);">
                    Placing a quality hold will stop production on the selected work center and flag all parts for inspection.
                </p>
            </div>
            <form id="qualityHoldForm">
                <div class="form-group">
                    <label class="form-label">Work Center</label>
                    <select class="form-select" id="qhWorkCenter" required>
                        <option value="">Select Work Center...</option>
                        <option value="PR-001">PR-001 - Prusa MK4 #1</option>
                        <option value="PR-002">PR-002 - Prusa MK4 #2</option>
                        <option value="BA-001">BA-001 - Bambu A1</option>
                        <option value="EN-001">EN-001 - Ender 3 S1</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Hold Reason</label>
                    <select class="form-select" id="qhReason" required>
                        <option value="">Select Reason...</option>
                        <option value="dimensional">Dimensional Out of Spec</option>
                        <option value="surface">Surface Defect</option>
                        <option value="material">Material Issue</option>
                        <option value="process">Process Deviation</option>
                        <option value="customer">Customer Complaint</option>
                        <option value="audit">Audit Finding</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Affected Part Range (Start - End)</label>
                    <div class="form-row">
                        <input type="number" class="form-input" id="qhPartStart" placeholder="From Part #">
                        <input type="number" class="form-input" id="qhPartEnd" placeholder="To Part #">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="qhDescription" placeholder="Describe the quality issue in detail..." required></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('qualityHoldModal')">Cancel</button>
            <button class="btn btn-danger" onclick="submitQualityHold()">
                <span>üõë</span> Place Quality Hold
            </button>
        </div>
    </div>
</div>

<!-- Work Center Detail Modal -->
<div class="modal-overlay" id="workCenterDetailModal">
    <div class="modal" style="max-width: 800px;">
        <div class="modal-header">
            <h3><span>üñ®Ô∏è</span> <span id="wcDetailTitle">Work Center Details</span></h3>
            <button class="modal-close" onclick="closeModal('workCenterDetailModal')">&times;</button>
        </div>
        <div class="modal-body" id="wcDetailBody">
            <!-- Dynamic content -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('workCenterDetailModal')">Close</button>
            <button class="btn btn-primary" onclick="viewWorkCenterHistory()">
                <span>üìä</span> View History
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const REFRESH_INTERVAL = 10000; // 10 seconds
    const MES_API_BASE = '/api/v5/manufacturing';
    let dataMode = 'simulation'; // 'live' or 'simulation'

    // ============================================
    // Pattern-Based Simulation (NOT Random)
    // Realistic patterns based on shift schedules
    // ============================================
    const MESPatterns = {
        // Get current shift (6am-2pm = day, 2pm-10pm = swing, 10pm-6am = night)
        getCurrentShift() {
            const hour = new Date().getHours();
            if (hour >= 6 && hour < 14) return 'day';
            if (hour >= 14 && hour < 22) return 'swing';
            return 'night';
        },

        // Shift-based OEE patterns
        getShiftOEEBonus() {
            const shift = this.getCurrentShift();
            // Day shift typically has best OEE due to more staff, swing is slightly lower, night lowest
            return { day: 5, swing: 2, night: -1 }[shift];
        },

        // Pattern-based OEE for a work center (deterministic based on time)
        getWorkCenterOEE(baseOEE, wcCode) {
            const now = new Date();
            const hourFraction = now.getHours() + now.getMinutes() / 60;
            const shiftBonus = this.getShiftOEEBonus();
            // Each work center has a unique phase offset based on its code
            const phaseOffset = wcCode.charCodeAt(wcCode.length - 1) * 0.5;
            // Sinusoidal variation ¬±2% over 4-hour cycle
            const variation = Math.sin((hourFraction + phaseOffset) * Math.PI / 2) * 2;
            return Math.max(70, Math.min(99, baseOEE + shiftBonus + variation));
        },

        // Pattern-based progress (linear advancement with time)
        getProgress(wcCode, startProgress) {
            const now = new Date();
            const secondsInHour = now.getMinutes() * 60 + now.getSeconds();
            // Progress advances ~0.5% per minute when running
            const advancement = (secondsInHour / 120) % 15; // 0-15% cycle every 30 min
            return Math.min(100, startProgress + advancement);
        },

        // Generate realistic sensor data (temperature patterns)
        getSensorData(sensorType, wcCode) {
            const now = new Date();
            const secondFraction = now.getSeconds() / 60;
            const phaseOffset = wcCode.charCodeAt(wcCode.length - 1) * 0.1;

            if (sensorType === 'nozzle') {
                // Nozzle temp: 210¬∞C ¬±3¬∞C with slow oscillation
                return 210 + Math.sin((secondFraction + phaseOffset) * Math.PI * 2) * 3;
            } else if (sensorType === 'bed') {
                // Bed temp: 60¬∞C ¬±2¬∞C with slower oscillation
                return 60 + Math.sin((secondFraction + phaseOffset) * Math.PI) * 2;
            }
            return 0;
        },

        // Generate work center base data
        generateWorkCentersBase() {
            return [
                { code: 'PR-001', name: 'Prusa MK4 #1', type: '3D Printer', baseStatus: 'running', baseOEE: 90, baseProgress: 78, currentJob: 'WO-2024-1234' },
                { code: 'PR-002', name: 'Prusa MK4 #2', type: '3D Printer', baseStatus: 'running', baseOEE: 86, baseProgress: 45, currentJob: 'WO-2024-1235' },
                { code: 'PR-003', name: 'Prusa MK4 #3', type: '3D Printer', baseStatus: 'idle', baseOEE: 83, baseProgress: 0, currentJob: null },
                { code: 'BA-001', name: 'Bambu A1', type: '3D Printer', baseStatus: 'running', baseOEE: 92, baseProgress: 92, currentJob: 'WO-2024-1236' },
                { code: 'BA-002', name: 'Bambu X1C', type: '3D Printer', baseStatus: 'maintenance', baseOEE: 0, baseProgress: 0, currentJob: null },
                { code: 'EN-001', name: 'Ender 3 S1', type: '3D Printer', baseStatus: 'running', baseOEE: 80, baseProgress: 33, currentJob: 'WO-2024-1237' },
                { code: 'QC-001', name: 'Vision QC', type: 'Quality', baseStatus: 'running', baseOEE: 97, baseProgress: 0, currentJob: null },
                { code: 'AS-001', name: 'Assembly 1', type: 'Assembly', baseStatus: 'running', baseOEE: 93, baseProgress: 67, currentJob: 'WO-2024-1238' },
            ];
        },

        // Get current work centers with pattern-based values
        getWorkCenters() {
            const base = this.generateWorkCentersBase();
            return base.map(wc => ({
                code: wc.code,
                name: wc.name,
                type: wc.type,
                status: wc.baseStatus,
                oee: Math.round(wc.baseStatus === 'running' ? this.getWorkCenterOEE(wc.baseOEE, wc.code) : wc.baseOEE),
                progress: Math.round(wc.baseStatus === 'running' && wc.baseProgress > 0
                    ? this.getProgress(wc.code, wc.baseProgress)
                    : wc.baseProgress),
                currentJob: wc.currentJob
            }));
        }
    };

    // State managed by API or patterns
    let workCentersData = MESPatterns.getWorkCenters();

    let workOrdersData = [
        { id: 'WO-2024-1234', part: 'LEGO 3001 (2x4 Brick)', quantity: 500, completed: 390, priority: 'high', status: 'in-progress', due: '14:30' },
        { id: 'WO-2024-1235', part: 'LEGO 3003 (2x2 Brick)', quantity: 1000, completed: 450, priority: 'medium', status: 'in-progress', due: '16:00' },
        { id: 'WO-2024-1236', part: 'LEGO 3020 (2x4 Plate)', quantity: 250, completed: 230, priority: 'high', status: 'in-progress', due: '13:00' },
        { id: 'WO-2024-1237', part: 'LEGO 3004 (1x2 Brick)', quantity: 200, completed: 66, priority: 'low', status: 'in-progress', due: '17:30' },
        { id: 'WO-2024-1238', part: 'LEGO 3010 (1x4 Brick)', quantity: 150, completed: 100, priority: 'medium', status: 'in-progress', due: '15:00' },
    ];

    let alertsData = [
        { type: 'critical', title: 'Machine Down', message: 'BA-002 scheduled maintenance in progress', time: '5 min ago', icon: 'üî¥' },
        { type: 'warning', title: 'Quality Alert', message: 'PR-003 dimensional variation detected', time: '12 min ago', icon: '‚ö†Ô∏è' },
        { type: 'info', title: 'Order Complete', message: 'WO-2024-1230 completed successfully', time: '25 min ago', icon: '‚ÑπÔ∏è' },
    ];

    // ============================================
    // Data Mode Indicator
    // ============================================
    function updateDataModeIndicator(mode) {
        const indicator = document.getElementById('dataModeIndicator');
        const icon = document.getElementById('dataModeIcon');
        const text = document.getElementById('dataModeText');

        if (mode === 'live') {
            indicator.style.background = 'rgba(34, 197, 94, 0.15)';
            indicator.style.color = '#22c55e';
            icon.textContent = '‚óè';
            text.textContent = 'LIVE';
        } else {
            indicator.style.background = 'rgba(245, 158, 11, 0.15)';
            indicator.style.color = '#f59e0b';
            icon.textContent = '‚óê';
            text.textContent = 'SIMULATION';
        }
    }

    // ============================================
    // API Fetch with Pattern Fallback
    // ============================================
    async function fetchMESData() {
        try {
            const response = await fetch(`${MES_API_BASE}/work-centers`);
            if (response.ok) {
                const data = await response.json();
                if (data.work_centers && data.work_centers.length > 0) {
                    workCentersData = data.work_centers;
                    dataMode = data.data_mode || 'live';
                    updateDataModeIndicator(dataMode);
                    return true;
                }
            }
        } catch (error) {
            console.log('API unavailable, using pattern-based simulation');
        }

        // Fallback to pattern-based simulation
        workCentersData = MESPatterns.getWorkCenters();
        dataMode = 'simulation';
        updateDataModeIndicator(dataMode);
        return false;
    }

    async function fetchWorkOrders() {
        try {
            const response = await fetch(`${MES_API_BASE}/work-orders?status=active`);
            if (response.ok) {
                const data = await response.json();
                if (data.work_orders && data.work_orders.length > 0) {
                    workOrdersData = data.work_orders;
                    return true;
                }
            }
        } catch (error) {
            console.log('Work orders API unavailable, using default data');
        }
        return false;
    }

    async function fetchAlerts() {
        try {
            const response = await fetch(`${MES_API_BASE}/alerts?limit=5`);
            if (response.ok) {
                const data = await response.json();
                if (data.alerts && data.alerts.length > 0) {
                    alertsData = data.alerts;
                    return true;
                }
            }
        } catch (error) {
            console.log('Alerts API unavailable, using default data');
        }
        return false;
    }

    function renderWorkCenters() {
        const grid = document.getElementById('workCentersGrid');
        grid.innerHTML = workCentersData.map(wc => `
            <div class="work-center-tile ${wc.status}">
                <div class="wc-header">
                    <div>
                        <div class="wc-name">${wc.code}</div>
                        <div class="wc-type">${wc.type}</div>
                    </div>
                    <div class="wc-status-indicator ${wc.status}"></div>
                </div>
                <div class="wc-metrics">
                    <div class="wc-metric">
                        <div class="wc-metric-value">${wc.oee}%</div>
                        <div class="wc-metric-label">OEE</div>
                    </div>
                    <div class="wc-metric">
                        <div class="wc-metric-value">${wc.status === 'running' ? 'Active' : wc.status.charAt(0).toUpperCase() + wc.status.slice(1)}</div>
                        <div class="wc-metric-label">Status</div>
                    </div>
                </div>
                ${wc.progress > 0 ? `
                    <div class="wc-progress">
                        <div class="wc-progress-label">
                            <span>Current Job</span>
                            <span>${wc.progress}%</span>
                        </div>
                        <div class="wc-progress-bar">
                            <div class="wc-progress-fill" style="width: ${wc.progress}%"></div>
                        </div>
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    function renderWorkOrders() {
        const tbody = document.getElementById('workOrdersTable');
        tbody.innerHTML = workOrdersData.map(wo => {
            const progress = Math.round((wo.completed / wo.quantity) * 100);
            return `
                <tr>
                    <td><span class="order-id">${wo.id}</span></td>
                    <td>${wo.part}</td>
                    <td>${wo.completed} / ${wo.quantity}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="flex: 1; height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden;">
                                <div style="width: ${progress}%; height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa);"></div>
                            </div>
                            <span style="font-size: 0.8rem; font-weight: 600;">${progress}%</span>
                        </div>
                    </td>
                    <td><span class="priority-badge ${wo.priority}">${wo.priority}</span></td>
                    <td><span class="status-chip ${wo.status}">${wo.status.replace('-', ' ')}</span></td>
                    <td>${wo.due}</td>
                </tr>
            `;
        }).join('');
    }

    function renderAndonBoard() {
        const board = document.getElementById('andonBoard');
        board.innerHTML = workCentersData.map(wc => {
            let color = 'gray';
            if (wc.status === 'running') color = wc.oee >= 85 ? 'green' : wc.oee >= 70 ? 'yellow' : 'red';
            else if (wc.status === 'idle') color = 'yellow';
            else if (wc.status === 'down') color = 'red';
            else if (wc.status === 'maintenance') color = 'blue';

            return `
                <div class="andon-cell ${color}" title="${wc.name}">
                    <div class="andon-cell-name">${wc.code}</div>
                    <div class="andon-cell-oee">${wc.oee}%</div>
                </div>
            `;
        }).join('');
    }

    function renderAlerts() {
        const panel = document.getElementById('alertsPanel');
        panel.innerHTML = alertsData.map(alert => `
            <div class="alert-item ${alert.type}">
                <div class="alert-icon">${alert.icon}</div>
                <div class="alert-content">
                    <div class="alert-title">${alert.title}</div>
                    <div class="alert-message">${alert.message}</div>
                    <div class="alert-time">${alert.time}</div>
                </div>
            </div>
        `).join('');
    }

    // ============================================
    // WebSocket Real-Time Connection
    // ============================================
    let ws = null;
    let wsReconnectAttempts = 0;
    const WS_MAX_RECONNECT_ATTEMPTS = 5;

    function initWebSocket() {
        const wsUrl = `ws://${window.location.host}/ws/mes`;
        updateWsStatus('connecting');

        try {
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                wsReconnectAttempts = 0;
                updateWsStatus('connected');
                showToast('Real-time connection established', 'success');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateWsStatus('disconnected');
                attemptReconnect();
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateWsStatus('disconnected');
            };
        } catch (error) {
            console.error('WebSocket initialization failed:', error);
            updateWsStatus('disconnected');
            // Fallback to polling
            showToast('Using polling mode (WebSocket unavailable)', 'info');
        }
    }

    function updateWsStatus(status) {
        const wsStatusEl = document.getElementById('wsStatus');
        wsStatusEl.className = `ws-status ${status}`;
        const statusText = {
            'connected': 'üü¢ Live',
            'disconnected': 'üî¥ Offline',
            'connecting': 'üü° Connecting...'
        };
        wsStatusEl.innerHTML = `<div class="status-pulse"></div><span>${statusText[status]}</span>`;
    }

    function attemptReconnect() {
        if (wsReconnectAttempts < WS_MAX_RECONNECT_ATTEMPTS) {
            wsReconnectAttempts++;
            setTimeout(() => {
                console.log(`Reconnecting... (attempt ${wsReconnectAttempts})`);
                initWebSocket();
            }, 3000 * wsReconnectAttempts);
        }
    }

    function handleWebSocketMessage(data) {
        switch (data.type) {
            case 'kpi_update':
                updateKPIs(data.payload);
                break;
            case 'work_center_update':
                updateWorkCenter(data.payload);
                break;
            case 'work_order_update':
                updateWorkOrder(data.payload);
                break;
            case 'alert':
                addAlert(data.payload);
                break;
            case 'production_event':
                handleProductionEvent(data.payload);
                break;
        }
    }

    function updateKPIs(kpis) {
        if (kpis.oee) {
            const el = document.getElementById('kpi-oee');
            el.textContent = kpis.oee + '%';
            el.classList.add('data-updated');
            setTimeout(() => el.classList.remove('data-updated'), 1000);
        }
        // Similar for other KPIs...
    }

    // ============================================
    // Toast Notifications
    // ============================================
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
            <span>${message}</span>
            <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
        `;
        container.appendChild(toast);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'toastSlideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }

    // ============================================
    // Modal Functions
    // ============================================
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
        document.body.style.overflow = '';
    }

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
    });

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = '';
        }
    });

    // ============================================
    // Quick Action Functions
    // ============================================
    function createWorkOrder() {
        // Set default due date to 8 hours from now
        const dueDate = new Date();
        dueDate.setHours(dueDate.getHours() + 8);
        document.getElementById('woDueDate').value = dueDate.toISOString().slice(0, 16);
        openModal('workOrderModal');
    }

    function logDowntime() {
        // Set default start time to now
        document.getElementById('dtStartTime').value = new Date().toISOString().slice(0, 16);
        openModal('downtimeModal');
    }

    function qualityHold() {
        openModal('qualityHoldModal');
    }

    function openReports() {
        window.location.href = '/manufacturing/reports';
    }

    // ============================================
    // Form Submissions
    // ============================================
    async function submitWorkOrder() {
        const formData = {
            partNumber: document.getElementById('woPartNumber').value,
            quantity: parseInt(document.getElementById('woQuantity').value),
            priority: document.getElementById('woPriority').value,
            dueDate: document.getElementById('woDueDate').value,
            workCenter: document.getElementById('woWorkCenter').value,
            notes: document.getElementById('woNotes').value
        };

        if (!formData.partNumber || !formData.quantity || !formData.dueDate) {
            showToast('Please fill in all required fields', 'error');
            return;
        }

        try {
            // Simulate API call
            showToast('Creating work order...', 'info');

            // In production: await fetch('/api/v5/manufacturing/work-orders', { method: 'POST', body: JSON.stringify(formData) });
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Generate deterministic ID based on timestamp
            const woSequence = Date.now() % 9000 + 1000;
            const newWO = {
                id: `WO-2024-${woSequence}`,
                part: document.querySelector(`#woPartNumber option[value="${formData.partNumber}"]`).textContent,
                quantity: formData.quantity,
                completed: 0,
                priority: formData.priority,
                status: 'pending',
                due: new Date(formData.dueDate).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
            };

            workOrdersData.unshift(newWO);
            renderWorkOrders();

            closeModal('workOrderModal');
            document.getElementById('workOrderForm').reset();
            showToast(`Work Order ${newWO.id} created successfully!`, 'success');
        } catch (error) {
            showToast('Failed to create work order', 'error');
        }
    }

    async function submitDowntime() {
        const formData = {
            workCenter: document.getElementById('dtWorkCenter').value,
            category: document.getElementById('dtCategory').value,
            startTime: document.getElementById('dtStartTime').value,
            endTime: document.getElementById('dtEndTime').value,
            description: document.getElementById('dtDescription').value
        };

        if (!formData.workCenter || !formData.category || !formData.startTime || !formData.description) {
            showToast('Please fill in all required fields', 'error');
            return;
        }

        try {
            showToast('Logging downtime...', 'info');
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Update work center status
            const wc = workCentersData.find(w => w.code === formData.workCenter);
            if (wc) {
                wc.status = 'down';
                wc.oee = 0;
                renderWorkCenters();
                renderAndonBoard();
            }

            closeModal('downtimeModal');
            document.getElementById('downtimeForm').reset();
            showToast(`Downtime logged for ${formData.workCenter}`, 'warning');
        } catch (error) {
            showToast('Failed to log downtime', 'error');
        }
    }

    async function submitQualityHold() {
        const formData = {
            workCenter: document.getElementById('qhWorkCenter').value,
            reason: document.getElementById('qhReason').value,
            partStart: document.getElementById('qhPartStart').value,
            partEnd: document.getElementById('qhPartEnd').value,
            description: document.getElementById('qhDescription').value
        };

        if (!formData.workCenter || !formData.reason || !formData.description) {
            showToast('Please fill in all required fields', 'error');
            return;
        }

        try {
            showToast('Placing quality hold...', 'info');
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Add critical alert
            alertsData.unshift({
                type: 'critical',
                title: 'Quality Hold Placed',
                message: `${formData.workCenter} - ${document.querySelector(`#qhReason option[value="${formData.reason}"]`).textContent}`,
                time: 'Just now',
                icon: 'üõë'
            });
            renderAlerts();

            closeModal('qualityHoldModal');
            document.getElementById('qualityHoldForm').reset();
            showToast(`Quality hold placed on ${formData.workCenter}`, 'error');
        } catch (error) {
            showToast('Failed to place quality hold', 'error');
        }
    }

    // ============================================
    // Work Center Detail View
    // ============================================
    function showWorkCenterDetail(wcCode) {
        const wc = workCentersData.find(w => w.code === wcCode);
        if (!wc) return;

        document.getElementById('wcDetailTitle').textContent = `${wc.code} - ${wc.name}`;

        const body = document.getElementById('wcDetailBody');
        body.innerHTML = `
            <div class="wc-detail-grid">
                <div class="wc-detail-card">
                    <div class="wc-detail-value">${wc.oee}%</div>
                    <div class="wc-detail-label">Current OEE</div>
                </div>
                <div class="wc-detail-card">
                    <div class="wc-detail-value">${wc.status.charAt(0).toUpperCase() + wc.status.slice(1)}</div>
                    <div class="wc-detail-label">Status</div>
                </div>
                <div class="wc-detail-card">
                    <div class="wc-detail-value">${wc.progress}%</div>
                    <div class="wc-detail-label">Job Progress</div>
                </div>
            </div>

            <h4 style="margin-bottom: 12px; color: var(--text-primary);">üìä Live Sensor Data</h4>
            <div class="sensor-chart">
                <canvas id="sensorChart"></canvas>
            </div>

            <h4 style="margin: 20px 0 12px 0; color: var(--text-primary);">üìú Recent Activity</h4>
            <div class="timeline">
                <div class="timeline-item success">
                    <div class="timeline-time">2 min ago</div>
                    <div class="timeline-content">Part #${100 + Math.floor(Date.now() / 60000) % 900} completed - Quality: Pass</div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-time">5 min ago</div>
                    <div class="timeline-content">Layer 45/120 - Printing in progress</div>
                </div>
                <div class="timeline-item warning">
                    <div class="timeline-time">15 min ago</div>
                    <div class="timeline-content">Filament low warning - 15% remaining</div>
                </div>
                <div class="timeline-item success">
                    <div class="timeline-time">32 min ago</div>
                    <div class="timeline-content">Job ${wc.currentJob || 'WO-2024-XXXX'} started</div>
                </div>
            </div>
        `;

        openModal('workCenterDetailModal');

        // Initialize sensor chart with pattern-based data
        setTimeout(() => {
            const ctx = document.getElementById('sensorChart');
            if (ctx) {
                // Generate pattern-based temperature history
                const now = new Date();
                const baseSecond = now.getSeconds();
                const phaseOffset = wcCode.charCodeAt(wcCode.length - 1) * 0.1;

                const nozzleData = Array.from({length: 20}, (_, i) => {
                    const t = (baseSecond - (19 - i)) / 60;
                    return 210 + Math.sin((t + phaseOffset) * Math.PI * 2) * 3;
                });

                const bedData = Array.from({length: 20}, (_, i) => {
                    const t = (baseSecond - (19 - i)) / 60;
                    return 60 + Math.sin((t + phaseOffset) * Math.PI) * 2;
                });

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 20}, (_, i) => `${20-i}s`),
                        datasets: [{
                            label: 'Nozzle Temp (¬∞C)',
                            data: nozzleData,
                            borderColor: '#ef4444',
                            tension: 0.4,
                            fill: false
                        }, {
                            label: 'Bed Temp (¬∞C)',
                            data: bedData,
                            borderColor: '#f59e0b',
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#94a3b8' } } },
                        scales: {
                            x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                            y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }, 100);
    }

    function viewWorkCenterHistory() {
        closeModal('workCenterDetailModal');
        showToast('Opening work center history...', 'info');
        // In production: navigate to history page
    }

    // ============================================
    // Make work center tiles clickable
    // ============================================
    function renderWorkCenters() {
        const grid = document.getElementById('workCentersGrid');
        grid.innerHTML = workCentersData.map(wc => `
            <div class="work-center-tile ${wc.status}" onclick="showWorkCenterDetail('${wc.code}')">
                <div class="wc-header">
                    <div>
                        <div class="wc-name">${wc.code}</div>
                        <div class="wc-type">${wc.type}</div>
                    </div>
                    <div class="wc-status-indicator ${wc.status}"></div>
                </div>
                <div class="wc-metrics">
                    <div class="wc-metric">
                        <div class="wc-metric-value">${wc.oee}%</div>
                        <div class="wc-metric-label">OEE</div>
                    </div>
                    <div class="wc-metric">
                        <div class="wc-metric-value">${wc.status === 'running' ? 'Active' : wc.status.charAt(0).toUpperCase() + wc.status.slice(1)}</div>
                        <div class="wc-metric-label">Status</div>
                    </div>
                </div>
                ${wc.progress > 0 ? `
                    <div class="wc-progress">
                        <div class="wc-progress-label">
                            <span>Current Job</span>
                            <span>${wc.progress}%</span>
                        </div>
                        <div class="wc-progress-bar">
                            <div class="wc-progress-fill" style="width: ${wc.progress}%"></div>
                        </div>
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    // ============================================
    // Initialize
    // ============================================
    document.addEventListener('DOMContentLoaded', async () => {
        // Initialize with pattern-based data first (fast)
        renderWorkCenters();
        renderWorkOrders();
        renderAndonBoard();
        renderAlerts();

        // Initialize WebSocket connection
        initWebSocket();

        // Then fetch from API (may update to live data)
        await fetchMESData();
        await fetchWorkOrders();
        await fetchAlerts();

        // Re-render with fetched/pattern data
        renderWorkCenters();
        renderWorkOrders();
        renderAlerts();

        // Pattern-based updates (API fetch with pattern fallback)
        setInterval(async () => {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                await fetchMESData();
                renderWorkCenters();
                renderAndonBoard();
            }
        }, 5000);

        // Slower interval for work orders and alerts
        setInterval(async () => {
            await fetchWorkOrders();
            await fetchAlerts();
            renderWorkOrders();
            renderAlerts();
        }, REFRESH_INTERVAL);
    });
</script>
{% endblock %}
