{% extends "base.html" %}

{% block title %}Carbon & Sustainability - LEGO MCP v6.0{% endblock %}

{% block styles %}
<style>
    /* =====================================================
       SUSTAINABILITY & CARBON DASHBOARD - WORLD-CLASS HMI
       LEGO MCP v6.0 - GHG Protocol & Science-Based Targets
       ===================================================== */

    :root {
        --su-primary: #10b981;
        --su-secondary: #06b6d4;
        --su-accent: #8b5cf6;
        --su-warning: #f59e0b;
        --su-danger: #ef4444;
        --su-info: #3b82f6;
        --su-dark: #0f172a;
        --su-darker: #020617;
        --su-card: #1e293b;
        --su-card-hover: #334155;
        --su-border: #334155;
        --su-text: #f8fafc;
        --su-text-muted: #94a3b8;
        --su-gradient-green: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --su-gradient-blue: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        --su-gradient-purple: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        --su-gradient-orange: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --su-gradient-red: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        --su-scope1: #3b82f6;
        --su-scope2: #10b981;
        --su-scope3: #f59e0b;
    }

    .sustainability-container {
        padding: 1.5rem;
        background: var(--su-darker);
        min-height: calc(100vh - 60px);
    }

    /* Header */
    .sustainability-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .header-left h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--su-text);
        margin: 0 0 0.25rem 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .header-left h1::before {
        content: '';
        display: inline-block;
        width: 4px;
        height: 28px;
        background: var(--su-gradient-green);
        border-radius: 2px;
    }

    .header-subtitle {
        color: var(--su-text-muted);
        font-size: 0.9rem;
        margin: 0;
    }

    .header-right {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    /* Connection Status */
    .connection-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--su-card);
        border-radius: 8px;
        font-size: 0.85rem;
        border: 1px solid var(--su-border);
    }

    .connection-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--su-danger);
        animation: pulse-dot 2s infinite;
    }

    .connection-dot.connected {
        background: var(--su-primary);
    }

    @keyframes pulse-dot {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.1); }
    }

    /* Action Buttons */
    .btn-group {
        display: flex;
        gap: 0.5rem;
    }

    .btn {
        padding: 0.6rem 1.25rem;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border: none;
    }

    .btn-primary {
        background: var(--su-gradient-green);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-secondary {
        background: var(--su-card);
        color: var(--su-text);
        border: 1px solid var(--su-border);
    }

    .btn-secondary:hover {
        background: var(--su-card-hover);
    }

    /* Carbon Target Banner */
    .sbti-banner {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
        border: 1px solid var(--su-primary);
        border-radius: 12px;
        padding: 1.25rem 1.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .sbti-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .sbti-badge {
        width: 48px;
        height: 48px;
        background: var(--su-gradient-green);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .sbti-details h3 {
        margin: 0;
        font-size: 1rem;
        color: var(--su-text);
    }

    .sbti-details p {
        margin: 0.25rem 0 0;
        font-size: 0.85rem;
        color: var(--su-text-muted);
    }

    .sbti-progress {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .sbti-metric {
        text-align: center;
    }

    .sbti-metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--su-primary);
        font-family: 'JetBrains Mono', monospace;
    }

    .sbti-metric-label {
        font-size: 0.75rem;
        color: var(--su-text-muted);
    }

    /* KPI Cards */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 1200px) {
        .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
        .kpi-grid { grid-template-columns: 1fr; }
    }

    .kpi-card {
        background: var(--su-card);
        border-radius: 12px;
        padding: 1.25rem;
        border: 1px solid var(--su-border);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
    }

    .kpi-card.green::before { background: var(--su-gradient-green); }
    .kpi-card.blue::before { background: var(--su-gradient-blue); }
    .kpi-card.purple::before { background: var(--su-gradient-purple); }
    .kpi-card.orange::before { background: var(--su-gradient-orange); }

    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .kpi-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .kpi-title {
        font-size: 0.8rem;
        color: var(--su-text-muted);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .kpi-trend {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-weight: 600;
    }

    .kpi-trend.positive {
        background: rgba(16, 185, 129, 0.2);
        color: var(--su-primary);
    }

    .kpi-trend.negative {
        background: rgba(239, 68, 68, 0.2);
        color: var(--su-danger);
    }

    .kpi-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--su-text);
        font-family: 'JetBrains Mono', monospace;
        margin-bottom: 0.25rem;
    }

    .kpi-unit {
        font-size: 0.9rem;
        color: var(--su-text-muted);
        font-weight: 400;
    }

    .kpi-subtitle {
        font-size: 0.75rem;
        color: var(--su-text-muted);
    }

    .kpi-sparkline {
        height: 30px;
        margin-top: 0.5rem;
    }

    /* Main Grid */
    .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 1200px) {
        .main-grid { grid-template-columns: 1fr; }
    }

    /* Card Styles */
    .card {
        background: var(--su-card);
        border-radius: 12px;
        border: 1px solid var(--su-border);
        overflow: hidden;
    }

    .card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--su-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--su-text);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-body {
        padding: 1.25rem;
    }

    /* Scope Breakdown */
    .scope-visualization {
        display: flex;
        gap: 2rem;
        align-items: center;
    }

    @media (max-width: 900px) {
        .scope-visualization { flex-direction: column; }
    }

    .scope-donut {
        flex: 0 0 200px;
        height: 200px;
    }

    .scope-details {
        flex: 1;
    }

    .scope-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: var(--su-darker);
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border-left: 4px solid;
    }

    .scope-item.scope-1 { border-left-color: var(--su-scope1); }
    .scope-item.scope-2 { border-left-color: var(--su-scope2); }
    .scope-item.scope-3 { border-left-color: var(--su-scope3); }

    .scope-item-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .scope-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .scope-item.scope-1 .scope-icon { background: rgba(59, 130, 246, 0.2); }
    .scope-item.scope-2 .scope-icon { background: rgba(16, 185, 129, 0.2); }
    .scope-item.scope-3 .scope-icon { background: rgba(245, 158, 11, 0.2); }

    .scope-name {
        font-weight: 600;
        color: var(--su-text);
        margin-bottom: 0.25rem;
    }

    .scope-description {
        font-size: 0.8rem;
        color: var(--su-text-muted);
    }

    .scope-values {
        text-align: right;
    }

    .scope-amount {
        font-size: 1.25rem;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        color: var(--su-text);
    }

    .scope-percent {
        font-size: 0.8rem;
        color: var(--su-text-muted);
    }

    /* Grid Carbon Intensity */
    .grid-intensity {
        text-align: center;
        padding: 1rem;
    }

    .intensity-gauge {
        position: relative;
        width: 180px;
        height: 100px;
        margin: 0 auto 1rem;
    }

    .intensity-value {
        font-size: 2.5rem;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        color: var(--su-primary);
    }

    .intensity-unit {
        font-size: 0.85rem;
        color: var(--su-text-muted);
        display: block;
    }

    .intensity-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(16, 185, 129, 0.2);
        border-radius: 20px;
        font-size: 0.85rem;
        color: var(--su-primary);
        font-weight: 600;
        margin-top: 0.5rem;
    }

    .intensity-status.high {
        background: rgba(239, 68, 68, 0.2);
        color: var(--su-danger);
    }

    .intensity-status.medium {
        background: rgba(245, 158, 11, 0.2);
        color: var(--su-warning);
    }

    .grid-forecast {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--su-border);
    }

    .forecast-title {
        font-size: 0.8rem;
        color: var(--su-text-muted);
        margin-bottom: 0.5rem;
    }

    .forecast-items {
        display: flex;
        justify-content: space-around;
    }

    .forecast-item {
        text-align: center;
    }

    .forecast-time {
        font-size: 0.75rem;
        color: var(--su-text-muted);
    }

    .forecast-value {
        font-size: 1rem;
        font-weight: 600;
        font-family: 'JetBrains Mono', monospace;
    }

    .forecast-value.low { color: var(--su-primary); }
    .forecast-value.medium { color: var(--su-warning); }
    .forecast-value.high { color: var(--su-danger); }

    /* Secondary Grid */
    .secondary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 1200px) {
        .secondary-grid { grid-template-columns: 1fr; }
    }

    /* Energy Mix */
    .energy-mix-items {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .energy-item {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .energy-icon {
        font-size: 1.5rem;
    }

    .energy-info {
        flex: 1;
    }

    .energy-name {
        font-size: 0.9rem;
        color: var(--su-text);
        margin-bottom: 0.25rem;
    }

    .energy-bar {
        height: 6px;
        background: var(--su-darker);
        border-radius: 3px;
        overflow: hidden;
    }

    .energy-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .energy-fill.solar { background: var(--su-warning); }
    .energy-fill.wind { background: var(--su-secondary); }
    .energy-fill.grid { background: var(--su-text-muted); }
    .energy-fill.battery { background: var(--su-accent); }

    .energy-percent {
        font-size: 0.9rem;
        font-weight: 600;
        font-family: 'JetBrains Mono', monospace;
        color: var(--su-text);
        min-width: 50px;
        text-align: right;
    }

    /* Circular Economy */
    .circular-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .circular-metric {
        text-align: center;
        padding: 1rem;
        background: var(--su-darker);
        border-radius: 8px;
    }

    .circular-value {
        font-size: 1.5rem;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        color: var(--su-primary);
    }

    .circular-label {
        font-size: 0.75rem;
        color: var(--su-text-muted);
        margin-top: 0.25rem;
    }

    /* Material Footprint */
    .material-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .material-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        background: var(--su-darker);
        border-radius: 8px;
    }

    .material-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .material-icon {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        background: rgba(16, 185, 129, 0.2);
    }

    .material-name {
        font-size: 0.9rem;
        color: var(--su-text);
    }

    .material-footprint {
        font-size: 0.9rem;
        font-weight: 600;
        font-family: 'JetBrains Mono', monospace;
        color: var(--su-text);
    }

    /* Initiatives Table */
    .initiatives-table {
        width: 100%;
        border-collapse: collapse;
    }

    .initiatives-table th {
        text-align: left;
        padding: 1rem;
        font-size: 0.8rem;
        color: var(--su-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--su-border);
        font-weight: 600;
    }

    .initiatives-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--su-border);
        color: var(--su-text);
    }

    .initiatives-table tr:hover {
        background: var(--su-card-hover);
    }

    .initiative-name {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .initiative-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        background: rgba(16, 185, 129, 0.2);
    }

    .progress-cell {
        width: 150px;
    }

    .progress-bar {
        height: 8px;
        background: var(--su-darker);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.25rem;
    }

    .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .progress-fill.high { background: var(--su-primary); }
    .progress-fill.medium { background: var(--su-warning); }
    .progress-fill.low { background: var(--su-danger); }

    .progress-text {
        font-size: 0.75rem;
        color: var(--su-text-muted);
    }

    .status-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-badge.active {
        background: rgba(16, 185, 129, 0.2);
        color: var(--su-primary);
    }

    .status-badge.planned {
        background: rgba(59, 130, 246, 0.2);
        color: var(--su-info);
    }

    .status-badge.completed {
        background: rgba(139, 92, 246, 0.2);
        color: var(--su-accent);
    }

    .impact-value {
        font-family: 'JetBrains Mono', monospace;
        font-weight: 600;
    }

    .impact-value.positive { color: var(--su-primary); }

    /* Carbon Offsets */
    .offsets-summary {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .offset-stat {
        text-align: center;
        padding: 1rem;
        background: var(--su-darker);
        border-radius: 8px;
    }

    .offset-value {
        font-size: 1.5rem;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        color: var(--su-text);
    }

    .offset-label {
        font-size: 0.75rem;
        color: var(--su-text-muted);
    }

    .offset-projects {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .offset-project {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: var(--su-darker);
        border-radius: 8px;
    }

    .project-icon {
        font-size: 1.5rem;
    }

    .project-info {
        flex: 1;
    }

    .project-name {
        font-size: 0.9rem;
        color: var(--su-text);
        font-weight: 500;
    }

    .project-type {
        font-size: 0.75rem;
        color: var(--su-text-muted);
    }

    .project-amount {
        font-size: 0.9rem;
        font-weight: 600;
        font-family: 'JetBrains Mono', monospace;
        color: var(--su-primary);
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-width: 400px;
    }

    .toast {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 1rem;
        background: var(--su-card);
        border-radius: 10px;
        border: 1px solid var(--su-border);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .toast.hiding {
        animation: slideOut 0.3s ease forwards;
    }

    @keyframes slideOut {
        to { transform: translateX(100%); opacity: 0; }
    }

    .toast-icon {
        font-size: 1.25rem;
    }

    .toast.success .toast-icon { color: var(--su-primary); }
    .toast.error .toast-icon { color: var(--su-danger); }
    .toast.warning .toast-icon { color: var(--su-warning); }
    .toast.info .toast-icon { color: var(--su-info); }

    .toast-content { flex: 1; }

    .toast-title {
        font-weight: 600;
        color: var(--su-text);
        margin-bottom: 0.25rem;
    }

    .toast-message {
        font-size: 0.85rem;
        color: var(--su-text-muted);
    }

    .toast-close {
        background: none;
        border: none;
        color: var(--su-text-muted);
        cursor: pointer;
        font-size: 1rem;
    }

    /* Full Width */
    .full-width {
        margin-bottom: 1.5rem;
    }

    /* Green Scheduling Card */
    .green-scheduling {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(6, 182, 212, 0.05) 100%);
    }

    .scheduling-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }

    @media (max-width: 900px) {
        .scheduling-stats { grid-template-columns: repeat(2, 1fr); }
    }

    .scheduling-stat {
        text-align: center;
        padding: 1rem;
        background: var(--su-card);
        border-radius: 8px;
    }

    .scheduling-value {
        font-size: 1.5rem;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        color: var(--su-primary);
    }

    .scheduling-label {
        font-size: 0.75rem;
        color: var(--su-text-muted);
    }
</style>
{% endblock %}

{% block content %}
<div class="sustainability-container">
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Header -->
    <div class="sustainability-header">
        <div class="header-left">
            <h1>Carbon & Sustainability</h1>
            <p class="header-subtitle">GHG Protocol Scope 1/2/3 Emissions Tracking - Science-Based Targets Initiative (SBTi)</p>
        </div>
        <div class="header-right">
            <div class="connection-status" id="connectionStatus">
                <span class="connection-dot" id="connectionDot"></span>
                <span id="connectionText">Connecting...</span>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="refreshData()">
                    <span>üîÑ</span> Refresh
                </button>
                <button class="btn btn-primary" onclick="exportReport()">
                    <span>üìä</span> Export Report
                </button>
            </div>
        </div>
    </div>

    <!-- SBTi Target Banner -->
    <div class="sbti-banner">
        <div class="sbti-info">
            <div class="sbti-badge">üéØ</div>
            <div class="sbti-details">
                <h3>Science-Based Targets Initiative (SBTi) Commitment</h3>
                <p>50% absolute reduction in Scope 1 & 2 emissions by 2030 (vs 2020 baseline)</p>
            </div>
        </div>
        <div class="sbti-progress">
            <div class="sbti-metric">
                <div class="sbti-metric-value" id="sbtiProgress">34%</div>
                <div class="sbti-metric-label">Progress to 2030</div>
            </div>
            <div class="sbti-metric">
                <div class="sbti-metric-value" id="sbtiRemaining">823</div>
                <div class="sbti-metric-label">kg CO2e to target</div>
            </div>
            <div class="sbti-metric">
                <div class="sbti-metric-value" id="sbtiTrajectory">On Track</div>
                <div class="sbti-metric-label">Trajectory Status</div>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card green">
            <div class="kpi-header">
                <span class="kpi-title">Total Emissions (MTD)</span>
                <span class="kpi-trend positive" id="emissionsTrend">-12.3%</span>
            </div>
            <div class="kpi-value" id="kpiEmissions">1,247<span class="kpi-unit">kg CO2e</span></div>
            <div class="kpi-subtitle">Target: 1,400 kg | Budget remaining: 153 kg</div>
            <div class="kpi-sparkline" id="emissionsSparkline"></div>
        </div>

        <div class="kpi-card blue">
            <div class="kpi-header">
                <span class="kpi-title">Per-Unit Footprint</span>
                <span class="kpi-trend positive" id="perUnitTrend">-8.1%</span>
            </div>
            <div class="kpi-value" id="kpiPerUnit">0.065<span class="kpi-unit">kg CO2e</span></div>
            <div class="kpi-subtitle">Per brick | Industry avg: 0.12 kg</div>
            <div class="kpi-sparkline" id="perUnitSparkline"></div>
        </div>

        <div class="kpi-card purple">
            <div class="kpi-header">
                <span class="kpi-title">Energy Consumption</span>
                <span class="kpi-trend positive" id="energyTrend">-5.2%</span>
            </div>
            <div class="kpi-value" id="kpiEnergy">2,847<span class="kpi-unit">kWh</span></div>
            <div class="kpi-subtitle">Renewable: 42% | Grid: 58%</div>
            <div class="kpi-sparkline" id="energySparkline"></div>
        </div>

        <div class="kpi-card orange">
            <div class="kpi-header">
                <span class="kpi-title">Green Scheduling Savings</span>
                <span class="kpi-trend positive" id="savingsTrend">+23%</span>
            </div>
            <div class="kpi-value" id="kpiSavings">187<span class="kpi-unit">kg CO2e</span></div>
            <div class="kpi-subtitle">From AI-optimized scheduling</div>
            <div class="kpi-sparkline" id="savingsSparkline"></div>
        </div>
    </div>

    <!-- Main Grid: Emissions Trend + Grid Intensity -->
    <div class="main-grid">
        <!-- Emissions by Scope -->
        <div class="card">
            <div class="card-header">
                <h3><span>üìä</span> Emissions by Scope (GHG Protocol)</h3>
            </div>
            <div class="card-body">
                <div class="scope-visualization">
                    <div class="scope-donut" id="scopeDonut"></div>
                    <div class="scope-details">
                        <div class="scope-item scope-1">
                            <div class="scope-item-info">
                                <div class="scope-icon">üè≠</div>
                                <div>
                                    <div class="scope-name">Scope 1: Direct Emissions</div>
                                    <div class="scope-description">On-site fuel combustion, company vehicles</div>
                                </div>
                            </div>
                            <div class="scope-values">
                                <div class="scope-amount" id="scope1Amount">62 kg</div>
                                <div class="scope-percent">5%</div>
                            </div>
                        </div>
                        <div class="scope-item scope-2">
                            <div class="scope-item-info">
                                <div class="scope-icon">‚ö°</div>
                                <div>
                                    <div class="scope-name">Scope 2: Indirect (Energy)</div>
                                    <div class="scope-description">Purchased electricity, heating, cooling</div>
                                </div>
                            </div>
                            <div class="scope-values">
                                <div class="scope-amount" id="scope2Amount">337 kg</div>
                                <div class="scope-percent">27%</div>
                            </div>
                        </div>
                        <div class="scope-item scope-3">
                            <div class="scope-item-info">
                                <div class="scope-icon">üåê</div>
                                <div>
                                    <div class="scope-name">Scope 3: Value Chain</div>
                                    <div class="scope-description">Raw materials, logistics, end-of-life</div>
                                </div>
                            </div>
                            <div class="scope-values">
                                <div class="scope-amount" id="scope3Amount">848 kg</div>
                                <div class="scope-percent">68%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid Carbon Intensity -->
        <div class="card">
            <div class="card-header">
                <h3><span>üîå</span> Real-Time Grid Carbon</h3>
            </div>
            <div class="card-body">
                <div class="grid-intensity">
                    <div id="intensityGauge" style="height: 150px;"></div>
                    <div class="intensity-value" id="gridIntensity">142</div>
                    <span class="intensity-unit">gCO2e/kWh</span>
                    <div class="intensity-status" id="intensityStatus">
                        <span>üåø</span> Low Carbon - Good time to run
                    </div>
                </div>
                <div class="grid-forecast">
                    <div class="forecast-title">24-Hour Forecast</div>
                    <div class="forecast-items">
                        <div class="forecast-item">
                            <div class="forecast-time">Now</div>
                            <div class="forecast-value low" id="forecast0">142</div>
                        </div>
                        <div class="forecast-item">
                            <div class="forecast-time">+6h</div>
                            <div class="forecast-value medium" id="forecast6">198</div>
                        </div>
                        <div class="forecast-item">
                            <div class="forecast-time">+12h</div>
                            <div class="forecast-value high" id="forecast12">287</div>
                        </div>
                        <div class="forecast-item">
                            <div class="forecast-time">+18h</div>
                            <div class="forecast-value low" id="forecast18">156</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secondary Grid -->
    <div class="secondary-grid">
        <!-- Energy Mix -->
        <div class="card">
            <div class="card-header">
                <h3><span>‚ö°</span> Energy Mix</h3>
            </div>
            <div class="card-body">
                <div class="energy-mix-items">
                    <div class="energy-item">
                        <span class="energy-icon">‚òÄÔ∏è</span>
                        <div class="energy-info">
                            <div class="energy-name">Solar (On-site)</div>
                            <div class="energy-bar">
                                <div class="energy-fill solar" style="width: 28%;"></div>
                            </div>
                        </div>
                        <span class="energy-percent" id="energySolar">28%</span>
                    </div>
                    <div class="energy-item">
                        <span class="energy-icon">üí®</span>
                        <div class="energy-info">
                            <div class="energy-name">Wind (PPA)</div>
                            <div class="energy-bar">
                                <div class="energy-fill wind" style="width: 14%;"></div>
                            </div>
                        </div>
                        <span class="energy-percent" id="energyWind">14%</span>
                    </div>
                    <div class="energy-item">
                        <span class="energy-icon">üîã</span>
                        <div class="energy-info">
                            <div class="energy-name">Battery Storage</div>
                            <div class="energy-bar">
                                <div class="energy-fill battery" style="width: 8%;"></div>
                            </div>
                        </div>
                        <span class="energy-percent" id="energyBattery">8%</span>
                    </div>
                    <div class="energy-item">
                        <span class="energy-icon">üîå</span>
                        <div class="energy-info">
                            <div class="energy-name">Grid (Mixed)</div>
                            <div class="energy-bar">
                                <div class="energy-fill grid" style="width: 50%;"></div>
                            </div>
                        </div>
                        <span class="energy-percent" id="energyGrid">50%</span>
                    </div>
                </div>
                <div id="energyTrendChart" style="height: 150px; margin-top: 1rem;"></div>
            </div>
        </div>

        <!-- Circular Economy -->
        <div class="card">
            <div class="card-header">
                <h3><span>‚ôªÔ∏è</span> Circular Economy</h3>
            </div>
            <div class="card-body">
                <div class="circular-metrics">
                    <div class="circular-metric">
                        <div class="circular-value" id="recycledInput">67%</div>
                        <div class="circular-label">Recycled Input</div>
                    </div>
                    <div class="circular-metric">
                        <div class="circular-value" id="wasteRecycled">94%</div>
                        <div class="circular-label">Waste Recycled</div>
                    </div>
                    <div class="circular-metric">
                        <div class="circular-value" id="waterRecycled">82%</div>
                        <div class="circular-label">Water Recycled</div>
                    </div>
                    <div class="circular-metric">
                        <div class="circular-value" id="designRecyclability">100%</div>
                        <div class="circular-label">Design for Recyclability</div>
                    </div>
                </div>
                <div id="circularChart" style="height: 180px; margin-top: 1rem;"></div>
            </div>
        </div>

        <!-- Material Carbon Footprint -->
        <div class="card">
            <div class="card-header">
                <h3><span>üß±</span> Material Footprint</h3>
            </div>
            <div class="card-body">
                <div class="material-list">
                    <div class="material-item">
                        <div class="material-info">
                            <div class="material-icon">üåø</div>
                            <span class="material-name">Recycled PLA</span>
                        </div>
                        <span class="material-footprint">0.8 kg CO2e/kg</span>
                    </div>
                    <div class="material-item">
                        <div class="material-info">
                            <div class="material-icon">üåæ</div>
                            <span class="material-name">Bio-based PLA</span>
                        </div>
                        <span class="material-footprint">1.2 kg CO2e/kg</span>
                    </div>
                    <div class="material-item">
                        <div class="material-info">
                            <div class="material-icon">üõ¢Ô∏è</div>
                            <span class="material-name">PETG (Recycled)</span>
                        </div>
                        <span class="material-footprint">1.8 kg CO2e/kg</span>
                    </div>
                    <div class="material-item">
                        <div class="material-info">
                            <div class="material-icon">‚öóÔ∏è</div>
                            <span class="material-name">ABS (Virgin)</span>
                        </div>
                        <span class="material-footprint">3.1 kg CO2e/kg</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Green Scheduling Section -->
    <div class="card full-width green-scheduling">
        <div class="card-header">
            <h3><span>üå±</span> AI Green Scheduling Optimizer</h3>
            <button class="btn btn-primary" onclick="optimizeSchedule()">Run Optimization</button>
        </div>
        <div class="card-body">
            <div class="scheduling-stats">
                <div class="scheduling-stat">
                    <div class="scheduling-value" id="schedulingCO2Saved">187 kg</div>
                    <div class="scheduling-label">CO2e Saved Today</div>
                </div>
                <div class="scheduling-stat">
                    <div class="scheduling-value" id="schedulingJobsShifted">23</div>
                    <div class="scheduling-label">Jobs Shifted to Low-Carbon</div>
                </div>
                <div class="scheduling-stat">
                    <div class="scheduling-value" id="schedulingCostSaved">$145</div>
                    <div class="scheduling-label">Energy Cost Saved</div>
                </div>
                <div class="scheduling-stat">
                    <div class="scheduling-value" id="schedulingEfficiency">94%</div>
                    <div class="scheduling-label">Schedule Efficiency</div>
                </div>
            </div>
            <div id="schedulingChart" style="height: 200px;"></div>
        </div>
    </div>

    <!-- Emissions Trend Chart -->
    <div class="card full-width">
        <div class="card-header">
            <h3><span>üìà</span> Daily Emissions Trend</h3>
        </div>
        <div class="card-body">
            <div id="emissionsTrendChart" style="height: 300px;"></div>
        </div>
    </div>

    <!-- Initiatives Table -->
    <div class="card full-width">
        <div class="card-header">
            <h3><span>üéØ</span> Sustainability Initiatives</h3>
            <button class="btn btn-secondary" onclick="addInitiative()">+ Add Initiative</button>
        </div>
        <div class="card-body" style="padding: 0;">
            <table class="initiatives-table">
                <thead>
                    <tr>
                        <th>Initiative</th>
                        <th>Target Reduction</th>
                        <th>Progress</th>
                        <th>Impact</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="initiativesBody">
                    <tr>
                        <td>
                            <div class="initiative-name">
                                <div class="initiative-icon">ü§ñ</div>
                                <span>AI Green Scheduling Optimization</span>
                            </div>
                        </td>
                        <td>25% Scope 2 reduction</td>
                        <td class="progress-cell">
                            <div class="progress-bar">
                                <div class="progress-fill high" style="width: 92%;"></div>
                            </div>
                            <span class="progress-text">92% complete</span>
                        </td>
                        <td><span class="impact-value positive">-187 kg CO2e/month</span></td>
                        <td><span class="status-badge active">Active</span></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="initiative-name">
                                <div class="initiative-icon">‚ôªÔ∏è</div>
                                <span>Recycled PLA Transition</span>
                            </div>
                        </td>
                        <td>40% material carbon</td>
                        <td class="progress-cell">
                            <div class="progress-bar">
                                <div class="progress-fill medium" style="width: 65%;"></div>
                            </div>
                            <span class="progress-text">65% complete</span>
                        </td>
                        <td><span class="impact-value positive">-312 kg CO2e/month</span></td>
                        <td><span class="status-badge active">Active</span></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="initiative-name">
                                <div class="initiative-icon">üí°</div>
                                <span>LED Lighting Upgrade</span>
                            </div>
                        </td>
                        <td>15% energy reduction</td>
                        <td class="progress-cell">
                            <div class="progress-bar">
                                <div class="progress-fill high" style="width: 100%;"></div>
                            </div>
                            <span class="progress-text">100% complete</span>
                        </td>
                        <td><span class="impact-value positive">-89 kg CO2e/month</span></td>
                        <td><span class="status-badge completed">Completed</span></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="initiative-name">
                                <div class="initiative-icon">‚òÄÔ∏è</div>
                                <span>Solar Panel Installation</span>
                            </div>
                        </td>
                        <td>50% grid independence</td>
                        <td class="progress-cell">
                            <div class="progress-bar">
                                <div class="progress-fill low" style="width: 15%;"></div>
                            </div>
                            <span class="progress-text">15% - Planning phase</span>
                        </td>
                        <td><span class="impact-value positive">-450 kg CO2e/month (projected)</span></td>
                        <td><span class="status-badge planned">Planned Q2</span></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="initiative-name">
                                <div class="initiative-icon">üîã</div>
                                <span>Battery Storage System</span>
                            </div>
                        </td>
                        <td>Peak shaving & load shifting</td>
                        <td class="progress-cell">
                            <div class="progress-bar">
                                <div class="progress-fill low" style="width: 5%;"></div>
                            </div>
                            <span class="progress-text">5% - RFQ phase</span>
                        </td>
                        <td><span class="impact-value positive">-125 kg CO2e/month (projected)</span></td>
                        <td><span class="status-badge planned">Planned Q3</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Carbon Offsets -->
    <div class="card full-width">
        <div class="card-header">
            <h3><span>üå≥</span> Carbon Offset Portfolio</h3>
        </div>
        <div class="card-body">
            <div class="offsets-summary">
                <div class="offset-stat">
                    <div class="offset-value" id="totalOffsets">2,450</div>
                    <div class="offset-label">kg CO2e Offset (YTD)</div>
                </div>
                <div class="offset-stat">
                    <div class="offset-value" id="netEmissions">-1,203</div>
                    <div class="offset-label">Net Emissions (YTD)</div>
                </div>
                <div class="offset-stat">
                    <div class="offset-value" id="offsetCost">$245</div>
                    <div class="offset-label">Offset Investment (YTD)</div>
                </div>
            </div>
            <div class="offset-projects">
                <div class="offset-project">
                    <span class="project-icon">üå≤</span>
                    <div class="project-info">
                        <div class="project-name">Pacific Northwest Reforestation</div>
                        <div class="project-type">Verified Carbon Standard (VCS)</div>
                    </div>
                    <span class="project-amount">1,200 kg CO2e</span>
                </div>
                <div class="offset-project">
                    <span class="project-icon">üí®</span>
                    <div class="project-info">
                        <div class="project-name">Texas Wind Farm</div>
                        <div class="project-type">Gold Standard</div>
                    </div>
                    <span class="project-amount">850 kg CO2e</span>
                </div>
                <div class="offset-project">
                    <span class="project-icon">üç≥</span>
                    <div class="project-info">
                        <div class="project-name">Kenya Clean Cookstoves</div>
                        <div class="project-type">Gold Standard</div>
                    </div>
                    <span class="project-amount">400 kg CO2e</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
<script>
    // =====================================================
    // SUSTAINABILITY DASHBOARD - JAVASCRIPT
    // =====================================================

    let socket = null;

    document.addEventListener('DOMContentLoaded', () => {
        initializeWebSocket();
        initializeCharts();
        loadData();

        // Simulate live updates
        setInterval(simulateLiveUpdates, 5000);
    });

    // WebSocket
    function initializeWebSocket() {
        try {
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true
            });

            socket.on('connect', () => {
                updateConnectionStatus(true);
                showToast('success', 'Connected', 'Sustainability data stream active');
            });

            socket.on('disconnect', () => {
                updateConnectionStatus(false);
            });

            socket.on('carbon_update', (data) => {
                updateCarbonData(data);
            });

            socket.on('grid_intensity', (data) => {
                updateGridIntensity(data);
            });

        } catch (error) {
            console.error('WebSocket error:', error);
        }
    }

    function updateConnectionStatus(connected) {
        const dot = document.getElementById('connectionDot');
        const text = document.getElementById('connectionText');
        if (connected) {
            dot.classList.add('connected');
            text.textContent = 'Live';
        } else {
            dot.classList.remove('connected');
            text.textContent = 'Disconnected';
        }
    }

    // Charts
    function initializeCharts() {
        initScopeDonut();
        initEmissionsTrendChart();
        initSchedulingChart();
        initEnergyTrendChart();
        initCircularChart();
        initIntensityGauge();
        initSparklines();
    }

    function initScopeDonut() {
        const data = [{
            values: [62, 337, 848],
            labels: ['Scope 1', 'Scope 2', 'Scope 3'],
            type: 'pie',
            hole: 0.6,
            marker: {
                colors: ['#3b82f6', '#10b981', '#f59e0b']
            },
            textinfo: 'percent',
            textfont: { color: '#f8fafc', size: 12 }
        }];

        const layout = {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            margin: { t: 20, r: 20, b: 20, l: 20 },
            showlegend: false,
            annotations: [{
                text: '1,247<br><span style="font-size:10px">kg CO2e</span>',
                showarrow: false,
                font: { size: 16, color: '#f8fafc' }
            }]
        };

        Plotly.newPlot('scopeDonut', data, layout, { responsive: true, displayModeBar: false });
    }

    function initEmissionsTrendChart() {
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const scope1 = [8, 9, 7, 10, 8, 6, 14];
        const scope2 = [45, 48, 42, 50, 47, 35, 70];
        const scope3 = [110, 115, 108, 125, 118, 95, 177];

        const traces = [
            { x: days, y: scope1, name: 'Scope 1', type: 'bar', marker: { color: '#3b82f6' }},
            { x: days, y: scope2, name: 'Scope 2', type: 'bar', marker: { color: '#10b981' }},
            { x: days, y: scope3, name: 'Scope 3', type: 'bar', marker: { color: '#f59e0b' }}
        ];

        const layout = {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            margin: { t: 20, r: 20, b: 40, l: 50 },
            barmode: 'stack',
            xaxis: { color: '#94a3b8', gridcolor: '#334155' },
            yaxis: { color: '#94a3b8', gridcolor: '#334155', title: 'kg CO2e' },
            legend: { orientation: 'h', y: -0.15, font: { color: '#94a3b8' }},
            shapes: [{
                type: 'line',
                x0: days[0], x1: days[days.length - 1],
                y0: 200, y1: 200,
                line: { color: '#ef4444', width: 2, dash: 'dash' }
            }]
        };

        Plotly.newPlot('emissionsTrendChart', traces, layout, { responsive: true, displayModeBar: false });
    }

    function initSchedulingChart() {
        const hours = Array.from({ length: 24 }, (_, i) => `${i}:00`);
        const gridIntensity = [180, 175, 165, 160, 155, 150, 145, 140, 150, 170, 200, 220, 240, 250, 245, 230, 210, 190, 170, 160, 155, 160, 170, 175];
        const scheduledLoad = [0, 0, 0, 0, 0, 0, 80, 100, 60, 40, 20, 10, 5, 5, 10, 20, 40, 60, 80, 100, 80, 60, 40, 20];

        const traces = [
            {
                x: hours, y: gridIntensity,
                name: 'Grid Intensity',
                type: 'scatter',
                mode: 'lines',
                line: { color: '#f59e0b', width: 2 },
                yaxis: 'y'
            },
            {
                x: hours, y: scheduledLoad,
                name: 'Scheduled Load',
                type: 'bar',
                marker: { color: '#10b981' },
                yaxis: 'y2'
            }
        ];

        const layout = {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            margin: { t: 20, r: 60, b: 40, l: 50 },
            xaxis: { color: '#94a3b8', gridcolor: '#334155' },
            yaxis: { color: '#f59e0b', title: 'gCO2e/kWh', side: 'left' },
            yaxis2: { color: '#10b981', title: 'Load %', overlaying: 'y', side: 'right' },
            legend: { orientation: 'h', y: -0.2, font: { color: '#94a3b8' }}
        };

        Plotly.newPlot('schedulingChart', traces, layout, { responsive: true, displayModeBar: false });
    }

    function initEnergyTrendChart() {
        const hours = ['6AM', '9AM', '12PM', '3PM', '6PM', '9PM'];
        const solar = [5, 25, 40, 35, 15, 0];
        const wind = [12, 14, 10, 16, 18, 14];
        const battery = [8, 5, 2, 8, 12, 10];
        const grid = [75, 56, 48, 41, 55, 76];

        const traces = [
            { x: hours, y: solar, name: 'Solar', stackgroup: 'one', fillcolor: 'rgba(245, 158, 11, 0.7)' },
            { x: hours, y: wind, name: 'Wind', stackgroup: 'one', fillcolor: 'rgba(6, 182, 212, 0.7)' },
            { x: hours, y: battery, name: 'Battery', stackgroup: 'one', fillcolor: 'rgba(139, 92, 246, 0.7)' },
            { x: hours, y: grid, name: 'Grid', stackgroup: 'one', fillcolor: 'rgba(148, 163, 184, 0.7)' }
        ];

        const layout = {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            margin: { t: 10, r: 10, b: 30, l: 30 },
            xaxis: { color: '#94a3b8' },
            yaxis: { color: '#94a3b8', ticksuffix: '%' },
            showlegend: false
        };

        Plotly.newPlot('energyTrendChart', traces, layout, { responsive: true, displayModeBar: false });
    }

    function initCircularChart() {
        const data = [{
            type: 'scatterpolar',
            r: [67, 94, 82, 100, 67],
            theta: ['Recycled Input', 'Waste Recycled', 'Water Recycled', 'Design for Recyclability', 'Recycled Input'],
            fill: 'toself',
            fillcolor: 'rgba(16, 185, 129, 0.3)',
            line: { color: '#10b981', width: 2 }
        }];

        const layout = {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            margin: { t: 30, r: 30, b: 30, l: 30 },
            polar: {
                bgcolor: 'transparent',
                radialaxis: { visible: true, range: [0, 100], color: '#94a3b8', gridcolor: '#334155' },
                angularaxis: { color: '#94a3b8' }
            },
            showlegend: false
        };

        Plotly.newPlot('circularChart', data, layout, { responsive: true, displayModeBar: false });
    }

    function initIntensityGauge() {
        const data = [{
            type: 'indicator',
            mode: 'gauge+number',
            value: 142,
            gauge: {
                axis: { range: [0, 400], tickcolor: '#94a3b8' },
                bar: { color: '#10b981' },
                bgcolor: '#1e293b',
                borderwidth: 0,
                steps: [
                    { range: [0, 150], color: 'rgba(16, 185, 129, 0.3)' },
                    { range: [150, 250], color: 'rgba(245, 158, 11, 0.3)' },
                    { range: [250, 400], color: 'rgba(239, 68, 68, 0.3)' }
                ],
                threshold: {
                    line: { color: '#f8fafc', width: 2 },
                    thickness: 0.75,
                    value: 142
                }
            },
            number: { suffix: ' gCO2e/kWh', font: { color: '#f8fafc', size: 14 }}
        }];

        const layout = {
            paper_bgcolor: 'transparent',
            margin: { t: 20, r: 20, b: 20, l: 20 },
            font: { color: '#f8fafc' }
        };

        Plotly.newPlot('intensityGauge', data, layout, { responsive: true, displayModeBar: false });
    }

    function initSparklines() {
        const config = { responsive: true, displayModeBar: false };
        const layout = {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            margin: { t: 5, r: 5, b: 5, l: 5 },
            xaxis: { visible: false },
            yaxis: { visible: false },
            showlegend: false
        };

        const emissionsData = [45, 42, 48, 44, 40, 38, 35, 33];
        Plotly.newPlot('emissionsSparkline', [{
            y: emissionsData, type: 'scatter', mode: 'lines',
            fill: 'tozeroy', line: { color: '#10b981', width: 1 },
            fillcolor: 'rgba(16, 185, 129, 0.2)'
        }], layout, config);

        const perUnitData = [0.08, 0.075, 0.072, 0.07, 0.068, 0.066, 0.065, 0.065];
        Plotly.newPlot('perUnitSparkline', [{
            y: perUnitData, type: 'scatter', mode: 'lines',
            fill: 'tozeroy', line: { color: '#06b6d4', width: 1 },
            fillcolor: 'rgba(6, 182, 212, 0.2)'
        }], layout, config);

        const energyData = [380, 370, 360, 355, 350, 345, 340, 335];
        Plotly.newPlot('energySparkline', [{
            y: energyData, type: 'scatter', mode: 'lines',
            fill: 'tozeroy', line: { color: '#8b5cf6', width: 1 },
            fillcolor: 'rgba(139, 92, 246, 0.2)'
        }], layout, config);

        const savingsData = [120, 135, 150, 158, 165, 175, 182, 187];
        Plotly.newPlot('savingsSparkline', [{
            y: savingsData, type: 'scatter', mode: 'lines',
            fill: 'tozeroy', line: { color: '#f59e0b', width: 1 },
            fillcolor: 'rgba(245, 158, 11, 0.2)'
        }], layout, config);
    }

    // Data Loading
    async function loadData() {
        try {
            const response = await fetch('/api/sustainability/metrics');
            if (response.ok) {
                const data = await response.json();
                updateDashboard(data);
            }
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    function updateDashboard(data) {
        if (data.emissions) {
            document.getElementById('kpiEmissions').innerHTML = `${data.emissions.total}<span class="kpi-unit">kg CO2e</span>`;
        }
    }

    function updateCarbonData(data) {
        // Update KPIs from real-time data
    }

    function updateGridIntensity(data) {
        document.getElementById('gridIntensity').textContent = data.intensity;
        const status = document.getElementById('intensityStatus');
        if (data.intensity < 150) {
            status.className = 'intensity-status';
            status.innerHTML = '<span>üåø</span> Low Carbon - Good time to run';
        } else if (data.intensity < 250) {
            status.className = 'intensity-status medium';
            status.innerHTML = '<span>‚ö°</span> Medium Carbon - Consider delaying';
        } else {
            status.className = 'intensity-status high';
            status.innerHTML = '<span>‚ö†Ô∏è</span> High Carbon - Avoid if possible';
        }
    }

    // Pattern-based live updates (grid intensity varies by time of day)
    function simulateLiveUpdates() {
        const hour = new Date().getHours();
        const minute = new Date().getMinutes();
        const timePhase = (hour * 60 + minute) / 1440;

        // Grid intensity: higher during peak demand (morning/evening), lower midday (solar) and night
        const peakFactor = Math.sin((hour - 7) * Math.PI / 6) * 0.5; // Morning peak
        const eveningPeak = Math.sin((hour - 18) * Math.PI / 6) * 0.3; // Evening peak
        const solarDip = (hour >= 10 && hour <= 16) ? -20 : 0; // Solar reduces grid intensity midday
        const newIntensity = 160 + peakFactor * 40 + eveningPeak * 40 + solarDip + Math.sin(timePhase * Math.PI * 8) * 10;
        updateGridIntensity({ intensity: Math.round(Math.max(100, Math.min(200, newIntensity))) });

        // Emissions tied to production activity - higher during shifts
        const shiftMultiplier = (hour >= 6 && hour < 22) ? 1.05 : 0.90;
        const baseEmissions = 1250 * shiftMultiplier;
        const emissions = baseEmissions + Math.sin(timePhase * Math.PI * 6) * 50;
        document.getElementById('kpiEmissions').innerHTML = `${Math.round(emissions).toLocaleString()}<span class="kpi-unit">kg CO2e</span>`;
    }

    // Actions
    function exportReport() {
        showToast('info', 'Generating Report', 'Preparing GHG Protocol compliant report...');
        setTimeout(() => {
            showToast('success', 'Report Ready', 'Carbon report exported to PDF');
        }, 2000);
    }

    function refreshData() {
        showToast('info', 'Refreshing', 'Fetching latest carbon data...');
        loadData();
    }

    function optimizeSchedule() {
        showToast('info', 'Optimizing', 'Running AI green scheduling optimization...');
        setTimeout(() => {
            showToast('success', 'Optimization Complete', 'Shifted 5 jobs to low-carbon windows, saving 45 kg CO2e');
        }, 3000);
    }

    function addInitiative() {
        showToast('info', 'New Initiative', 'Opening initiative wizard...');
    }

    // Toast
    function showToast(type, title, message) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };

        toast.innerHTML = `
            <span class="toast-icon">${icons[type]}</span>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
        `;

        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }
</script>
{% endblock %}
