{% extends "base.html" %}

{% block title %}Manufacturing Costing - LEGO MCP v5.0{% endblock %}

{% block styles %}
<style>
    /* ============================================
       Manufacturing Costing Dashboard
       Activity-Based Costing & Variance Analysis
       ============================================ */

    .costing-dashboard {
        padding: 1.5rem;
        max-width: 1800px;
        margin: 0 auto;
    }

    /* Dashboard Header */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .dashboard-title {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .dashboard-title h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
    }

    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .badge-version {
        background: linear-gradient(135deg, var(--accent-primary) 0%, #c00 100%);
        color: white;
    }

    .badge-abc {
        background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        color: white;
    }

    .dashboard-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .btn-primary {
        background: var(--accent-primary);
        color: white;
    }

    .btn-primary:hover {
        background: #c00;
    }

    .btn-secondary {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    .btn-secondary:hover {
        background: var(--bg-primary);
    }

    /* Part/Order Selector */
    .selector-bar {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        flex-wrap: wrap;
    }

    .selector-bar label {
        font-weight: 600;
        white-space: nowrap;
    }

    .selector-bar select {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        font-size: 0.9rem;
        min-width: 200px;
    }

    .period-badge {
        margin-left: auto;
        padding: 0.4rem 0.75rem;
        background: var(--bg-secondary);
        border-radius: 6px;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    /* KPI Cards */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .kpi-card {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 1.25rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        position: relative;
        overflow: hidden;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }

    .kpi-card.materials::before { background: #6f42c1; }
    .kpi-card.labor::before { background: #fd7e14; }
    .kpi-card.overhead::before { background: var(--accent-secondary); }
    .kpi-card.total::before { background: var(--accent-primary); }
    .kpi-card.variance-fav::before { background: #28a745; }
    .kpi-card.variance-unfav::before { background: #dc3545; }

    .kpi-label {
        font-size: 0.7rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }

    .kpi-value {
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1;
    }

    .kpi-value.positive { color: #28a745; }
    .kpi-value.negative { color: #dc3545; }

    .kpi-subtitle {
        font-size: 0.7rem;
        color: var(--text-secondary);
        margin-top: 0.35rem;
    }

    .kpi-change {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.75rem;
        margin-top: 0.35rem;
    }

    .kpi-change.up { color: #dc3545; }
    .kpi-change.down { color: #28a745; }

    /* Chart Panels */
    .chart-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 1200px) {
        .chart-grid {
            grid-template-columns: 1fr;
        }
    }

    .chart-panel {
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .chart-panel.full-width {
        grid-column: 1 / -1;
    }

    .panel-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .panel-title {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .panel-body {
        padding: 1.25rem;
    }

    /* ============================================
       Waterfall Chart
       ============================================ */
    .waterfall-container {
        height: 320px;
        position: relative;
        margin: 0 60px 40px 60px;
    }

    .waterfall-chart {
        display: flex;
        align-items: flex-end;
        height: 100%;
        gap: 12px;
        border-left: 2px solid var(--border-color);
        border-bottom: 2px solid var(--border-color);
        padding-left: 10px;
    }

    .waterfall-bar {
        flex: 1;
        max-width: 100px;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }

    .waterfall-bar-segment {
        width: 100%;
        border-radius: 4px 4px 0 0;
        position: relative;
    }

    .waterfall-bar-segment.positive {
        background: linear-gradient(180deg, #28a745 0%, #1e7e34 100%);
    }

    .waterfall-bar-segment.negative {
        background: linear-gradient(180deg, #dc3545 0%, #c82333 100%);
    }

    .waterfall-bar-segment.total {
        background: linear-gradient(180deg, var(--accent-secondary) 0%, #004a94 100%);
    }

    .waterfall-bar-segment.materials {
        background: linear-gradient(180deg, #6f42c1 0%, #5a31a8 100%);
    }

    .waterfall-bar-segment.labor {
        background: linear-gradient(180deg, #fd7e14 0%, #e76800 100%);
    }

    .waterfall-bar-segment.overhead {
        background: linear-gradient(180deg, #20c997 0%, #1aa179 100%);
    }

    .waterfall-bridge {
        position: absolute;
        height: 2px;
        background: var(--text-secondary);
        right: -12px;
        width: 24px;
    }

    .waterfall-bar-value {
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .waterfall-bar-label {
        position: absolute;
        bottom: -35px;
        left: 50%;
        transform: translateX(-50%) rotate(-30deg);
        transform-origin: top center;
        font-size: 0.7rem;
        white-space: nowrap;
    }

    .waterfall-y-axis {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 50px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        text-align: right;
        padding-right: 10px;
        font-size: 0.7rem;
        color: var(--text-secondary);
    }

    /* ============================================
       ABC Cost Breakdown (Donut + List)
       ============================================ */
    .abc-breakdown {
        display: flex;
        gap: 2rem;
        align-items: center;
    }

    @media (max-width: 800px) {
        .abc-breakdown {
            flex-direction: column;
        }
    }

    .donut-container {
        position: relative;
        width: 200px;
        height: 200px;
        flex-shrink: 0;
    }

    .donut-chart {
        width: 100%;
        height: 100%;
    }

    .donut-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .donut-center-value {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .donut-center-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .abc-list {
        flex: 1;
    }

    .abc-category {
        margin-bottom: 1rem;
    }

    .abc-category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .abc-category-name {
        font-weight: 600;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .abc-category-dot {
        width: 12px;
        height: 12px;
        border-radius: 3px;
    }

    .abc-category-amount {
        font-weight: 600;
    }

    .abc-category-bar {
        height: 8px;
        background: var(--bg-secondary);
        border-radius: 4px;
        overflow: hidden;
    }

    .abc-category-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .abc-activities {
        margin-top: 0.5rem;
        padding-left: 1.5rem;
    }

    .abc-activity {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        padding: 0.25rem 0;
        color: var(--text-secondary);
    }

    /* ============================================
       Variance Analysis
       ============================================ */
    .variance-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }

    .variance-table th,
    .variance-table td {
        padding: 0.75rem 0.5rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .variance-table th {
        background: var(--bg-secondary);
        font-weight: 600;
    }

    .variance-table tbody tr:hover {
        background: var(--bg-secondary);
    }

    .variance-cell {
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .variance-badge {
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .variance-badge.favorable {
        background: rgba(40, 167, 69, 0.15);
        color: #28a745;
    }

    .variance-badge.unfavorable {
        background: rgba(220, 53, 69, 0.15);
        color: #dc3545;
    }

    .variance-badge.neutral {
        background: var(--bg-secondary);
        color: var(--text-secondary);
    }

    .variance-bar-cell {
        width: 120px;
    }

    .variance-bar {
        height: 8px;
        background: var(--bg-secondary);
        border-radius: 4px;
        position: relative;
        overflow: visible;
    }

    .variance-bar-center {
        position: absolute;
        left: 50%;
        top: -2px;
        bottom: -2px;
        width: 2px;
        background: var(--text-secondary);
    }

    .variance-bar-fill {
        position: absolute;
        top: 0;
        height: 100%;
        border-radius: 4px;
    }

    .variance-bar-fill.favorable {
        background: #28a745;
        left: 50%;
    }

    .variance-bar-fill.unfavorable {
        background: #dc3545;
        right: 50%;
    }

    /* ============================================
       Cost of Quality (COQ)
       ============================================ */
    .coq-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
    }

    @media (max-width: 1000px) {
        .coq-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .coq-card {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .coq-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }

    .coq-card.prevention::before { background: #28a745; }
    .coq-card.appraisal::before { background: #17a2b8; }
    .coq-card.internal::before { background: #fd7e14; }
    .coq-card.external::before { background: #dc3545; }

    .coq-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .coq-label {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .coq-value {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .coq-percent {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .coq-optimal {
        font-size: 0.7rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    /* ============================================
       Cost Trend Chart
       ============================================ */
    .trend-container {
        height: 250px;
        position: relative;
        margin: 0 40px 30px 50px;
    }

    .trend-chart {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-left: 2px solid var(--border-color);
        border-bottom: 2px solid var(--border-color);
    }

    .trend-line {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    .trend-line svg {
        width: 100%;
        height: 100%;
    }

    .trend-line path {
        fill: none;
        stroke-width: 2.5;
        stroke-linecap: round;
    }

    .trend-line.total path { stroke: var(--accent-primary); }
    .trend-line.materials path { stroke: #6f42c1; }
    .trend-line.labor path { stroke: #fd7e14; }
    .trend-line.overhead path { stroke: #20c997; }

    .trend-area {
        opacity: 0.1;
    }

    .trend-y-axis {
        position: absolute;
        left: -50px;
        top: 0;
        bottom: 0;
        width: 45px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        text-align: right;
        font-size: 0.7rem;
        color: var(--text-secondary);
    }

    .trend-x-axis {
        position: absolute;
        bottom: -25px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        font-size: 0.65rem;
        color: var(--text-secondary);
    }

    .trend-legend {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-top: 0.5rem;
        flex-wrap: wrap;
    }

    .trend-legend-item {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.75rem;
    }

    .trend-legend-line {
        width: 20px;
        height: 3px;
        border-radius: 2px;
    }

    /* ============================================
       BOM Cost Rollup
       ============================================ */
    .bom-tree {
        font-size: 0.85rem;
    }

    .bom-item {
        border-left: 2px solid var(--border-color);
        padding-left: 1rem;
        margin-left: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .bom-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        background: var(--bg-secondary);
        border-radius: 4px;
        cursor: pointer;
    }

    .bom-item-header:hover {
        background: var(--bg-primary);
    }

    .bom-item-name {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .bom-expand {
        width: 16px;
        text-align: center;
        color: var(--text-secondary);
    }

    .bom-item-cost {
        font-weight: 600;
    }

    .bom-item-qty {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-left: 0.5rem;
    }

    .bom-children {
        margin-top: 0.5rem;
        display: none;
    }

    .bom-children.expanded {
        display: block;
    }

    .bom-leaf {
        display: flex;
        justify-content: space-between;
        padding: 0.35rem 0.5rem;
        margin-left: 1.5rem;
        font-size: 0.8rem;
    }

    /* Loading */
    .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 3rem;
        color: var(--text-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="costing-dashboard">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="dashboard-title">
            <h1>Manufacturing Costing</h1>
            <span class="badge badge-version">v5.0</span>
            <span class="badge badge-abc">ABC Costing</span>
        </div>
        <div class="dashboard-actions">
            <button class="btn btn-secondary" onclick="exportReport('pdf')">
                <span>Export PDF</span>
            </button>
            <button class="btn btn-secondary" onclick="exportReport('excel')">
                <span>Export Excel</span>
            </button>
            <button class="btn btn-secondary" onclick="refreshData()">
                <span>Refresh</span>
            </button>
            <button class="btn btn-primary" onclick="openCostEntry()">
                <span>+ Enter Costs</span>
            </button>
        </div>
    </div>

    <!-- Part/Work Order Selector -->
    <div class="selector-bar">
        <label for="partSelect">Part/Product:</label>
        <select id="partSelect" onchange="selectPart(this.value)">
            <option value="BRICK-2x4">2x4 Standard Brick</option>
            <option value="BRICK-2x2">2x2 Standard Brick</option>
            <option value="PLATE-4x6">4x6 Plate</option>
            <option value="TECH-BEAM-15">Technic Beam 15L</option>
            <option value="MINIFIG-TORSO">Minifigure Torso</option>
        </select>

        <label for="periodSelect">Period:</label>
        <select id="periodSelect" onchange="selectPeriod(this.value)">
            <option value="month">This Month</option>
            <option value="quarter">This Quarter</option>
            <option value="year">This Year</option>
            <option value="custom">Custom Range</option>
        </select>

        <span class="period-badge" id="periodBadge">Dec 2025</span>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card total">
            <div class="kpi-label">Total Unit Cost</div>
            <div class="kpi-value" id="kpiTotalCost">$0.00</div>
            <div class="kpi-change" id="kpiTotalChange"></div>
        </div>
        <div class="kpi-card materials">
            <div class="kpi-label">Direct Materials</div>
            <div class="kpi-value" id="kpiMaterials">$0.00</div>
            <div class="kpi-subtitle" id="kpiMaterialsPct">0% of total</div>
        </div>
        <div class="kpi-card labor">
            <div class="kpi-label">Direct Labor</div>
            <div class="kpi-value" id="kpiLabor">$0.00</div>
            <div class="kpi-subtitle" id="kpiLaborPct">0% of total</div>
        </div>
        <div class="kpi-card overhead">
            <div class="kpi-label">Overhead (ABC)</div>
            <div class="kpi-value" id="kpiOverhead">$0.00</div>
            <div class="kpi-subtitle" id="kpiOverheadPct">0% of total</div>
        </div>
        <div class="kpi-card variance-fav" id="kpiVarianceCard">
            <div class="kpi-label">Cost Variance</div>
            <div class="kpi-value" id="kpiVariance">$0.00</div>
            <div class="kpi-subtitle" id="kpiVariancePct">vs. standard</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Margin %</div>
            <div class="kpi-value" id="kpiMargin">0%</div>
            <div class="kpi-subtitle" id="kpiMarginTarget">Target: 35%</div>
        </div>
    </div>

    <!-- Main Charts -->
    <div class="chart-grid">
        <!-- Waterfall Chart -->
        <div class="chart-panel full-width">
            <div class="panel-header">
                <span class="panel-title">
                    <span>Cost Buildup (Waterfall)</span>
                </span>
            </div>
            <div class="panel-body">
                <div class="waterfall-container">
                    <div class="waterfall-y-axis" id="waterfallYAxis"></div>
                    <div class="waterfall-chart" id="waterfallChart">
                        <!-- Rendered by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ABC Breakdown -->
        <div class="chart-panel">
            <div class="panel-header">
                <span class="panel-title">
                    <span>Activity-Based Costing Breakdown</span>
                </span>
            </div>
            <div class="panel-body">
                <div class="abc-breakdown">
                    <div class="donut-container">
                        <svg class="donut-chart" viewBox="0 0 100 100" id="abcDonut">
                            <!-- Rendered by JS -->
                        </svg>
                        <div class="donut-center">
                            <div class="donut-center-value" id="donutCenterValue">$0.00</div>
                            <div class="donut-center-label">Total Overhead</div>
                        </div>
                    </div>
                    <div class="abc-list" id="abcList">
                        <!-- Rendered by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Cost of Quality -->
        <div class="chart-panel">
            <div class="panel-header">
                <span class="panel-title">
                    <span>Cost of Quality (COQ)</span>
                </span>
            </div>
            <div class="panel-body">
                <div class="coq-grid" id="coqGrid">
                    <div class="coq-card prevention">
                        <div class="coq-icon">üõ°Ô∏è</div>
                        <div class="coq-label">Prevention</div>
                        <div class="coq-value" id="coqPrevention">$0.00</div>
                        <div class="coq-percent" id="coqPreventionPct">0%</div>
                        <div class="coq-optimal">Target: 40-50%</div>
                    </div>
                    <div class="coq-card appraisal">
                        <div class="coq-icon">üîç</div>
                        <div class="coq-label">Appraisal</div>
                        <div class="coq-value" id="coqAppraisal">$0.00</div>
                        <div class="coq-percent" id="coqAppraisalPct">0%</div>
                        <div class="coq-optimal">Target: 30-40%</div>
                    </div>
                    <div class="coq-card internal">
                        <div class="coq-icon">üîÑ</div>
                        <div class="coq-label">Internal Failure</div>
                        <div class="coq-value" id="coqInternal">$0.00</div>
                        <div class="coq-percent" id="coqInternalPct">0%</div>
                        <div class="coq-optimal">Target: &lt;15%</div>
                    </div>
                    <div class="coq-card external">
                        <div class="coq-icon">‚ö†Ô∏è</div>
                        <div class="coq-label">External Failure</div>
                        <div class="coq-value" id="coqExternal">$0.00</div>
                        <div class="coq-percent" id="coqExternalPct">0%</div>
                        <div class="coq-optimal">Target: &lt;5%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Variance Analysis & Trend -->
    <div class="chart-grid">
        <!-- Variance Analysis -->
        <div class="chart-panel">
            <div class="panel-header">
                <span class="panel-title">
                    <span>Variance Analysis (Standard vs Actual)</span>
                </span>
            </div>
            <div class="panel-body">
                <table class="variance-table">
                    <thead>
                        <tr>
                            <th>Cost Element</th>
                            <th>Standard</th>
                            <th>Actual</th>
                            <th>Variance</th>
                            <th class="variance-bar-cell">Visual</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="varianceTableBody">
                        <!-- Rendered by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cost Trend -->
        <div class="chart-panel">
            <div class="panel-header">
                <span class="panel-title">
                    <span>Cost Trend (12 Months)</span>
                </span>
            </div>
            <div class="panel-body">
                <div class="trend-container">
                    <div class="trend-y-axis" id="trendYAxis"></div>
                    <div class="trend-chart" id="trendChart">
                        <!-- Rendered by JS -->
                    </div>
                    <div class="trend-x-axis" id="trendXAxis"></div>
                </div>
                <div class="trend-legend">
                    <div class="trend-legend-item">
                        <div class="trend-legend-line" style="background: var(--accent-primary);"></div>
                        <span>Total Cost</span>
                    </div>
                    <div class="trend-legend-item">
                        <div class="trend-legend-line" style="background: #6f42c1;"></div>
                        <span>Materials</span>
                    </div>
                    <div class="trend-legend-item">
                        <div class="trend-legend-line" style="background: #fd7e14;"></div>
                        <span>Labor</span>
                    </div>
                    <div class="trend-legend-item">
                        <div class="trend-legend-line" style="background: #20c997;"></div>
                        <span>Overhead</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BOM Cost Rollup -->
    <div class="chart-panel">
        <div class="panel-header">
            <span class="panel-title">
                <span>BOM Cost Rollup</span>
            </span>
        </div>
        <div class="panel-body">
            <div class="bom-tree" id="bomTree">
                <!-- Rendered by JS -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ============================================
// Manufacturing Costing Dashboard
// ============================================

// Sample cost data for LEGO brick manufacturing
const sampleCostData = {
    'BRICK-2x4': {
        name: '2x4 Standard Brick',
        standardCost: {
            materials: 0.025,
            labor: 0.015,
            overhead: 0.042
        },
        actualCost: {
            materials: 0.027,
            labor: 0.014,
            overhead: 0.045
        },
        sellingPrice: 0.15,
        activities: {
            unit: [
                { name: '3D Printing', driver: 'machine_hours', quantity: 0.02, rate: 25.00, cost: 0.50 },
                { name: 'Inspection', driver: 'inspections', quantity: 1, rate: 4.00, cost: 4.00 },
                { name: 'Testing', driver: 'tests', quantity: 0.2, rate: 7.50, cost: 1.50 }
            ],
            batch: [
                { name: 'Setup', driver: 'setup_hours', quantity: 0.05, rate: 50.00, cost: 2.50 },
                { name: 'Material Handling', driver: 'moves', quantity: 0.5, rate: 10.00, cost: 5.00 }
            ],
            product: [
                { name: 'Engineering', driver: 'eng_hours', quantity: 0.01, rate: 50.00, cost: 0.50 },
                { name: 'FMEA', driver: 'eng_hours', quantity: 0.005, rate: 40.00, cost: 0.20 }
            ],
            facility: [
                { name: 'Maintenance', driver: 'machine_hours', quantity: 0.02, rate: 15.00, cost: 0.30 },
                { name: 'Utilities', driver: 'sqft', quantity: 0.01, rate: 5.00, cost: 0.05 }
            ]
        },
        coq: {
            prevention: 0.008,
            appraisal: 0.006,
            internal: 0.003,
            external: 0.001
        },
        trend: generateTrendData(),
        bom: {
            name: '2x4 Standard Brick Assembly',
            cost: 0.082,
            children: [
                {
                    name: 'ABS Plastic Pellets',
                    type: 'material',
                    qty: '2.3g',
                    cost: 0.023
                },
                {
                    name: 'Colorant Masterbatch',
                    type: 'material',
                    qty: '0.2g',
                    cost: 0.004
                },
                {
                    name: 'Injection Molding Process',
                    type: 'process',
                    cost: 0.035,
                    children: [
                        { name: 'Machine Time', cost: 0.020 },
                        { name: 'Energy', cost: 0.008 },
                        { name: 'Tooling Depreciation', cost: 0.007 }
                    ]
                },
                {
                    name: 'Quality Assurance',
                    type: 'process',
                    cost: 0.015,
                    children: [
                        { name: 'Dimensional Check', cost: 0.008 },
                        { name: 'Clutch Test', cost: 0.005 },
                        { name: 'Visual Inspection', cost: 0.002 }
                    ]
                },
                {
                    name: 'Packaging',
                    type: 'process',
                    cost: 0.005
                }
            ]
        }
    }
};

function generateTrendData() {
    const months = [];
    const baseTotal = 0.082;
    const baseMaterials = 0.025;
    const baseLabor = 0.015;
    const baseOverhead = 0.042;

    for (let i = 11; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);

        // Deterministic variation based on month index (seasonal pattern)
        const variation = Math.sin(i * 0.5) * 0.005;

        months.push({
            month: date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
            total: baseTotal + variation,
            materials: baseMaterials + variation * 0.3,
            labor: baseLabor + variation * 0.2,
            overhead: baseOverhead + variation * 0.5
        });
    }

    return months;
}

// State
let currentPart = 'BRICK-2x4';
let costData = null;

// ============================================
// Initialization
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    loadCostData();
});

function loadCostData() {
    costData = sampleCostData[currentPart];
    if (!costData) return;

    updateKPIs();
    renderWaterfallChart();
    renderABCBreakdown();
    renderCOQ();
    renderVarianceTable();
    renderTrendChart();
    renderBOMTree();
}

function selectPart(partId) {
    currentPart = partId;
    loadCostData();
}

function selectPeriod(period) {
    // Update period badge
    const badge = document.getElementById('periodBadge');
    if (period === 'month') badge.textContent = 'Dec 2025';
    else if (period === 'quarter') badge.textContent = 'Q4 2025';
    else if (period === 'year') badge.textContent = 'FY 2025';

    loadCostData();
}

// ============================================
// KPI Updates
// ============================================
function updateKPIs() {
    const actual = costData.actualCost;
    const standard = costData.standardCost;

    const totalActual = actual.materials + actual.labor + actual.overhead;
    const totalStandard = standard.materials + standard.labor + standard.overhead;
    const variance = totalActual - totalStandard;
    const margin = ((costData.sellingPrice - totalActual) / costData.sellingPrice) * 100;

    document.getElementById('kpiTotalCost').textContent = formatCurrency(totalActual);
    document.getElementById('kpiMaterials').textContent = formatCurrency(actual.materials);
    document.getElementById('kpiMaterialsPct').textContent = `${((actual.materials / totalActual) * 100).toFixed(0)}% of total`;
    document.getElementById('kpiLabor').textContent = formatCurrency(actual.labor);
    document.getElementById('kpiLaborPct').textContent = `${((actual.labor / totalActual) * 100).toFixed(0)}% of total`;
    document.getElementById('kpiOverhead').textContent = formatCurrency(actual.overhead);
    document.getElementById('kpiOverheadPct').textContent = `${((actual.overhead / totalActual) * 100).toFixed(0)}% of total`;

    const varianceCard = document.getElementById('kpiVarianceCard');
    const varianceEl = document.getElementById('kpiVariance');
    if (variance > 0) {
        varianceCard.className = 'kpi-card variance-unfav';
        varianceEl.className = 'kpi-value negative';
        varianceEl.textContent = '+' + formatCurrency(variance);
    } else {
        varianceCard.className = 'kpi-card variance-fav';
        varianceEl.className = 'kpi-value positive';
        varianceEl.textContent = formatCurrency(variance);
    }
    document.getElementById('kpiVariancePct').textContent = `${((variance / totalStandard) * 100).toFixed(1)}% vs. standard`;

    document.getElementById('kpiMargin').textContent = margin.toFixed(1) + '%';
    document.getElementById('kpiMargin').className = 'kpi-value ' + (margin >= 35 ? 'positive' : 'negative');
}

function formatCurrency(value) {
    return '$' + value.toFixed(3);
}

// ============================================
// Waterfall Chart
// ============================================
function renderWaterfallChart() {
    const container = document.getElementById('waterfallChart');
    const actual = costData.actualCost;

    const steps = [
        { label: 'Raw Materials', value: actual.materials, type: 'materials', cumulative: actual.materials },
        { label: '+ Direct Labor', value: actual.labor, type: 'labor', cumulative: actual.materials + actual.labor },
        { label: '+ Setup', value: actual.overhead * 0.15, type: 'overhead', cumulative: actual.materials + actual.labor + actual.overhead * 0.15 },
        { label: '+ Printing', value: actual.overhead * 0.35, type: 'overhead', cumulative: actual.materials + actual.labor + actual.overhead * 0.50 },
        { label: '+ Inspection', value: actual.overhead * 0.20, type: 'overhead', cumulative: actual.materials + actual.labor + actual.overhead * 0.70 },
        { label: '+ Testing', value: actual.overhead * 0.15, type: 'overhead', cumulative: actual.materials + actual.labor + actual.overhead * 0.85 },
        { label: '+ Other OH', value: actual.overhead * 0.15, type: 'overhead', cumulative: actual.materials + actual.labor + actual.overhead },
        { label: 'Total Cost', value: actual.materials + actual.labor + actual.overhead, type: 'total', cumulative: actual.materials + actual.labor + actual.overhead }
    ];

    const maxVal = Math.max(...steps.map(s => s.cumulative)) * 1.1;

    let html = '';
    let prevTop = 0;

    steps.forEach((step, i) => {
        const height = (step.value / maxVal) * 100;
        const bottom = i === steps.length - 1 ? 0 : ((step.cumulative - step.value) / maxVal) * 100;
        const top = 100 - bottom - height;

        html += `
            <div class="waterfall-bar">
                <div class="waterfall-bar-segment ${step.type}"
                     style="height: ${height}%; position: absolute; bottom: ${bottom}%;">
                    ${i < steps.length - 1 ? `<div class="waterfall-bridge" style="top: 0;"></div>` : ''}
                </div>
                <span class="waterfall-bar-value">${formatCurrency(step.value)}</span>
                <span class="waterfall-bar-label">${step.label}</span>
            </div>
        `;

        prevTop = top;
    });

    container.innerHTML = html;

    // Update Y-axis
    const yAxis = document.getElementById('waterfallYAxis');
    yAxis.innerHTML = '';
    for (let i = 0; i <= 5; i++) {
        const val = maxVal * (1 - i / 5);
        yAxis.innerHTML += `<span>${formatCurrency(val)}</span>`;
    }
}

// ============================================
// ABC Breakdown
// ============================================
function renderABCBreakdown() {
    const activities = costData.activities;

    const categories = [
        { name: 'Unit-Level', key: 'unit', color: '#6f42c1' },
        { name: 'Batch-Level', key: 'batch', color: '#fd7e14' },
        { name: 'Product-Level', key: 'product', color: '#20c997' },
        { name: 'Facility-Level', key: 'facility', color: '#17a2b8' }
    ];

    let totalOverhead = 0;
    categories.forEach(cat => {
        cat.total = (activities[cat.key] || []).reduce((sum, a) => sum + a.cost, 0) / 1000;
        totalOverhead += cat.total;
    });

    // Render donut chart
    const donut = document.getElementById('abcDonut');
    let currentAngle = 0;
    let paths = '';

    categories.forEach(cat => {
        const percentage = cat.total / totalOverhead;
        const startAngle = currentAngle;
        const endAngle = currentAngle + percentage * 360;

        if (percentage > 0) {
            const largeArc = percentage > 0.5 ? 1 : 0;
            const x1 = 50 + 35 * Math.cos((startAngle - 90) * Math.PI / 180);
            const y1 = 50 + 35 * Math.sin((startAngle - 90) * Math.PI / 180);
            const x2 = 50 + 35 * Math.cos((endAngle - 90) * Math.PI / 180);
            const y2 = 50 + 35 * Math.sin((endAngle - 90) * Math.PI / 180);

            paths += `<path d="M 50 50 L ${x1} ${y1} A 35 35 0 ${largeArc} 1 ${x2} ${y2} Z"
                           fill="${cat.color}" opacity="0.9"/>`;
        }

        currentAngle = endAngle;
    });

    // Inner circle (donut hole)
    paths += `<circle cx="50" cy="50" r="22" fill="var(--card-bg)"/>`;

    donut.innerHTML = paths;
    document.getElementById('donutCenterValue').textContent = formatCurrency(totalOverhead);

    // Render list
    const list = document.getElementById('abcList');
    list.innerHTML = categories.map(cat => {
        const pct = (cat.total / totalOverhead) * 100;
        const acts = activities[cat.key] || [];

        return `
            <div class="abc-category">
                <div class="abc-category-header">
                    <span class="abc-category-name">
                        <span class="abc-category-dot" style="background: ${cat.color};"></span>
                        ${cat.name}
                    </span>
                    <span class="abc-category-amount">${formatCurrency(cat.total)} (${pct.toFixed(0)}%)</span>
                </div>
                <div class="abc-category-bar">
                    <div class="abc-category-fill" style="width: ${pct}%; background: ${cat.color};"></div>
                </div>
                <div class="abc-activities">
                    ${acts.map(a => `
                        <div class="abc-activity">
                            <span>${a.name}</span>
                            <span>${formatCurrency(a.cost / 1000)}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }).join('');
}

// ============================================
// Cost of Quality
// ============================================
function renderCOQ() {
    const coq = costData.coq;
    const total = coq.prevention + coq.appraisal + coq.internal + coq.external;

    document.getElementById('coqPrevention').textContent = formatCurrency(coq.prevention);
    document.getElementById('coqPreventionPct').textContent = ((coq.prevention / total) * 100).toFixed(0) + '%';

    document.getElementById('coqAppraisal').textContent = formatCurrency(coq.appraisal);
    document.getElementById('coqAppraisalPct').textContent = ((coq.appraisal / total) * 100).toFixed(0) + '%';

    document.getElementById('coqInternal').textContent = formatCurrency(coq.internal);
    document.getElementById('coqInternalPct').textContent = ((coq.internal / total) * 100).toFixed(0) + '%';

    document.getElementById('coqExternal').textContent = formatCurrency(coq.external);
    document.getElementById('coqExternalPct').textContent = ((coq.external / total) * 100).toFixed(0) + '%';
}

// ============================================
// Variance Table
// ============================================
function renderVarianceTable() {
    const actual = costData.actualCost;
    const standard = costData.standardCost;

    const elements = [
        { name: 'Direct Materials', standard: standard.materials, actual: actual.materials },
        { name: 'Direct Labor', standard: standard.labor, actual: actual.labor },
        { name: 'Setup & Handling', standard: standard.overhead * 0.30, actual: actual.overhead * 0.32 },
        { name: 'Machine Operations', standard: standard.overhead * 0.35, actual: actual.overhead * 0.33 },
        { name: 'Quality Activities', standard: standard.overhead * 0.25, actual: actual.overhead * 0.25 },
        { name: 'Other Overhead', standard: standard.overhead * 0.10, actual: actual.overhead * 0.10 },
        {
            name: 'TOTAL',
            standard: standard.materials + standard.labor + standard.overhead,
            actual: actual.materials + actual.labor + actual.overhead,
            isTotal: true
        }
    ];

    const tbody = document.getElementById('varianceTableBody');
    tbody.innerHTML = elements.map(el => {
        const variance = el.actual - el.standard;
        const pct = (variance / el.standard) * 100;
        const isFavorable = variance <= 0;
        const maxVar = 0.01; // Max variance for bar scaling
        const barWidth = Math.min(Math.abs(variance) / maxVar * 50, 50);

        return `
            <tr style="${el.isTotal ? 'font-weight: 700; background: var(--bg-secondary);' : ''}">
                <td>${el.name}</td>
                <td>${formatCurrency(el.standard)}</td>
                <td>${formatCurrency(el.actual)}</td>
                <td>
                    <span class="variance-badge ${isFavorable ? 'favorable' : 'unfavorable'}">
                        ${variance > 0 ? '+' : ''}${formatCurrency(variance)} (${pct > 0 ? '+' : ''}${pct.toFixed(1)}%)
                    </span>
                </td>
                <td class="variance-bar-cell">
                    <div class="variance-bar">
                        <div class="variance-bar-center"></div>
                        <div class="variance-bar-fill ${isFavorable ? 'favorable' : 'unfavorable'}"
                             style="width: ${barWidth}%;"></div>
                    </div>
                </td>
                <td>${isFavorable ? '‚úì' : '‚ö†Ô∏è'}</td>
            </tr>
        `;
    }).join('');
}

// ============================================
// Trend Chart
// ============================================
function renderTrendChart() {
    const trend = costData.trend;
    const chart = document.getElementById('trendChart');

    const maxVal = Math.max(...trend.map(t => t.total)) * 1.1;
    const minVal = Math.min(...trend.map(t => Math.min(t.materials, t.labor, t.overhead))) * 0.9;
    const range = maxVal - minVal;

    // Generate line paths
    const lines = ['total', 'materials', 'labor', 'overhead'];
    const colors = {
        total: 'var(--accent-primary)',
        materials: '#6f42c1',
        labor: '#fd7e14',
        overhead: '#20c997'
    };

    let html = '';

    lines.forEach(line => {
        const points = trend.map((t, i) => {
            const x = (i / (trend.length - 1)) * 100;
            const y = ((maxVal - t[line]) / range) * 100;
            return `${x},${y}`;
        }).join(' ');

        html += `
            <div class="trend-line ${line}">
                <svg viewBox="0 0 100 100" preserveAspectRatio="none">
                    <polyline points="${points}" fill="none"/>
                </svg>
            </div>
        `;
    });

    chart.innerHTML = html;

    // Y-axis
    const yAxis = document.getElementById('trendYAxis');
    yAxis.innerHTML = '';
    for (let i = 0; i <= 4; i++) {
        const val = maxVal - (i / 4) * range;
        yAxis.innerHTML += `<span>${formatCurrency(val)}</span>`;
    }

    // X-axis
    const xAxis = document.getElementById('trendXAxis');
    xAxis.innerHTML = trend.filter((_, i) => i % 3 === 0).map(t => `<span>${t.month}</span>`).join('');
}

// ============================================
// BOM Tree
// ============================================
function renderBOMTree() {
    const tree = document.getElementById('bomTree');
    tree.innerHTML = renderBOMItem(costData.bom, 0);
}

let bomIdCounter = 0;
function renderBOMItem(item, level) {
    const hasChildren = item.children && item.children.length > 0;
    // Deterministic ID based on counter
    const id = 'bom-' + (bomIdCounter++).toString(36).padStart(6, '0');

    return `
        <div class="bom-item" style="margin-left: ${level * 1}rem;">
            <div class="bom-item-header" onclick="toggleBOM('${id}')">
                <span class="bom-item-name">
                    <span class="bom-expand">${hasChildren ? '‚ñ∂' : '‚Ä¢'}</span>
                    ${item.name}
                    ${item.qty ? `<span class="bom-item-qty">(${item.qty})</span>` : ''}
                </span>
                <span class="bom-item-cost">${formatCurrency(item.cost)}</span>
            </div>
            ${hasChildren ? `
                <div class="bom-children" id="${id}">
                    ${item.children.map(child => renderBOMItem(child, level + 1)).join('')}
                </div>
            ` : ''}
        </div>
    `;
}

function toggleBOM(id) {
    const el = document.getElementById(id);
    if (el) {
        el.classList.toggle('expanded');
        const header = el.previousElementSibling;
        const expand = header.querySelector('.bom-expand');
        expand.textContent = el.classList.contains('expanded') ? '‚ñº' : '‚ñ∂';
    }
}

// ============================================
// Actions
// ============================================
function exportReport(format) {
    alert(`Export to ${format.toUpperCase()} - In production, this would generate a ${format} report`);
}

function refreshData() {
    loadCostData();
}

function openCostEntry() {
    alert('Cost Entry - In production, this would open a cost entry form');
}
</script>
{% endblock %}
