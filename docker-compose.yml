# LEGO MCP Fusion 360 - Docker Compose Configuration
#
# This orchestrates the slicer service, dashboard, and optionally the MCP server.
# Fusion 360 runs on the host machine (not in Docker).
#
# Usage:
#   docker-compose up -d                    # Start slicer only
#   docker-compose --profile full up -d     # Start slicer + dashboard
#   docker-compose logs -f                  # View logs
#   docker-compose down                     # Stop services
#
# Before first run:
#   ./scripts/setup-paths.sh                # Setup export path symlinks

version: '3.8'

services:
  # ============================================
  # Slicer Service (3D Print G-code)
  # ============================================
  slicer:
    build:
      context: ./slicer-service
      dockerfile: Dockerfile
    container_name: lego-slicer
    ports:
      - "${SLICER_PORT:-8766}:8766"
    volumes:
      # Shared output directory
      - ./output:/output
      # STL files from Fusion 360 (via symlink from ~/Documents/LegoMCP/exports)
      - ./output/stl:/input/stl:ro
      # Custom printer profiles
      - ./slicer-service/profiles:/app/profiles:ro
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8766/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - lego-network

  # ============================================
  # Dashboard (Web UI) - Optional Profile
  # ============================================
  dashboard:
    profiles: ["full"]
    build:
      context: .
      dockerfile: dashboard/Dockerfile
    container_name: lego-dashboard
    ports:
      - "${DASHBOARD_PORT:-5000}:5000"
    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      # Connect to Fusion 360 on host machine (port 8767)
      - FUSION_API_URL=http://host.docker.internal:8767
      # Connect to slicer container
      - SLICER_API_URL=http://slicer:8766
      - PYTHONUNBUFFERED=1
    volumes:
      - ./output:/output
    depends_on:
      slicer:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - lego-network

  # ============================================
  # MCP Server (Optional - can also run on host)
  # ============================================
  # Uncomment this section if you want to run the MCP server in Docker.
  # Note: You'll need to configure Claude Desktop to connect to it.
  #
  # mcp-server:
  #   profiles: ["full"]
  #   build:
  #     context: ./mcp-server
  #     dockerfile: Dockerfile
  #   container_name: lego-mcp-server
  #   volumes:
  #     - ./output:/output
  #   environment:
  #     # Connect to Fusion 360 on host machine (port 8767)
  #     - FUSION_API_URL=http://host.docker.internal:8767
  #     # Connect to slicer container
  #     - SLICER_API_URL=http://slicer:8766
  #   extra_hosts:
  #     - "host.docker.internal:host-gateway"
  #   depends_on:
  #     - slicer
  #   restart: unless-stopped
  #   networks:
  #     - lego-network

networks:
  lego-network:
    driver: bridge
