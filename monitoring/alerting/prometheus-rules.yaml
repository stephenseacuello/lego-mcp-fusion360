# LEGO MCP v8.0 Prometheus Alerting Rules
# DoD/ONR-Class Manufacturing System
#
# Alert Categories:
# - Critical: Immediate action required (pages on-call)
# - Warning: Investigation needed (notification)
# - Info: Informational (logged)

groups:
  # =============================================================================
  # System Health Alerts
  # =============================================================================
  - name: system_health
    interval: 30s
    rules:
      - alert: ServiceDown
        expr: up{job=~"lego-mcp.*"} == 0
        for: 1m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "{{ $labels.job }} has been down for more than 1 minute."
          runbook_url: "https://docs.lego-mcp.io/runbooks/service-down"

      - alert: HighErrorRate
        expr: |
          sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
          / sum(rate(http_requests_total[5m])) by (service) > 0.05
        for: 5m
        labels:
          severity: critical
          category: reliability
        annotations:
          summary: "High error rate for {{ $labels.service }}"
          description: "Error rate is {{ $value | humanizePercentage }} for {{ $labels.service }}"

      - alert: HighLatency
        expr: |
          histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)) > 1
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High latency for {{ $labels.service }}"
          description: "95th percentile latency is {{ $value }}s for {{ $labels.service }}"

      - alert: MemoryPressure
        expr: |
          (container_memory_usage_bytes / container_spec_memory_limit_bytes) > 0.85
        for: 5m
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "Memory pressure on {{ $labels.container }}"
          description: "Container {{ $labels.container }} is using {{ $value | humanizePercentage }} of memory"

      - alert: CPUThrottling
        expr: |
          rate(container_cpu_cfs_throttled_seconds_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "CPU throttling on {{ $labels.container }}"
          description: "Container {{ $labels.container }} is being throttled"

  # =============================================================================
  # Manufacturing Alerts
  # =============================================================================
  - name: manufacturing
    interval: 30s
    rules:
      - alert: OEEBelowTarget
        expr: lego_mcp_oee_percent < 85
        for: 15m
        labels:
          severity: warning
          category: production
        annotations:
          summary: "OEE below target"
          description: "Overall Equipment Effectiveness is {{ $value }}%, below 85% target"

      - alert: QualityDefectSpike
        expr: |
          increase(lego_mcp_defects_total[1h]) > 10
        for: 5m
        labels:
          severity: warning
          category: quality
        annotations:
          summary: "Quality defect spike detected"
          description: "{{ $value }} defects in the last hour"

      - alert: EquipmentFailure
        expr: lego_mcp_equipment_status{status="failed"} == 1
        for: 0m
        labels:
          severity: critical
          category: equipment
        annotations:
          summary: "Equipment failure: {{ $labels.equipment_id }}"
          description: "Equipment {{ $labels.equipment_id }} has failed"

      - alert: ThroughputDrop
        expr: |
          (lego_mcp_throughput_parts_per_hour - lego_mcp_throughput_parts_per_hour offset 1h)
          / lego_mcp_throughput_parts_per_hour offset 1h < -0.2
        for: 15m
        labels:
          severity: warning
          category: production
        annotations:
          summary: "Throughput drop detected"
          description: "Throughput dropped by {{ $value | humanizePercentage }} in the last hour"

      - alert: CycleTimeIncrease
        expr: |
          lego_mcp_cycle_time_seconds > lego_mcp_cycle_time_target_seconds * 1.1
        for: 10m
        labels:
          severity: info
          category: production
        annotations:
          summary: "Cycle time above target"
          description: "Cycle time is {{ $value }}s, target is {{ $labels.target }}s"

  # =============================================================================
  # Security Alerts
  # =============================================================================
  - name: security
    interval: 15s
    rules:
      - alert: SecurityAnomalyDetected
        expr: lego_mcp_security_anomaly_score > 0.8
        for: 0m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Security anomaly detected"
          description: "Anomaly score {{ $value }} for {{ $labels.user }} on {{ $labels.resource }}"

      - alert: FailedAuthenticationSpike
        expr: |
          increase(lego_mcp_auth_failures_total[5m]) > 10
        for: 0m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Authentication failure spike"
          description: "{{ $value }} failed authentications in 5 minutes"

      - alert: UnauthorizedAccessAttempt
        expr: lego_mcp_unauthorized_access_attempts_total > 0
        for: 0m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Unauthorized access attempt"
          description: "Unauthorized access to {{ $labels.resource }} by {{ $labels.user }}"

      - alert: CertificateExpiringSoon
        expr: |
          (lego_mcp_certificate_expiry_timestamp - time()) / 86400 < 30
        for: 1h
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Certificate expiring soon"
          description: "Certificate {{ $labels.cert_name }} expires in {{ $value }} days"

      - alert: HSMUnavailable
        expr: lego_mcp_hsm_available == 0
        for: 1m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "HSM unavailable"
          description: "Hardware Security Module is not responding"

  # =============================================================================
  # AI/ML Alerts
  # =============================================================================
  - name: ai_ml
    interval: 60s
    rules:
      - alert: ModelPredictionDrift
        expr: |
          lego_mcp_model_prediction_drift > 0.1
        for: 15m
        labels:
          severity: warning
          category: ai
        annotations:
          summary: "Model prediction drift detected"
          description: "Model {{ $labels.model }} has drift score {{ $value }}"

      - alert: LowPredictionConfidence
        expr: |
          lego_mcp_prediction_confidence < 0.7
        for: 10m
        labels:
          severity: info
          category: ai
        annotations:
          summary: "Low prediction confidence"
          description: "Model {{ $labels.model }} confidence is {{ $value }}"

      - alert: PINNResidualHigh
        expr: |
          lego_mcp_pinn_physics_residual > 0.01
        for: 5m
        labels:
          severity: warning
          category: ai
        annotations:
          summary: "PINN physics residual high"
          description: "Digital twin physics residual is {{ $value }}"

  # =============================================================================
  # Compliance Alerts
  # =============================================================================
  - name: compliance
    interval: 300s
    rules:
      - alert: AuditChainIntegrityFailure
        expr: lego_mcp_audit_chain_valid == 0
        for: 0m
        labels:
          severity: critical
          category: compliance
        annotations:
          summary: "Audit chain integrity failure"
          description: "Audit chain verification failed - potential tampering"

      - alert: CMMCPracticeNotMet
        expr: lego_mcp_cmmc_practice_met == 0
        for: 1h
        labels:
          severity: warning
          category: compliance
        annotations:
          summary: "CMMC practice not met"
          description: "Practice {{ $labels.practice_id }} is not fully implemented"

      - alert: SBOMOutdated
        expr: |
          (time() - lego_mcp_sbom_generated_timestamp) / 86400 > 7
        for: 1h
        labels:
          severity: info
          category: compliance
        annotations:
          summary: "SBOM outdated"
          description: "Software Bill of Materials is more than 7 days old"

  # =============================================================================
  # ROS2 / Equipment Alerts
  # =============================================================================
  - name: ros2_equipment
    interval: 15s
    rules:
      - alert: ROS2NodeDead
        expr: lego_mcp_ros2_node_alive == 0
        for: 30s
        labels:
          severity: critical
          category: equipment
        annotations:
          summary: "ROS2 node dead: {{ $labels.node }}"
          description: "ROS2 node {{ $labels.node }} is not responding"

      - alert: SafetySystemTriggered
        expr: lego_mcp_safety_estop_active == 1
        for: 0m
        labels:
          severity: critical
          category: safety
        annotations:
          summary: "Safety E-Stop activated"
          description: "Emergency stop has been activated"

      - alert: EquipmentTemperatureHigh
        expr: |
          lego_mcp_equipment_temperature_celsius > lego_mcp_equipment_temperature_limit_celsius * 0.9
        for: 2m
        labels:
          severity: warning
          category: equipment
        annotations:
          summary: "Equipment temperature high"
          description: "{{ $labels.equipment_id }} temperature is {{ $value }}C"

      - alert: MotorOverload
        expr: |
          lego_mcp_motor_current_amps > lego_mcp_motor_rated_current_amps * 1.1
        for: 30s
        labels:
          severity: warning
          category: equipment
        annotations:
          summary: "Motor overload: {{ $labels.motor_id }}"
          description: "Motor {{ $labels.motor_id }} drawing {{ $value }}A"

  # =============================================================================
  # Database Alerts
  # =============================================================================
  - name: database
    interval: 60s
    rules:
      - alert: DatabaseConnectionsHigh
        expr: |
          pg_stat_activity_count > pg_settings_max_connections * 0.8
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Database connections high"
          description: "Using {{ $value }} of {{ $labels.max }} connections"

      - alert: DatabaseReplicationLag
        expr: |
          pg_replication_lag > 30
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Database replication lag"
          description: "Replication lag is {{ $value }}s"

      - alert: DatabaseDiskSpace
        expr: |
          (pg_database_size_bytes / pg_tablespace_size_bytes) > 0.8
        for: 15m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Database disk space high"
          description: "Database using {{ $value | humanizePercentage }} of tablespace"
